<!DOCTYPE html>
<html lang="en">
<head>
    <script src="loading.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Admin Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- 1. Base Styling & Variables --- */
        :root {
            --bg-dark: #0f1115;
            --card-dark: #1a1d23;
            --border-dark: #2b2f3a;
            --primary-color: #7c3aed; /* Default Primary (Purple) */
            --secondary-color: #ea580c; /* Default Secondary (Orange) */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Mobile first: Column */
            margin: 0;
            overflow-x: hidden;
        }

        /* Desktop: Flex Row */
        @media (min-width: 1024px) {
            body {
                flex-direction: row;
            }
        }

        /* Utility for consistent card styling */
        .card-base {
            background-color: var(--card-dark);
            border: 1px solid var(--border-dark);
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar Styling */
        .sidebar {
            width: 280px;
            flex-shrink: 0;
            padding: 1.5rem;
            height: 100vh; /* Full viewport height */
            position: fixed; /* Fixed on mobile */
            top: 0;
            left: 0;
            background-color: var(--bg-dark);
            z-index: 50;
            transform: translateX(-100%); /* Hidden by default on mobile */
            transition: transform 0.3s ease;
            border-right: 1px solid var(--border-dark);
            overflow-y: auto;
        }

        /* Desktop Sidebar State */
        @media (min-width: 1024px) {
            .sidebar {
                position: sticky;
                left: 0;
                transform: none; /* Always visible on desktop */
                height: 100vh;
                /* Keep a subtle right border on desktop so layout edges remain clear */
                border-right: 1px solid var(--border-dark);
                box-shadow: none;
            }
        }

        /* Mobile Sidebar Open State */
        .sidebar.open {
            transform: translateX(0);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.5);
        }

        /* Sidebar Backdrop for Mobile */
        .sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 40;
            display: none;
        }
        .sidebar-backdrop.show {
            display: block;
        }

        /* Nav Item Active State */
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--primary-color);
            border: 1px solid var(--border-dark);
        }
        
        /* Button Primary */
        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.3s ease, opacity 0.3s ease;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }

        /* Input Styling */
        input[type="text"], input[type="number"], input[type="color"], input[type="date"], textarea, select {
            background-color: var(--card-dark);
            border: 1px solid var(--border-dark);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            color: white;
            transition: border-color 0.3s;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 60; /* Higher than sidebar */
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        
        /* Modal Card */
        .modal-card {
            background-color: var(--card-dark);
            border-radius: 1.5rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh; /* Prevent overflow on small screens */
            overflow-y: auto; /* Internal scrolling */
            padding: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-backdrop.open .modal-card {
            transform: scale(1);
            opacity: 1;
        }

        /* Status Colors */
        .low-stock { color: var(--secondary-color); font-weight: 600; }
        .in-stock { color: #10b981; }

        /* --- Analytics Specific Styles (Vanilla CSS Charts) --- */
        .bar-chart-container {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 8px; /* Reduced gap for mobile */
            padding-top: 20px;
        }
        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
        }
        .bar {
            width: 100%;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            min-height: 4px;
        }
        .bar-label {
            margin-top: 8px;
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%; 
        }
        .progress-bar-bg {
            background-color: rgba(255,255,255,0.1);
            border-radius: 999px;
            height: 8px;
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 999px;
        }

        /* Loader */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
       /* --- Offer Creator Specific Styles --- */
.no-scrollbar::-webkit-scrollbar {
    display: none;
}
.no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

/* Offer Type Cards */
.offer-type-card {
    min-width: 100px;
    height: 90px;
    flex-shrink: 0;
    transition: all 0.2s ease;
    border: 1px solid rgba(255,255,255,0.1);
}
.offer-type-card:hover {
    background-color: rgba(255,255,255,0.05);
    transform: translateY(-2px);
}
.offer-type-card.active {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
}

/* Product Search Dropdown */
.search-results-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: #1a1d23;
    border: 1px solid #2b2f3a;
    border-radius: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
    z-index: 50;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    display: none;
}
.search-result-item {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: background-color 0.2s;
}
.search-result-item:hover {
    background-color: var(--primary-color);
    color: white;
}

/* Product Chips */
.prod-chip {
    background-color: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.1);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <!-- Shared global loading is provided by loading.js (no local overlay here) -->

    <div class="lg:hidden fixed top-0 left-0 right-0 p-4 card-base z-40 flex justify-between items-center h-16 rounded-none border-x-0 border-t-0 bg-[#0f1115]">
        <div class="flex items-center space-x-3">
            <button id="back-button" onclick="history.back()" class="text-white text-2xl px-2 focus:outline-none lg:hidden" aria-label="Back">‚Üê</button>
            <h1 class="text-lg font-bold text-white">Ecommerce</h1>
        </div>
        <button id="sidebar-toggle" class="text-white text-2xl px-2 focus:outline-none">‚ò∞</button>
    </div>

    <div id="sidebar-backdrop" class="sidebar-backdrop lg:hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="sidebar">
        <div class="h-16 flex items-center mb-8 px-2 lg:px-0">
            <h2 class="text-2xl font-bold text-white">Ecommerce</h2>
        </div>

        <nav class="space-y-3">
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-xl transition-colors active" data-section="analytics">
                <span class="text-lg">üìà</span>
                <span class="font-medium">Analytics</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-xl transition-colors hover:bg-white/5" data-section="products">
                <span class="text-lg">üì¶</span>
                <span class="font-medium">Products</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-xl transition-colors hover:bg-white/5" data-section="offers">
                <span class="text-lg">üè∑Ô∏è</span>
                <span class="font-medium">Offers</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-xl transition-colors hover:bg-white/5" data-section="inventory">
                <span class="text-lg">üìä</span>
                <span class="font-medium">Inventory</span>
            </a>
        </nav>

        <div class="pt-8 mt-8 border-t border-t-white/10">
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-xl transition-colors hover:bg-white/5" data-section="settings">
                <span class="text-lg">üõ†Ô∏è</span>
                <span class="font-medium">Settings</span>
            </a>
        </div>
    </aside>

    <main id="main-content-area" class="flex-1 p-4 lg:p-8 mt-16 lg:mt-0 w-full max-w-[100vw] overflow-hidden">
        
        <section id="analytics" class="content-section">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-2">
                <h1 class="text-2xl md:text-3xl font-bold">Analytics Dashboard</h1>
                <div class="flex flex-col items-end space-y-2">
                    <button id="ecom-back-btn" onclick="history.back()" class="hidden lg:inline-flex text-sm text-white/80 bg-white/3 hover:bg-white/5 py-1 px-3 rounded-lg" aria-label="Back">‚Üê Back</button>
                    <div class="text-sm text-white/50" id="analytics-timestamp">Loading data...</div>
                </div>
            </div>

            <div class="mb-10">
                <h2 class="text-xl font-semibold mb-4 text-white/90">Product Performance</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
                    <div class="card-base p-5">
                        <p class="text-white/60 text-xs uppercase tracking-wider">Total Views</p>
                        <p class="text-3xl font-bold mt-1 text-white" id="stat-views">-</p>
                        <div class="text-green-400 text-xs mt-2">All time</div>
                    </div>
                    <div class="card-base p-5">
                        <p class="text-white/60 text-xs uppercase tracking-wider">Product Clicks</p>
                        <p class="text-3xl font-bold mt-1 text-white" id="stat-clicks">-</p>
                        <div class="text-green-400 text-xs mt-2">Interest</div>
                    </div>
                    <div class="card-base p-5">
                        <p class="text-white/60 text-xs uppercase tracking-wider">WhatsApp Taps</p>
                        <p class="text-3xl font-bold mt-1 text-white" id="stat-wa">-</p>
                        <div class="text-green-400 text-xs mt-2">Direct Leads</div>
                    </div>
                    <div class="card-base p-5">
                        <p class="text-white/60 text-xs uppercase tracking-wider">Conversion Rate</p>
                        <p class="text-3xl font-bold mt-1 text-white" id="stat-conv">-</p>
                        <div class="text-white/50 text-xs mt-2">Clicks to WA</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card-base p-6">
                        <h3 class="font-medium mb-4 text-white/80">Top Performing Products</h3>
                        <ul class="space-y-4" id="top-products-list">
                            <li class="text-sm text-white/50">Loading...</li>
                        </ul>
                    </div>
                    <div class="card-base p-6">
                        <h3 class="font-medium mb-4 text-white/80">Needs Attention (Low Views)</h3>
                        <ul class="space-y-4" id="low-products-list">
                            <li class="text-sm text-white/50">Loading...</li>
                        </ul>
                    </div>
                </div>

                <div class="card-base overflow-x-auto">
                    <table class="min-w-full divide-y divide-white/10">
                        <thead class="bg-white/5">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Product Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Views</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Clicks</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">WA Leads</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Engagement</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/10 text-sm" id="analytics-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                <div class="card-base p-6 lg:col-span-2">
                    <h2 class="text-xl font-semibold mb-4 text-white/90">Offer Intelligence</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                            <div class="text-xs text-white/50 mb-1">Top Metric</div>
                            <div class="font-bold text-lg text-primary">Conversion</div>
                            <div class="text-sm text-white/70 mt-2">High WA tap rate on discounted items.</div>
                        </div>
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                            <div class="text-xs text-white/50 mb-1">Observation</div>
                            <div class="font-bold text-lg text-green-400">Stock Velocity</div>
                            <div class="text-sm text-white/70 mt-2">Low stock items getting 2x clicks.</div>
                        </div>
                    </div>
                    
                    <h3 class="text-sm font-medium text-white/70 mb-2">Traffic Distribution</h3>
                    <div class="bar-chart-container h-32 bg-white/5 rounded-xl px-4 border border-white/5">
                        <div class="bar-group">
                            <div class="bar bg-blue-500" style="height: 60%;"></div>
                            <div class="bar-label">WhatsApp</div>
                        </div>
                        <div class="bar-group">
                            <div class="bar bg-purple-500" style="height: 30%;"></div>
                            <div class="bar-label">Direct</div>
                        </div>
                        <div class="bar-group">
                            <div class="bar bg-orange-500" style="height: 10%;"></div>
                            <div class="bar-label">Share</div>
                        </div>
                    </div>
                </div>
                
                <div class="card-base p-6 bg-gradient-to-br from-[#1a1d23] to-[#252830]">
                    <h2 class="text-xl font-semibold mb-4 text-white/90">üí° Insight</h2>
                    <div class="space-y-4">
                        <div class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                            <p class="text-sm text-white/80"><span class="font-bold text-blue-400">Tip:</span> Ensure your high-view products have offers attached to convert traffic.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="products" class="content-section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h1 class="text-2xl md:text-3xl font-bold">Products</h1>
                <button onclick="openProductModal()" class="btn-primary text-white font-medium py-2 px-4 rounded-xl flex items-center space-x-2 w-full md:w-auto justify-center">
                    <span class="text-lg">+</span>
                    <span>Create New Product</span>
                </button>
            </div>
            
            <div class="card-base p-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-white/10" id="products-table">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Visibility</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-list" class="divide-y divide-white/10">
                    </tbody>
                </table>

                <!-- Empty state banner (hidden by default). Shown when there are no products. -->
                <div id="empty-products-banner" class="hidden w-full p-8 flex flex-col items-center justify-center text-center">
                    <div class="text-lg font-semibold text-white mb-4">Create Your First Product Here!</div>
                    <button onclick="openProductModal()" class="btn-primary text-white font-medium py-2 px-4 rounded-xl">
                        <span class="text-lg">+</span>
                        <span class="ml-2">Create New Product</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="offers" class="content-section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h1 class="text-2xl md:text-3xl font-bold">Offers & Promotions</h1>
                <button onclick="openOfferModal()" class="btn-primary text-white font-medium py-2 px-4 rounded-xl flex items-center space-x-2 w-full md:w-auto justify-center">
                    <span class="text-lg">üéâ</span>
                    <span>Create New Offer</span>
                </button>
            </div>
            
            <div class="card-base p-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-white/10" id="offers-table">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Offer Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Discount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="offers-list" class="divide-y divide-white/10">
                    </tbody>
                </table>

                <!-- Empty state banner (hidden by default). Shown when there are no offers. -->
                <div id="empty-offers-banner" class="hidden w-full p-8 flex flex-col items-center justify-center text-center">
                    <div class="text-lg font-semibold text-white mb-4">Create Your First Offer Here!</div>
                    <button onclick="openOfferModal()" class="btn-primary text-white font-medium py-2 px-4 rounded-xl">
                        <span class="text-lg">üéâ</span>
                        <span class="ml-2">Create New Offer</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="inventory" class="content-section hidden">
            <h1 class="text-2xl md:text-3xl font-bold mb-6">Inventory Management</h1>
            
            <div class="card-base p-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-white/10">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-white/60 uppercase tracking-wider whitespace-nowrap">Update</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list" class="divide-y divide-white/10">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="settings" class="content-section hidden">
            <h1 class="text-2xl md:text-3xl font-bold mb-6">Business Settings</h1>
            
            <div class="card-base p-4 md:p-6 space-y-6 w-full max-w-2xl">
                <h2 class="text-xl font-semibold border-b border-white/10 pb-3">General Information</h2>
                
                <div class="flex flex-col md:flex-row items-center md:space-x-4 space-y-4 md:space-y-0">
                    <div class="w-20 h-20 rounded-full bg-white/10 flex items-center justify-center overflow-hidden border border-white/20 shrink-0 relative">
                         <span class="text-2xl" id="logo-placeholder">üì∑</span>
                         <img id="logo-preview" class="w-full h-full object-cover hidden">
                         <div id="logo-loading" class="absolute inset-0 bg-black/50 hidden flex items-center justify-center">
                            <div class="loader"></div>
                         </div>
                    </div>
                    <div class="w-full">
                        <label class="block text-sm font-medium text-white/70 mb-1">Business Logo</label>
                        <input type="file" id="setting-logo-upload" accept="image/*" class="w-full text-sm text-white/70 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-violet-600">
                    </div>
                </div>

                <div>
                    <label for="setting-business-name" class="block text-sm font-medium text-white/70 mb-1">Business Name</label>
                    <input type="text" id="setting-business-name" class="w-full" placeholder="Your Business">
                </div>
                <div>
                    <label for="setting-whatsapp-number" class="block text-sm font-medium text-white/70 mb-1">WhatsApp Number (e.g., 2547XXXXXXXX)</label>
                    <input type="text" id="setting-whatsapp-number" class="w-full" placeholder="2547...">
                </div>

                <h2 class="text-xl font-semibold border-b border-white/10 pb-3 pt-4">Brand Colors <span class="text-sm text-white/50 font-normal">(Product page only)</span></h2>

                <p class="text-sm text-white/60 mt-2 mb-4">These colors apply only to the product storefront: primary accent affects <strong>prices and buttons</strong>, secondary affects <strong>offers</strong>, and background applies to the product page container.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="setting-primary-color" class="block text-sm font-medium text-white/70 mb-1">Primary Color (Accent ‚Äî prices and buttons)</label>
                        <div class="flex space-x-2">
                            <input type="color" id="setting-primary-color" class="w-12 h-10 p-0.5 rounded-lg border-none shrink-0" oninput="updateBrandColor('--primary-color', this.value)" value="#7c3aed">
                            <input type="text" id="setting-primary-color-hex" class="flex-1 w-full" value="#7c3aed" oninput="updateBrandColor('--primary-color', this.value)">
                        </div>
                    </div>
                    <div>
                        <label for="setting-secondary-color" class="block text-sm font-medium text-white/70 mb-1">Secondary Color (Offers)</label>
                        <div class="flex space-x-2">
                            <input type="color" id="setting-secondary-color" class="w-12 h-10 p-0.5 rounded-lg border-none shrink-0" oninput="updateBrandColor('--secondary-color', this.value)" value="#ea580c">
                            <input type="text" id="setting-secondary-color-hex" class="flex-1 w-full" value="#ea580c" oninput="updateBrandColor('--secondary-color', this.value)">
                        </div>
                    </div>
                    <div>
                        <label for="setting-bg-color" class="block text-sm font-medium text-white/70 mb-1">Background Color (Product page only)</label>
                        <div class="flex space-x-2">
                            <input type="color" id="setting-bg-color" class="w-12 h-10 p-0.5 rounded-lg border-none shrink-0" oninput="updateBrandColor('--bg-dark', this.value)" value="#0f1115">
                            <input type="text" id="setting-bg-color-hex" class="flex-1 w-full" value="#0f1115" oninput="updateBrandColor('--bg-dark', this.value)">
                        </div>
                    </div>
                </div>

                <button onclick="saveBusinessSettings()" id="save-settings-btn" class="btn-primary text-white font-medium py-2 px-4 rounded-xl w-full">Save Settings</button>
            </div>
        </section>

    </main>

    <div id="product-modal-backdrop" class="modal-backdrop">
        <div class="modal-card" id="product-modal">
            <h2 class="text-xl md:text-2xl font-bold mb-4">Create New Product</h2>
            <div id="product-modal-steps" class="space-y-4">
                <div data-step="1" class="product-step">
                    <h3 class="font-semibold text-lg text-white/80 mb-3">Step 1: Images</h3>
                    <p class="text-sm text-white/50 mb-4">Select images. They will upload automatically.</p>
                    <input type="file" multiple accept="image/*" id="product-images-upload" class="w-full text-white/70 p-2 border border-dashed border-white/20 rounded-lg">
                    <div id="image-preview" class="flex space-x-3 mt-4 overflow-x-auto pb-2 min-h-[80px]"></div>
                </div>

                <div data-step="2" class="product-step hidden">
                    <h3 class="font-semibold text-lg text-white/80 mb-3">Step 2: Basics</h3>
                    <input type="text" id="prod-title" placeholder="Product Name" class="w-full mb-3">
                    <textarea id="prod-short-desc" rows="3" placeholder="Short description (bullets separated by commas)" class="w-full mb-3"></textarea>
                    <textarea id="prod-long-desc" rows="5" placeholder="Long description (full details)" class="w-full mb-3"></textarea>
                </div>

                <div data-step="3" class="product-step hidden">
                    <h3 class="font-semibold text-lg text-white/80 mb-3">Step 3: Pricing</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="prod-price" placeholder="Price (KES)" class="w-full mb-3">
                        <input type="number" id="prod-old-price" placeholder="Offer Price (optional)" class="w-full">
                    </div>
                </div>

                <div data-step="4" class="product-step hidden">
                    <h3 class="font-semibold text-lg text-white/80 mb-3">Step 4: Inventory & Publish</h3>
                    <input type="number" id="prod-stock" placeholder="Initial Stock Quantity" class="w-full mb-4">
                    <label class="flex items-center space-x-2 text-white/70">
                        <input type="checkbox" id="prod-visible" checked>
                        <span>Publish Product Immediately</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-between items-center mt-6 pt-4 border-t border-white/10">
                <button onclick="changeProductStep(-1)" class="text-white/70 hover:text-white transition-colors py-2 px-4 rounded-lg" id="product-prev-btn">‚Üê Previous</button>
                <button onclick="changeProductStep(1)" class="btn-primary text-white font-medium py-2 px-4 rounded-xl" id="product-next-btn">Next ‚Üí</button>
                <button onclick="saveProduct()" class="btn-primary text-white font-medium py-2 px-4 rounded-xl hidden" id="product-publish-btn">Publish Product</button>
            </div>
        </div>
    </div>

    <div id="variation-manage-backdrop" class="modal-backdrop">
        <div class="modal-card" id="variation-manage-modal">
            <h2 class="text-xl md:text-2xl font-bold mb-4">Manage Variations</h2>
            <p class="text-sm text-white/60 mb-4" id="variation-product-title">For Product: ...</p>
            
            <div id="current-variations-list" class="space-y-4 mb-6"></div>

            <div class="border-t border-white/10 pt-4">
                <h3 class="font-semibold text-lg mb-2">Add New Variation Group</h3>
                <input type="text" id="new-var-group-name" placeholder="Group Name (e.g. Size, Color)" class="w-full mb-2">
                <input type="text" id="new-var-group-options" placeholder="Options (comma separated, e.g. S,M,L)" class="w-full mb-2">
                <button onclick="addVariationToProduct()" class="btn-primary text-white font-medium py-2 px-4 rounded-xl w-full">Add Group</button>
            </div>
        </div>
    </div>

    <div id="offer-modal-backdrop" class="modal-backdrop">
    <div class="modal-card max-w-3xl" id="offer-modal">
        <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-4">
            <div>
                <h2 class="text-xl md:text-2xl font-bold">‚ú® Create Promotion</h2>
                <p class="text-xs text-white/50 mt-1">Design offers that convert visitors into customers.</p>
            </div>
            <button onclick="toggleModal('offer-modal', false)" class="text-white/50 hover:text-white text-xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10">‚úï</button>
        </div>

        <div class="mb-2">
            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2" id="offer-type-container">
                </div>
        </div>
        
        <div id="offer-explainer" class="bg-blue-500/10 border border-blue-500/20 text-blue-200 text-xs px-4 py-2 rounded-lg mb-6 flex items-center gap-2">
            <i class="fa-solid fa-circle-info"></i>
            <span id="offer-explainer-text">Select an offer type to begin.</span>
        </div>

        <div class="mb-6 bg-black/20 p-4 rounded-xl border border-white/5 relative">
            <label class="block text-xs font-bold text-white/50 uppercase tracking-wider mb-2">Target Products</label>
            
            <div id="selected-products-container" class="flex flex-wrap gap-2 mb-2"></div>
            
            <div class="relative">
                <input type="text" id="product-search-input" placeholder="Search products..." class="w-full pl-10 bg-[#0f1115] border border-white/20 rounded-lg focus:border-[var(--primary-color)] transition-colors">
                <i class="fa-solid fa-search absolute left-3 top-3 text-white/30"></i>
                
                <div id="product-search-results" class="search-results-dropdown"></div>
            </div>

            <div class="mt-3 flex items-center gap-2">
                <input type="checkbox" id="storewide-toggle" class="w-4 h-4 rounded border-white/30 bg-transparent text-[var(--primary-color)] focus:ring-0">
                <label for="storewide-toggle" class="text-sm text-white/70 select-none">Apply Storewide (All Products)</label>
            </div>
        </div>

        <div id="offer-config-section" class="bg-[#1a1d23] border border-white/10 rounded-xl p-5 mb-6 shadow-inner">
            </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-xs text-white/50 uppercase font-bold mb-1">Offer Name</label>
                <input type="text" id="offer-name" placeholder="e.g., Weekend Flash Sale" class="w-full bg-[#0f1115]">
            </div>
            <div>
                <label class="block text-xs text-white/50 uppercase font-bold mb-1">End Date (Required for Flash Sale)</label>
                <input type="date" id="offer-end-date" class="w-full bg-[#0f1115]">
            </div>
        </div>

        <button onclick="createOffer()" class="btn-primary w-full py-3.5 rounded-xl font-bold text-white shadow-lg hover:shadow-[var(--primary-color)]/25 transition-all text-lg flex items-center justify-center gap-2">
            <span>üöÄ Launch Promotion</span>
        </button>
    </div>
</div>
    <script src="auth.js"></script>

    <script>
        // --- 1. CONFIGURATION & SUPABASE SETUP ---
        const SUPABASE_URL = 'https://xgtnbxdxbbywvzrttixf.supabase.co'; // Replace
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ'; // Replace
        // Business id comes from logged-in user (auth.js). If null, some actions will be disabled.
        const BUSINESS_ID = (window.authUtils && window.authUtils.getBusinessId) ? window.authUtils.getBusinessId() : null;

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Helper: Convert storage path to public URL (no-op for absolute URLs)
        function getPublicImageUrl(path) {
            console.debug('[getPublicImageUrl] input:', path);
            if (!path) return path;
            // If it's already a full URL or data URL, return as-is (avoid re-encoding which can double-encode)
            if (path.startsWith('http') || path.startsWith('data:')) {
                return path;
            }

            try {
                const { data } = supabase.storage.from('ecommerce-assets').getPublicUrl(path);
                console.debug('[getPublicImageUrl] storage path -> publicUrl:', path, '=>', data?.publicUrl);
                return data?.publicUrl || path;
            } catch (e) {
                console.error('[getPublicImageUrl] storage getPublicUrl error for', path, e);
                return path;
            }
        }

        // --- Image Helpers: LQIP / Preload / Lazy Upgrade ---
        // Inline fallback placeholders (data URIs) to avoid external network lookups
        const DATA_PLACEHOLDER_50 = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><rect width="100%" height="100%" fill="%23222"/></svg>';
        const DATA_PLACEHOLDER_100 = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100%" height="100%" fill="%23222"/></svg>';
        async function createLowQualityPlaceholder(url, maxDim = 40, quality = 0.45) {
            if (!url) return '';
            // Normalize common double-encoding artifacts and spaces
            try {
                url = String(url).replace(/%25/g, '%').replace(/\s/g, '%20');
            } catch (e) {}

            try {
                // Load via Image() with crossOrigin to allow canvas extraction when CORS permits
                const img = new Image();
                // Try loading the image; if it fails we silently fall back to returning the original URL
                img.crossOrigin = 'anonymous';
                const p = new Promise((resolve) => {
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                });
                img.src = url;
                const ok = await p;
                if (!ok) return url;

                const width = img.naturalWidth || img.width || 1;
                const height = img.naturalHeight || img.height || 1;
                const scale = Math.min(1, maxDim / Math.max(width, height));
                const w = Math.max(1, Math.round(width * scale));
                const h = Math.max(1, Math.round(height * scale));
                const canvas = document.createElement('canvas');
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                return dataUrl;
            } catch (err) {
                // Silent fallback: return the original URL so the browser can attempt to load it.
                return url;
            }
        }

        // Upgrade an image element to its high-res source (decode first)
        async function upgradeImageToHighRes(imgEl) {
            if (!imgEl || !imgEl.dataset || !imgEl.dataset.high) return;
            const high = imgEl.dataset.high;
            try {
                const im = new Image();
                im.src = high;
                // Attempt to decode; if it fails, just set src
                if (im.decode) await im.decode();
                imgEl.src = high;
            } catch (e) {
                imgEl.src = high;
            }
        }

        // Preload image but do not block longer than timeoutMs
        function preloadImage(url, timeoutMs = 600) {
            return new Promise((resolve) => {
                if (!url) return resolve();
                const img = new Image();
                let done = false;
                const finish = () => { if (!done) { done = true; resolve(); } };
                img.onload = finish;
                img.onerror = finish;
                img.src = url;
                setTimeout(finish, timeoutMs);
            });
        }
        
        // --- 2. GLOBAL STATE ---
        let productsCache = [];
        let currentProductStep = 1;
        let uploadedImageUrls = [];
        let currentEditingProductId = null; // For variations

        // --- 3. INIT & NAVIGATION ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Ensure user is logged in (shared auth utilities)
            if (window.authUtils && window.authUtils.checkLoginAndRedirect) window.authUtils.checkLoginAndRedirect();
            // Use the shared loader from loading.js for consistency across pages
            try { if (window.showGlobalLoading) window.showGlobalLoading(); } catch (e) {}
            await loadSettings(); // Apply theme first
            // Keep loader visible briefly so it reads as a load (approx 500ms)
            await new Promise(r => setTimeout(r, 500));
            try { if (window.vvAppReady) window.vvAppReady(); else if (window.hideGlobalLoading) window.hideGlobalLoading(); } catch (e) {}
            // Respect hash or query to open a specific section (e.g., ecommerce.html#products or ?section=products)
            const hash = window.location.hash;
            const qs = new URLSearchParams(window.location.search);
            if (hash === '#products' || qs.get('section') === 'products') showSection('products');
            else showSection('analytics');
            
            // Listeners
            document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(item.getAttribute('data-section'));
                    if (window.innerWidth < 1024) toggleSidebar();
                });
            });
            document.getElementById('setting-logo-upload').addEventListener('change', uploadLogo);
            document.getElementById('product-images-upload').addEventListener('change', uploadProductImages);
            document.querySelectorAll('.modal-backdrop').forEach(b => {
                b.addEventListener('click', (e) => {
                    if (e.target === b) toggleModal(b.id.replace('-backdrop',''), false);
                });
            });
        });

        async function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-section="${sectionId}"]`)?.classList.add('active');

            if (sectionId === 'analytics') renderAnalytics();
            if (sectionId === 'products') renderProducts();
            if (sectionId === 'inventory') renderInventory();
            if (sectionId === 'offers') renderOffers();
            if (sectionId === 'settings') loadSettings();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            sidebar.classList.toggle('open');
            sidebar.classList.toggle('-translate-x-full');
            backdrop.classList.toggle('show');
        }

        function toggleModal(id, open) {
            const backdrop = document.getElementById(id + '-backdrop');
            if (open) {
                backdrop.style.display = 'flex';
                setTimeout(() => backdrop.classList.add('open'), 10);
            } else {
                backdrop.classList.remove('open');
                setTimeout(() => backdrop.style.display = 'none', 300);
            }
        }

        // --- 4. SETTINGS & BRANDING ---
        async function loadSettings() {
            const { data, error } = await supabase.from('business_settings').select('*').eq('business_id', BUSINESS_ID).single();
            
            if (data) {
                // Apply Inputs
                document.getElementById('setting-business-name').value = data.business_name || '';
                document.getElementById('setting-whatsapp-number').value = data.whatsapp_number || '';
                
                // Apply Colors
                const colors = data.brand_colors || {};
                const primary = colors.primary || '#7c3aed';
                const secondary = colors.secondary || '#ea580c';
                const bg = colors.background || '#0f1115';

                updateBrandColor('--primary-color', primary);
                updateBrandColor('--secondary-color', secondary);
                updateBrandColor('--bg-dark', bg);

                // Update pickers
                document.getElementById('setting-primary-color').value = primary;
                document.getElementById('setting-primary-color-hex').value = primary;
                document.getElementById('setting-secondary-color').value = secondary;
                document.getElementById('setting-secondary-color-hex').value = secondary;
                document.getElementById('setting-bg-color').value = bg;
                document.getElementById('setting-bg-color-hex').value = bg;

                // Logo
                if (data.logo_url) {
                    const publicUrl = getPublicImageUrl(data.logo_url);
                    const img = document.getElementById('logo-preview');
                    img.src = publicUrl;
                    img.classList.remove('hidden');
                    document.getElementById('logo-placeholder').classList.add('hidden');
                }
            }
        }

        function updateBrandColor(cssVar, hexValue) {
            // Scope color changes to the products section only so the rest of the app remains unaffected.
            // If #products is not present, fall back to document root.
            try {
                const productsEl = document.getElementById('products');
                if (productsEl) {
                    productsEl.style.setProperty(cssVar, hexValue);
                } else {
                    document.documentElement.style.setProperty(cssVar, hexValue);
                }
            } catch (e) {
                // Fallback to root on any error
                document.documentElement.style.setProperty(cssVar, hexValue);
            }

            // Sync text inputs if triggered by color picker
            const idBase = cssVar.replace('--', 'setting-');
            const hexInput = document.getElementById(idBase + '-hex');
            const colorInput = document.getElementById(idBase);
            if (hexInput && hexInput.value !== hexValue) hexInput.value = hexValue;
            if (colorInput && colorInput.value !== hexValue) colorInput.value = hexValue;
        }

        async function saveBusinessSettings() {
            const btn = document.getElementById('save-settings-btn');
            btn.textContent = 'Saving...';
            
            const payload = {
                business_id: BUSINESS_ID,
                business_name: document.getElementById('setting-business-name').value,
                whatsapp_number: document.getElementById('setting-whatsapp-number').value,
                brand_colors: {
                    primary: document.getElementById('setting-primary-color').value,
                    secondary: document.getElementById('setting-secondary-color').value,
                    background: document.getElementById('setting-bg-color').value
                }
            };

            await supabase.from('business_settings').upsert(payload);
            btn.textContent = 'Settings Saved!';
            setTimeout(() => btn.textContent = 'Save Settings', 2000);
        }

        async function uploadLogo(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('logo-loading').classList.remove('hidden');
            const fileName = `logos/${BUSINESS_ID}-${Date.now()}`;
            const { error } = await supabase.storage.from('ecommerce-assets').upload(fileName, file);
            
            if (!error) {
                const { data } = supabase.storage.from('ecommerce-assets').getPublicUrl(fileName);
                await supabase.from('business_settings').upsert({ business_id: BUSINESS_ID, logo_url: data.publicUrl });
                document.getElementById('logo-preview').src = data.publicUrl;
                document.getElementById('logo-preview').classList.remove('hidden');
                document.getElementById('logo-placeholder').classList.add('hidden');
            } else {
                alert('Upload failed: ' + error.message);
            }
            document.getElementById('logo-loading').classList.add('hidden');
        }

        // --- 5. PRODUCTS ---
        async function fetchProducts() {
            const { data } = await supabase.from('products').select('*').eq('business_id', BUSINESS_ID).order('created_at', { ascending: false });
            productsCache = data || [];
            return productsCache;
        }

        async function renderProducts() {
            const products = await fetchProducts();
            const list = document.getElementById('products-list');

            function isFreeUser() {
                try {
                    const raw = (window.authUtils && window.authUtils.getLoggedInUser) ? window.authUtils.getLoggedInUser() : null;
                    const user = (window.authUtils && window.authUtils.applyDefaultPackageSettings) ? window.authUtils.applyDefaultPackageSettings(raw) : raw;
                    return user && String(user.package || '').toLowerCase() === 'free';
                } catch (e) { return false; }
            }

            const isFree = isFreeUser();

            // Update top "Create" button state based on free-user limit
            try {
                const topCreateBtn = document.querySelector('button[onclick="openProductModal()"]');
                if (topCreateBtn) {
                    if (isFree && products && products.length >= 15) {
                        topCreateBtn.disabled = true;
                        topCreateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        topCreateBtn.title = 'Upgrade to add more products';
                    } else {
                        topCreateBtn.disabled = false;
                        topCreateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        topCreateBtn.title = '';
                    }
                }
            } catch (e) { /* ignore */ }

            // If there are no products, hide the table and show a centered banner (mobile-friendly)
            if (!products || products.length === 0) {
                const tableEl = document.getElementById('products-table');
                const bannerEl = document.getElementById('empty-products-banner');
                if (tableEl) tableEl.style.display = 'none';
                if (bannerEl) bannerEl.style.display = 'flex';
                return;
            } else {
                // Ensure table is visible if products exist
                const tableEl = document.getElementById('products-table');
                const bannerEl = document.getElementById('empty-products-banner');
                if (tableEl) tableEl.style.display = '';
                if (bannerEl) bannerEl.style.display = 'none';
            }

            // Build table rows using DOM so we can apply LQIP placeholders and lazy upgrade
            list.innerHTML = '';

            // Create a shared IntersectionObserver to upgrade images when they become visible
            if (!window.__vv_image_observer) {
                try {
                    window.__vv_image_observer = new IntersectionObserver((entries) => {
                        entries.forEach(ent => {
                            if (ent.isIntersecting) {
                                const img = ent.target;
                                upgradeImageToHighRes(img);
                                try { window.__vv_image_observer.unobserve(img); } catch(e) {}
                            }
                        });
                    }, { rootMargin: '200px' });
                } catch (e) {
                    window.__vv_image_observer = null;
                }
            }

            for (const p of products) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition-colors';

                // Column 1: thumbnail + title
                const td1 = document.createElement('td');
                td1.className = 'px-6 py-4 whitespace-nowrap flex items-center space-x-3';

                const img = document.createElement('img');
                img.className = 'w-10 h-10 rounded object-cover border border-white/10';
                img.loading = 'lazy';
                img.alt = p.title || 'Product image';

                const imgRaw = p.images && p.images.length ? p.images[0] : null;
                const imageUrl = getPublicImageUrl(imgRaw) || DATA_PLACEHOLDER_50;

                // Set a tiny SVG placeholder immediately for layout stability
                img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><rect width="100%" height="100%" fill="%23222"/></svg>';
                img.onerror = () => { img.src = DATA_PLACEHOLDER_50; };

                // Fill LQIP then mark high-res for upgrade
                (async () => {
                    const lq = await createLowQualityPlaceholder(imageUrl, 40, 0.45).catch(() => imageUrl);
                    if (lq) {
                        img.src = lq;
                        img.dataset.high = imageUrl;
                        // Observe for upgrade
                        try { window.__vv_image_observer && window.__vv_image_observer.observe(img); } catch(e) {}
                    } else {
                        img.src = imageUrl;
                    }
                })();

                const titleDiv = document.createElement('div');
                titleDiv.className = 'text-sm font-medium text-white truncate max-w-[150px] md:max-w-none';
                titleDiv.textContent = p.title || '';

                td1.appendChild(img);
                td1.appendChild(titleDiv);

                // Column 2: price
                const td2 = document.createElement('td');
                td2.className = 'px-6 py-4 whitespace-nowrap text-sm text-white/70';
                td2.innerHTML = `KES ${p.price.toLocaleString()} ${p.old_price ? `<span class="text-xs text-red-400 line-through ml-1">${p.old_price.toLocaleString()}</span>` : ''}`;

                // Column 3: visibility toggle
                const td3 = document.createElement('td');
                td3.className = 'px-6 py-4 whitespace-nowrap text-sm';
                td3.innerHTML = `<label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" ${p.is_visible ? 'checked' : ''} class="sr-only peer" onchange="toggleVisibility('${p.id}', this.checked)">
                            <div class="w-11 h-6 bg-white/20 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>`;

                // Column 4: actions
                const td4 = document.createElement('td');
                td4.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                const actionDiv = document.createElement('div');
                actionDiv.style.display = 'flex';
                actionDiv.style.alignItems = 'center';
                actionDiv.style.gap = '10px';
                actionDiv.style.justifyContent = 'flex-end';

                const copyButtonHtml = isFree
                    ? `<button onclick="promptUpgradeToShare()" class="text-white/30 cursor-not-allowed" title="Upgrade to share products">üîó</button>`
                    : `<button onclick="copyProductLink('${p.id}')" class="text-white/50 hover:text-white transition-colors" title="Copy product link">üîó</button>`;

                actionDiv.innerHTML = `${copyButtonHtml}
                            <button onclick="openProductModalForEdit('${p.id}')" class="text-white/70 hover:text-white transition-colors" title="Edit product">‚úèÔ∏è</button>
                            <button onclick="openVariationManager('${p.id}')" class="text-white/70 hover:text-white transition-colors" title="Variations">‚öôÔ∏è</button>
                            <button onclick="deleteProduct('${p.id}')" class="text-red-400 hover:text-red-500 transition-colors" title="Delete">üóëÔ∏è</button>
                            <button onclick="openProductLive('${p.id}')" class="text-white/50 hover:text-white transition-colors" title="View live page">üëÅÔ∏è</button>`;

                td4.appendChild(actionDiv);

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);

                list.appendChild(tr);
            }
        }

        // Product Modal Logic
        function openProductModal() {
            // openProductModal() default: create new product. To edit, pass productId as first arg.
            currentProductStep = 1;
            currentEditingProductId = null;
            uploadedImageUrls = [];
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('product-images-upload').value = '';
            document.getElementById('prod-title').value = '';
            document.getElementById('prod-short-desc').value = '';
            document.getElementById('prod-long-desc').value = '';
            document.getElementById('prod-price').value = '';
            document.getElementById('prod-old-price').value = '';
            document.getElementById('prod-stock').value = '';
            document.getElementById('prod-visible').checked = true;

            const pubBtn = document.getElementById('product-publish-btn');
            pubBtn.textContent = 'Publish Product';
            pubBtn.classList.add('hidden');
            document.getElementById('product-next-btn').classList.remove('hidden');
            changeProductStep(0); 
            toggleModal('product-modal', true);
        }

        // Overloaded: openProductModalForEdit(productId) will open modal prefilled for editing
        async function openProductModalForEdit(productId) {
            if (!productId) return openProductModal();
            const product = productsCache.find(p => p.id === productId);
            if (!product) return alert('Product not found');

            currentEditingProductId = productId;
            currentProductStep = 1;
            uploadedImageUrls = Array.isArray(product.images) ? [...product.images] : [];
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('product-images-upload').value = '';

            document.getElementById('prod-title').value = product.title || '';
            document.getElementById('prod-short-desc').value = product.description_short || '';
            document.getElementById('prod-long-desc').value = product.description_long || '';
            document.getElementById('prod-price').value = product.price || '';
            document.getElementById('prod-old-price').value = product.old_price || '';
            document.getElementById('prod-stock').value = product.stock_quantity || '';
            document.getElementById('prod-visible').checked = !!product.is_visible;

            // Populate previews for existing images
            const preview = document.getElementById('image-preview');
            for (const imgUrlRaw of uploadedImageUrls) {
                const imgUrl = getPublicImageUrl(imgUrlRaw) || imgUrlRaw;
                const img = document.createElement('img');
                img.className = 'w-16 h-16 rounded-lg object-cover border-2 border-white/10 shrink-0';
                img.src = imgUrl;
                img.onerror = () => { img.src = DATA_PLACEHOLDER_100; };
                preview.appendChild(img);
            }

            // Switch buttons: show publish/save immediately
            const pubBtn = document.getElementById('product-publish-btn');
            pubBtn.textContent = 'Save Changes';
            pubBtn.classList.remove('hidden');
            document.getElementById('product-next-btn').classList.add('hidden');
            changeProductStep(0);
            toggleModal('product-modal', true);
        }

        // --- 7. ROBUST OFFERS LOGIC ---
// --- 7. ROBUST OFFERS LOGIC (Updated) ---

        // Config Definitions
        const OFFER_TYPES = [
            { id: 'DISCOUNT', label: 'Discount', icon: 'fa-tag', desc: 'Standard percentage or fixed amount off.' },
            { id: 'FLASH_SALE', label: 'Flash Sale', icon: 'fa-bolt', desc: 'Urgent limited-time discount with a countdown timer.' },
            { id: 'BOGO', label: 'Get Free', icon: 'fa-box-open', desc: 'Customer buys specific items to get others for free.' },
            { id: 'SHIPPING', label: 'Shipping', icon: 'fa-truck-fast', desc: 'Free shipping based on order total or specific items.' },
            { id: 'SEASONAL', label: 'Seasonal', icon: 'fa-gift', desc: 'Special deals for holidays (Christmas, Black Friday).' },
            { id: 'FREEBIE', label: 'Free Gift', icon: 'fa-gifts', desc: 'Give a free item (e.g. accessories) with a purchase.' },
            { id: 'EARLY_BIRD', label: 'Early Bird', icon: 'fa-clock', desc: 'Launch discount for new products.' },
            { id: 'FIRST_TIME', label: 'New Buyer', icon: 'fa-user-tag', desc: 'Special price for first-time customers.' }
        ];

        let currentOfferType = 'DISCOUNT';
        let selectedProductIds = []; // Array of IDs

        function openOfferModal() {
            // Reset State
            selectedProductIds = [];
            currentOfferType = 'DISCOUNT';
            document.getElementById('offer-name').value = '';
            document.getElementById('offer-end-date').value = '';
            document.getElementById('storewide-toggle').checked = false;
            document.getElementById('product-search-input').value = '';
            
            // Render UI Components
            renderOfferTypeButtons();
            renderSelectedProducts();
            updateConfigUI();
            
            toggleModal('offer-modal', true);
        }

        // --- UI RENDERERS ---

        function renderOfferTypeButtons() {
            const container = document.getElementById('offer-type-container');
            container.innerHTML = OFFER_TYPES.map(type => `
                <div onclick="selectOfferType('${type.id}')" 
                     class="offer-type-card ${currentOfferType === type.id ? 'active' : 'bg-white/5'} flex flex-col items-center justify-center rounded-xl cursor-pointer select-none">
                    <i class="fa-solid ${type.icon} text-2xl mb-2 ${currentOfferType === type.id ? 'text-white' : 'text-white/50'}"></i>
                    <span class="text-xs font-semibold whitespace-nowrap">${type.label}</span>
                </div>
            `).join('');
            
            // Update Explainer
            const typeData = OFFER_TYPES.find(t => t.id === currentOfferType);
            document.getElementById('offer-explainer-text').innerText = typeData ? typeData.desc : '';
        }

        function selectOfferType(type) {
            currentOfferType = type;
            renderOfferTypeButtons();
            updateConfigUI();
            // Auto-fill name for seasonal/flash
            const nameInput = document.getElementById('offer-name');
            if (type === 'FLASH_SALE' && !nameInput.value) nameInput.value = "24Hr Flash Sale";
            if (type === 'SEASONAL' && !nameInput.value) nameInput.value = "Christmas Special";
            if (type === 'EARLY_BIRD' && !nameInput.value) nameInput.value = "Launch Special";
        }

        function updateConfigUI() {
            const container = document.getElementById('offer-config-section');
            container.innerHTML = ''; // Clear previous inputs

            if (['DISCOUNT', 'FLASH_SALE', 'EARLY_BIRD', 'FIRST_TIME'].includes(currentOfferType)) {
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-white/50 uppercase font-bold mb-1">Discount Type</label>
                            <select id="conf-disc-mode" class="w-full bg-[#0f1115] p-2 rounded border border-white/20">
                                <option value="percent">Percentage (%)</option>
                                <option value="amount">Fixed Amount (KES)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-white/50 uppercase font-bold mb-1">Value</label>
                            <input type="number" id="conf-disc-val" class="w-full bg-[#0f1115] p-2 rounded border border-white/20" placeholder="e.g. 20">
                        </div>
                    </div>
                `;
            } 
            else if (currentOfferType === 'SEASONAL') {
                container.innerHTML = `
                    <div class="mb-3">
                        <label class="block text-xs text-white/50 uppercase font-bold mb-1">Select Season</label>
                        <select id="conf-season-preset" class="w-full bg-[#0f1115] p-2 rounded border border-white/20" onchange="document.getElementById('offer-name').value = this.value + ' Deal'">
                            <option value="Christmas">üéÑ Christmas</option>
                            <option value="Black Friday">üñ§ Black Friday</option>
                            <option value="Easter">üê∞ Easter</option>
                            <option value="New Year">üéÜ New Year</option>
                            <option value="Back to School">üéí Back to School</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-white/50 uppercase font-bold mb-1">Discount %</label>
                            <input type="number" id="conf-disc-val" class="w-full bg-[#0f1115] p-2 rounded border border-white/20" placeholder="20">
                            <input type="hidden" id="conf-disc-mode" value="percent">
                        </div>
                    </div>
                `;
            }
            else if (currentOfferType === 'BOGO') {
                // Get Free Logic: Buy X (Target Products) Get Y (Reward Product)
                const productOptions = productsCache.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
                container.innerHTML = `
                    <div class="flex items-center gap-4 mb-4">
                        <div class="flex-1">
                            <label class="block text-xs text-white/50 uppercase font-bold mb-1">Buy Quantity</label>
                            <input type="number" id="conf-buy-qty" value="1" class="w-full bg-[#0f1115] p-2 rounded border border-white/20">
                        </div>
                        <div class="pt-5 font-bold text-white/30">‚ûú</div>
                        <div class="flex-1">
                            <label class="block text-xs text-white/50 uppercase font-bold mb-1">Get Free Qty</label>
                            <input type="number" id="conf-get-qty" value="1" class="w-full bg-[#0f1115] p-2 rounded border border-white/20">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-white/50 uppercase font-bold mb-1">Reward Product (What they get free)</label>
                        <select id="conf-reward-id" class="w-full bg-[#0f1115] p-2 rounded border border-white/20">
                            <option value="same">Same as purchased product</option>
                            ${productOptions}
                        </select>
                    </div>
                `;
            } 
            else if (currentOfferType === 'FREEBIE') {
                 const productOptions = productsCache.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
                 container.innerHTML = `
                    <div>
                        <label class="block text-xs text-white/50 uppercase font-bold mb-1">Select Free Gift Item</label>
                        <select id="conf-gift-id" class="w-full bg-[#0f1115] p-2 rounded border border-white/20">
                            ${productOptions}
                        </select>
                        <p class="text-[10px] text-white/40 mt-1">This item will appear as a "Free Gift" badge.</p>
                    </div>
                `;
            }
            else if (currentOfferType === 'SHIPPING') {
                container.innerHTML = `
                    <div>
                        <label class="block text-xs text-white/50 uppercase font-bold mb-1">Free Shipping Threshold (KES)</label>
                        <input type="number" id="conf-ship-threshold" class="w-full bg-[#0f1115] p-2 rounded border border-white/20" placeholder="e.g. 3000 (Leave 0 for always free)">
                        <p class="text-[10px] text-white/40 mt-1">Order must be above this amount to qualify.</p>
                    </div>
                `;
            }
        }

        // --- PRODUCT SEARCH & SELECTION ---

        // Setup Search Listener
        document.getElementById('product-search-input').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const dropdown = document.getElementById('product-search-results');
            
            if (term.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            const matches = productsCache.filter(p => p.title.toLowerCase().includes(term) && !selectedProductIds.includes(p.id));
            
            if (matches.length > 0) {
                dropdown.innerHTML = matches.map(p => `
                    <div class="search-result-item" onclick="selectProduct('${p.id}')">
                        <div class="font-medium text-sm">${p.title}</div>
                        <div class="text-xs text-white/50">KES ${p.price}</div>
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        });

        // Hide dropdown on click outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('product-search-results');
            const input = document.getElementById('product-search-input');
            if (e.target !== dropdown && e.target !== input) {
                dropdown.style.display = 'none';
            }
        });

        function selectProduct(id) {
            if (!selectedProductIds.includes(id)) {
                selectedProductIds.push(id);
                renderSelectedProducts();
                document.getElementById('product-search-input').value = '';
                document.getElementById('product-search-results').style.display = 'none';
                document.getElementById('storewide-toggle').checked = false; // Uncheck storewide if specific product selected
            }
        }

        function removeProduct(id) {
            selectedProductIds = selectedProductIds.filter(pid => pid !== id);
            renderSelectedProducts();
        }

        function renderSelectedProducts() {
            const container = document.getElementById('selected-products-container');
            const isStorewide = document.getElementById('storewide-toggle').checked;
            
            if (isStorewide) {
                container.innerHTML = `<span class="prod-chip text-[var(--primary-color)] border-[var(--primary-color)]">ALL PRODUCTS SELECTED</span>`;
                return;
            }

            if (selectedProductIds.length === 0) {
                container.innerHTML = '<span class="text-xs text-white/30 italic">No products selected yet...</span>';
                return;
            }

            container.innerHTML = selectedProductIds.map(id => {
                const p = productsCache.find(prod => prod.id === id);
                return `
                <div class="prod-chip">
                    <span>${p ? p.title : 'Unknown'}</span>
                    <button onclick="removeProduct('${id}')" class="hover:text-red-400 ml-1">√ó</button>
                </div>`;
            }).join('');
        }
        
        document.getElementById('storewide-toggle').addEventListener('change', function(e) {
            if(e.target.checked) {
                selectedProductIds = []; // Clear specific selections
                renderSelectedProducts();
            }
        });

        // --- SUBMIT LOGIC ---

        async function createOffer() {
            const name = document.getElementById('offer-name').value;
            const endDate = document.getElementById('offer-end-date').value;
            const isStorewide = document.getElementById('storewide-toggle').checked;

            // 1. Validation
            if (!name) return alert("Please name your offer.");
            if (currentOfferType === 'FLASH_SALE' && !endDate) return alert("Flash Sales require an End Date.");
            
            let targetIds = [];
            if (isStorewide) {
                // Get all product IDs
                if(productsCache.length === 0) await fetchProducts();
                targetIds = productsCache.map(p => p.id);
            } else {
                targetIds = [...selectedProductIds];
            }

            if (targetIds.length === 0) return alert("Please select at least one product (or check Apply Storewide).");

            // 2. Build Config Object
            let config = {};
            let priority = 2; // Default priority
            let discountType = null;
            let discountValue = 0;

            if (['DISCOUNT', 'FLASH_SALE', 'SEASONAL', 'EARLY_BIRD', 'FIRST_TIME'].includes(currentOfferType)) {
                const mode = document.getElementById('conf-disc-mode').value;
                const val = parseFloat(document.getElementById('conf-disc-val').value);
                if (!val) return alert("Enter discount value.");
                config = mode === 'percent' ? { percent: val } : { amount: val };
                
                // Legacy support
                discountType = mode;
                discountValue = val;
                if(currentOfferType === 'FLASH_SALE') priority = 1; // Highest priority
            }
            else if (currentOfferType === 'BOGO') {
                config = {
                    buy_qty: parseInt(document.getElementById('conf-buy-qty').value),
                    get_qty: parseInt(document.getElementById('conf-get-qty').value),
                    reward_product_id: document.getElementById('conf-reward-id').value // 'same' or UUID
                };
            }
            else if (currentOfferType === 'FREEBIE') {
                config = { gift_product_id: document.getElementById('conf-gift-id').value };
            }
            else if (currentOfferType === 'SHIPPING') {
                const threshold = document.getElementById('conf-ship-threshold').value;
                config = { threshold: threshold ? parseFloat(threshold) : 0 };
            }

            // 3. Create Payload(s) - Loop through products
            // Note: Since the DB expects one row per product (based on current schema), we loop.
            const payloads = targetIds.map(prodId => ({
                business_id: BUSINESS_ID,
                product_id: prodId,
                name: name,
                offer_type: currentOfferType,
                configuration: config,
                priority: priority,
                is_active: true,
                start_date: new Date().toISOString(),
                end_date: endDate ? new Date(endDate).toISOString() : null,
                discount_type: discountType || 'price', // fallback
                discount_value: discountValue || 0
            }));

            // 4. Batch Insert
            const btn = document.querySelector('#offer-modal .btn-primary');
            const originalText = btn.innerHTML;
            btn.innerText = "Creating...";
            btn.disabled = true;

            const { error } = await supabase.from('offers').insert(payloads);

            if (error) {
                console.error(error);
                alert("Error creating offer: " + error.message);
            } else {
                toggleModal('offer-modal', false);
                renderOffers();
                // Optionally show toast success
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function changeProductStep(direction) {
            currentProductStep += direction;
            const steps = document.querySelectorAll('.product-step');

            if (currentProductStep < 1) currentProductStep = 1;
            if (currentProductStep > steps.length) currentProductStep = steps.length;

            steps.forEach((step, index) => {
                step.classList.toggle('hidden', index + 1 !== currentProductStep);
            });

            document.getElementById('product-prev-btn').style.visibility = currentProductStep > 1 ? 'visible' : 'hidden';
            
            if (currentProductStep === steps.length) {
                document.getElementById('product-next-btn').classList.add('hidden');
                document.getElementById('product-publish-btn').classList.remove('hidden');
            } else {
                document.getElementById('product-next-btn').classList.remove('hidden');
                document.getElementById('product-publish-btn').classList.add('hidden');
            }
        }

        async function uploadProductImages(e) {
            const files = Array.from(e.target.files || []);
            const preview = document.getElementById('image-preview');

            for (const file of files) {
                // Enforce 5MB limit
                const maxBytes = 5 * 1024 * 1024;
                if (file.size > maxBytes) {
                    alert(`File "${file.name}" is larger than 5MB and will be skipped.`);
                    continue;
                }

                // Create preview element immediately
                const imgEl = document.createElement('img');
                imgEl.className = 'w-16 h-16 rounded-lg object-cover border-2 border-white/10 shrink-0 opacity-50';
                preview.appendChild(imgEl);

                // Show local preview (dataURL)
                try {
                    const reader = new FileReader();
                    reader.onload = (ev) => { imgEl.src = ev.target.result; };
                    reader.readAsDataURL(file);
                } catch (err) {
                    console.warn('preview read failed', err);
                }

                // Upload
                try {
                    const fileName = `products/${BUSINESS_ID}-${Date.now()}-${file.name}`;
                    const { error } = await supabase.storage.from('ecommerce-assets').upload(fileName, file);
                    if (!error) {
                        const { data } = supabase.storage.from('ecommerce-assets').getPublicUrl(fileName);
                        const publicUrl = data.publicUrl;
                        uploadedImageUrls.push(publicUrl);
                        imgEl.classList.remove('opacity-50');
                        imgEl.src = publicUrl; // replace dataURL with uploaded URL
                    } else {
                        console.warn('upload error', error);
                        imgEl.classList.add('opacity-50');
                    }
                } catch (err) {
                    console.error('uploadProductImages error', err);
                }
            }
        }

        async function saveProduct() {
            const title = document.getElementById('prod-title').value;
            if (!title) return alert('Product Name is required');

            const payload = {
                business_id: BUSINESS_ID,
                title: title,
                description_short: document.getElementById('prod-short-desc').value,
                description_long: document.getElementById('prod-long-desc').value,
                price: parseFloat(document.getElementById('prod-price').value) || 0,
                old_price: (document.getElementById('prod-old-price').value !== '') ? parseFloat(document.getElementById('prod-old-price').value) : null,
                stock_quantity: parseInt(document.getElementById('prod-stock').value) || 0,
                is_visible: document.getElementById('prod-visible').checked,
                images: uploadedImageUrls,
                variations: [] // keep existing variations when editing? current UI doesn't edit them here
            };

            try {
                if (currentEditingProductId) {
                    // Update existing product
                    const { error } = await supabase.from('products').update(payload).eq('id', currentEditingProductId);
                    if (error) return alert('Error updating product: ' + error.message);
                } else {
                    // ID Generation for new product
                    const cleanName = title.toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0, 15);
                    const id = `product-${cleanName}-${Math.floor(1000 + Math.random() * 9000)}`;
                    payload.id = id;
                    const { error } = await supabase.from('products').insert(payload);
                    if (error) return alert('Error saving product: ' + error.message);
                }

                toggleModal('product-modal', false);
                // reset editing state
                currentEditingProductId = null;
                renderProducts();
            } catch (err) {
                console.error('saveProduct error', err);
                alert('Error saving product');
            }
        }

        // Construct full product URL based on current location and copy to clipboard
        function copyProductLink(productId) {
            if (!productId) return;
            const basePath = location.origin + location.pathname.substring(0, location.pathname.lastIndexOf('/') + 1);
            const url = basePath + 'product.html?id=' + encodeURIComponent(productId);

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Product link copied to clipboard');
                }).catch(() => {
                    // Fallback
                    const ta = document.createElement('textarea');
                    ta.value = url;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); alert('Product link copied to clipboard'); } catch (e) { prompt('Copy this link:', url); }
                    ta.remove();
                });
            } else {
                const ta = document.createElement('textarea');
                ta.value = url;
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); alert('Product link copied to clipboard'); } catch (e) { prompt('Copy this link:', url); }
                ta.remove();
            }
        }

        // Prompt free users to upgrade when they try to access sharing features
        function promptUpgradeToShare() {
            try {
                if (window.openUpgradeFlow) return window.openUpgradeFlow();
            } catch (e) {}
            const want = confirm('Sharing products is a paid feature. Would you like to view upgrade plans?');
            if (want) {
                // Prefer opening in-app plans if available
                if (window.openPlans) return window.openPlans();
                // Fallback to navigate to plans page
                window.location.href = 'plans.html';
            }
        }

        // Open the product live page in a new tab/window
        async function openProductLive(productId) {
            if (!productId) return;
            const basePath = location.origin + location.pathname.substring(0, location.pathname.lastIndexOf('/') + 1);
            let url = basePath + 'product.html?id=' + encodeURIComponent(productId);
            try {
                const user = (window.authUtils && window.authUtils.getLoggedInUser) ? window.authUtils.getLoggedInUser() : null;
                const ident = user ? encodeURIComponent(user.id || user.email || '') : '';
                if (ident) url += '&from_app=1&app_user=' + ident;
            } catch (e) { /* ignore */ }
            // If this is being opened from within the app (ecommerce page), navigate in the same tab
            try {
                const path = window.location.pathname || '';
                const isApp = path.includes('ecommerce.html') || path.toLowerCase().includes('/ecommerce');
                // Try to preload the main product image to warm the cache and improve product page load.
                try {
                    const product = productsCache.find(p => p.id === productId);
                    const mainImgUrl = product ? getPublicImageUrl(product.images?.[0]) : null;
                    if (isApp) {
                        // For in-app navigation we await a short preload (bounded) before navigating to reduce perceived load time
                        await preloadImage(mainImgUrl, 700);
                        window.location.href = url;
                        return;
                    } else {
                        // For external/new-tab open, start preload in background but don't block; gives browser a headstart
                        preloadImage(mainImgUrl, 400).catch(() => {});
                        // Continue to open in new tab below
                    }
                } catch (e) {
                    // If preload fails, fall back to normal navigation behavior
                    if (isApp) { window.location.href = url; return; }
                }
            } catch (e) {}

            // Otherwise open in a new tab (external viewers)
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        async function toggleVisibility(id, checked) {
            await supabase.from('products').update({ is_visible: checked }).eq('id', id);
        }

        async function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                await supabase.from('products').delete().eq('id', id);
                renderProducts();
            }
        }

        // --- 6. VARIATIONS ---
        function openVariationManager(productId) {
            currentEditingProductId = productId;
            const product = productsCache.find(p => p.id === productId);
            document.getElementById('variation-product-title').textContent = `For: ${product.title}`;
            renderVariations(product.variations || []);
            toggleModal('variation-manage', true);
        }

        function renderVariations(vars) {
            const container = document.getElementById('current-variations-list');
            if (!vars || vars.length === 0) {
                container.innerHTML = '<p class="text-sm text-white/40 italic">No variations added.</p>';
                return;
            }

            container.innerHTML = vars.map((v, i) => `
                <div class="bg-white/5 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <div class="font-bold text-sm text-white">${v.name}</div>
                        <div class="text-xs text-white/60">${(v.options || []).join(', ')}</div>
                    </div>
                    <button onclick="removeVariationFromProduct(${i})" class="text-red-400 hover:text-red-500 text-sm">Remove</button>
                </div>
            `).join('');
        }

        async function removeVariationFromProduct(index) {
            const product = productsCache.find(p => p.id === currentEditingProductId);
            if (!product) return;
            const newVars = [...(product.variations || [])];
            newVars.splice(index, 1);

            await supabase.from('products').update({ variations: newVars }).eq('id', currentEditingProductId);
            product.variations = newVars;
            renderVariations(newVars);
        }

        // --- 7. OFFERS ---
        async function renderOffers() {
            // Need products for names
            if (productsCache.length === 0) await fetchProducts();
            
            const { data: offers } = await supabase.from('offers').select('*').eq('business_id', BUSINESS_ID);
            
            // Populate select dropdown in modal
            const select = document.getElementById('offer-product-select');
            select.innerHTML = '<option value="">-- Select a Product --</option>' + 
                productsCache.map(p => `<option value="${p.id}">${p.title}</option>`).join('');

            const list = document.getElementById('offers-list');
            const safeOffers = offers || [];
            if (safeOffers.length === 0) {
                // Hide table and show the centered empty banner for offers
                const tableEl = document.getElementById('offers-table');
                const bannerEl = document.getElementById('empty-offers-banner');
                if (tableEl) tableEl.style.display = 'none';
                if (bannerEl) bannerEl.style.display = 'flex';
            } else {
                // Ensure table visible when offers exist
                const tableEl = document.getElementById('offers-table');
                const bannerEl = document.getElementById('empty-offers-banner');
                if (tableEl) tableEl.style.display = '';
                if (bannerEl) bannerEl.style.display = 'none';
                list.innerHTML = safeOffers.map(o => {
                const prodName = productsCache.find(p => p.id === o.product_id)?.title || 'Unknown Product';
                const discDisplay = o.discount_type === 'percent' ? `${o.discount_value}% OFF` : `KES ${o.discount_value} FIX`;
                return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${o.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white/70">${prodName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-400">${discDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${o.is_active ? 'bg-green-100/10 text-green-400' : 'bg-red-100/10 text-red-400'}">
                            ${o.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-white/70 hover:text-white" onclick="alert('Delete not implemented yet')">üóëÔ∏è</button>
                    </td>
                </tr>`;
                }).join('');
            }
        }

        async function createOffer() {
            const payload = {
                business_id: BUSINESS_ID,
                product_id: document.getElementById('offer-product-select').value,
                name: document.getElementById('offer-name').value,
                discount_type: document.getElementById('offer-discount-type').value,
                discount_value: parseFloat(document.getElementById('offer-discount-value').value),
                is_active: true
            };
            const { error } = await supabase.from('offers').insert(payload);
            if (!error) {
                toggleModal('offer-modal', false);
                renderOffers();
            }
        }

        // --- 8. INVENTORY ---
        async function renderInventory() {
            const products = await fetchProducts();
            const list = document.getElementById('inventory-list');
            
            if (!products || products.length === 0) {
                list.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-12 text-center">
                        <div class="text-lg font-semibold text-white">You will Manage the Inventory of Your Products Here.</div>
                    </td>
                </tr>
                `;
                return;
            }

            list.innerHTML = products.map(p => {
                const statusClass = p.stock_quantity > 5 ? 'text-green-400' : (p.stock_quantity > 0 ? 'text-orange-400' : 'text-red-500');
                const statusText = p.stock_quantity > 5 ? 'In Stock' : (p.stock_quantity > 0 ? 'Low Stock' : 'Out of Stock');
                
                return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${p.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" id="stock-${p.id}" value="${p.stock_quantity}" class="w-20 text-center text-sm bg-card-dark border border-white/20 rounded">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass} font-medium">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="updateStock('${p.id}')" class="text-white/70 hover:text-white transition-colors py-1 px-3 rounded-lg bg-white/5 border border-white/10">üíæ Save</button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function updateStock(id) {
            const val = document.getElementById(`stock-${id}`).value;
            await supabase.from('products').update({ stock_quantity: val }).eq('id', id);
            renderInventory(); // Refresh labels
        }

        // --- 9. ANALYTICS ---
        async function renderAnalytics() {
            // Fetch Products for names
            if (productsCache.length === 0) await fetchProducts();

            // Fetch Analytics Data
            const { data } = await supabase.from('product_analytics_daily')
                .select('*')
                .eq('business_id', BUSINESS_ID);
            
            if (!data) return;

            // Aggregation
            let totalViews = 0;
            let totalClicks = 0;
            let totalWA = 0;
            const productStats = {};

            data.forEach(row => {
                totalViews += row.views_count || 0;
                totalClicks += row.clicks_count || 0;
                totalWA += row.whatsapp_taps || 0;
                
                if (!productStats[row.product_id]) {
                    productStats[row.product_id] = { v: 0, c: 0, w: 0 };
                }
                productStats[row.product_id].v += row.views_count || 0;
                productStats[row.product_id].c += row.clicks_count || 0;
                productStats[row.product_id].w += row.whatsapp_taps || 0;
            });

            // Update KPI Cards
            document.getElementById('stat-views').innerText = totalViews.toLocaleString();
            document.getElementById('stat-clicks').innerText = totalClicks.toLocaleString();
            document.getElementById('stat-wa').innerText = totalWA.toLocaleString();
            const conversion = totalClicks > 0 ? ((totalWA / totalClicks) * 100).toFixed(1) : 0;
            document.getElementById('stat-conv').innerText = `${conversion}%`;
            document.getElementById('analytics-timestamp').innerText = `Last updated: ${new Date().toLocaleTimeString()}`;

            // Sort Products
            const sortedProdIds = Object.keys(productStats).sort((a, b) => productStats[b].v - productStats[a].v);

            // Update Top Performing List
            const topList = document.getElementById('top-products-list');
            topList.innerHTML = sortedProdIds.slice(0, 3).map((pid, idx) => {
                const prod = productsCache.find(p => p.id === pid);
                return `
                <li class="flex items-center justify-between text-sm md:text-base">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded bg-white/10 flex items-center justify-center text-xs shrink-0">${idx + 1}</div>
                        <span class="truncate max-w-[150px] md:max-w-none">${prod ? prod.title : 'Unknown'}</span>
                    </div>
                    <span class="text-green-400 font-medium">${productStats[pid].v} Views</span>
                </li>`;
            }).join('') || '<li class="text-white/50">No data available</li>';

            // Update Low Performing List
            const lowList = document.getElementById('low-products-list');
            lowList.innerHTML = sortedProdIds.slice(-3).reverse().map((pid, idx) => {
                const prod = productsCache.find(p => p.id === pid);
                return `
                <li class="flex items-center justify-between opacity-70 text-sm md:text-base">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-xs shrink-0">!</div>
                        <span class="truncate max-w-[150px] md:max-w-none">${prod ? prod.title : 'Unknown'}</span>
                    </div>
                    <span class="text-red-400 font-medium">${productStats[pid].v} Views</span>
                </li>`;
            }).join('') || '<li class="text-white/50">No data available</li>';

            // Update Main Table
            const tableBody = document.getElementById('analytics-table-body');
            tableBody.innerHTML = sortedProdIds.map(pid => {
                const prod = productsCache.find(p => p.id === pid);
                const stats = productStats[pid];
                const eng = stats.v > 0 ? ((stats.c / stats.v) * 100).toFixed(1) : 0;
                
                return `
                <tr>
                    <td class="px-6 py-4 font-medium whitespace-nowrap">${prod ? prod.title : pid}</td>
                    <td class="px-6 py-4 text-white/70 whitespace-nowrap">${stats.v}</td>
                    <td class="px-6 py-4 text-white/70 whitespace-nowrap">${stats.c}</td>
                    <td class="px-6 py-4 text-green-400 font-medium whitespace-nowrap">${stats.w}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs w-8">${eng}%</span>
                            <div class="progress-bar-bg w-24"><div class="progress-bar-fill bg-blue-500" style="width: ${Math.min(eng, 100)}%"></div></div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
    </script>
</body>
</html>