<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Team</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f1115; color: white; }
        .card-animate { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* Loader */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-[#1a1d23] p-8 rounded-2xl border border-[#2b2f3a] max-w-md w-full text-center card-animate shadow-2xl">
        
        <div class="flex justify-center mb-6">
            <div class="w-24 h-24 rounded-full bg-[#0f1115] border-2 border-[#2b2f3a] flex items-center justify-center overflow-hidden shadow-lg relative">
                <i id="default-logo-icon" class="fa-solid fa-building text-3xl text-white/20 absolute"></i>
                <img id="business-logo" src="assets/logo.png" alt="Logo" class="w-full h-full object-cover opacity-0 transition-opacity duration-300">
            </div>
        </div>

        <h1 class="text-2xl font-bold mb-2">You've been invited!</h1>
        <p class="text-white/60 mb-8">Join the team at <span id="business-name-display" class="text-white font-bold tracking-wide">...</span></p>

        <form id="join-form" class="space-y-5 text-left">
            <div>
                <label class="text-xs font-semibold text-white/50 uppercase tracking-wider mb-1.5 block">Full Name</label>
                <div class="relative">
                    <i class="fa-solid fa-user absolute left-4 top-4 text-white/30"></i>
                    <input type="text" id="join-name" placeholder="John Doe" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl py-3.5 pl-10 pr-4 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all">
                </div>
            </div>
            
            <div>
                <label class="text-xs font-semibold text-white/50 uppercase tracking-wider mb-1.5 block">Phone Number</label>
                <div class="relative">
                    <i class="fa-solid fa-phone absolute left-4 top-4 text-white/30"></i>
                    <input type="tel" id="join-phone" placeholder="07xxxxxxxx" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl py-3.5 pl-10 pr-4 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all">
                </div>
                <p class="text-xs text-white/40 mt-1.5 ml-1">Use the number you received the invite on.</p>
            </div>

            <div>
                <label class="text-xs font-semibold text-white/50 uppercase tracking-wider mb-1.5 block">Role</label>
                <div class="relative">
                    <i class="fa-solid fa-briefcase absolute left-4 top-4 text-white/30"></i>
                    <select id="join-role" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl py-3.5 pl-10 pr-4 text-white appearance-none focus:outline-none focus:border-blue-500">
                        <option value="manager">Manager</option>
                        <option value="sales_rep">Sales Representative</option>
                        <option value="marketer">Marketer</option>
                        <option value="admin_assistant">Admin Assistant</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-white/30 pointer-events-none"></i>
                </div>
            </div>

            <div id="error-message" class="bg-red-500/10 border border-red-500/20 text-red-400 p-3 rounded-lg text-sm hidden text-center"></div>

            <button type="submit" id="join-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 px-4 rounded-xl transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 mt-4">
                <span>Accept Invite</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </form>
    </div>

    <script>
        // --- Configuration ---
        const SUPABASE_URL = 'https://xgtnbxdxbbywvzrttixf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Get URL Params ---
        const params = new URLSearchParams(window.location.search);
        // Supports ?bid=fortunebook12 or ?id=fortunebook12
        const businessId = params.get('bid') || params.get('id'); 
        const invitedPhone = params.get('phone');

        // --- DOM Elements ---
        const logoImg = document.getElementById('business-logo');
        const defaultIcon = document.getElementById('default-logo-icon');
        const nameDisplay = document.getElementById('business-name-display');
        const nameInput = document.getElementById('join-name');
        const phoneInput = document.getElementById('join-phone');
        const joinBtn = document.getElementById('join-btn');
        const errEl = document.getElementById('error-message');

        if(invitedPhone) phoneInput.value = invitedPhone;

        // 1. Fetch Business Branding
        async function loadBranding() {
            if(!businessId) {
                document.body.innerHTML = '<div class="flex items-center justify-center h-screen text-white/50">Invalid Invite Link</div>';
                return;
            }

            try {
                // Try fetching from business_settings first
                const { data: settings } = await client
                    .from('business_settings')
                    .select('business_name, logo_url')
                    .eq('business_id', businessId)
                    .maybeSingle();

                let bName = 'this Business';
                let bLogo = null;

                if (settings) {
                    if (settings.business_name) bName = settings.business_name;
                    if (settings.logo_url) bLogo = settings.logo_url;
                } else {
                    // Fallback: check logins table for the admin name associated with this ID
                    const { data: admin } = await client
                        .from('logins')
                        .select('business_name')
                        .eq('business id', businessId)
                        .limit(1)
                        .maybeSingle();
                    if (admin && admin.business_name) bName = admin.business_name;
                }

                // Update UI
                nameDisplay.textContent = bName;
                
                if (bLogo) {
                    logoImg.src = bLogo;
                    logoImg.onload = () => {
                        logoImg.classList.remove('opacity-0');
                        defaultIcon.style.display = 'none';
                    };
                    logoImg.onerror = () => { /* keep default icon if broken url */ };
                } else {
                    // Try to use the default logo from assets
                    logoImg.src = 'assets/logo.png';
                    logoImg.classList.remove('opacity-0');
                    defaultIcon.style.display = 'none';
                }

            } catch (e) {
                console.warn('Error loading branding', e);
            }
        }
        loadBranding();

        // 2. Handle Join Logic
        document.getElementById('join-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            errEl.classList.add('hidden');
            
            const name = nameInput.value.trim();
            const rawPhone = phoneInput.value.trim();
            const role = document.getElementById('join-role').value;

            if (!name || !rawPhone) return showError('Please fill in all fields');

            // Set loading state
            joinBtn.disabled = true;
            joinBtn.innerHTML = '<div class="loader"></div>';

            // Normalize Phone
            function normalizePhone(p) {
                p = p.replace(/\s+/g, '').replace(/\D/g, ''); // Remove non-digits
                if (p.startsWith('07') && p.length === 10) return '254' + p.substring(1);
                if (p.startsWith('01') && p.length === 10) return '254' + p.substring(1);
                if (p.startsWith('254')) return p;
                return p;
            }
            const normalizedPhone = normalizePhone(rawPhone);

            try {
                // A. Check if user exists anywhere
                const { data: existing } = await client
                    .from('logins')
                    .select('id')
                    .eq('phone_number', normalizedPhone)
                    .maybeSingle();

                if (existing) {
                    throw new Error('This phone number is already registered.');
                }

                // B. Get Package Info to inherit
                const { data: adminData } = await client
                    .from('logins')
                    .select('package, package_expiry_date, business_name')
                    .eq('business id', businessId)
                    .limit(1)
                    .single();

                if (!adminData) throw new Error('Business ID not found.');

                // C. Create User
                const newUser = {
                    phone_number: normalizedPhone,
                    admin_name: name,
                    'business id': businessId,
                    business_name: adminData.business_name || nameDisplay.textContent,
                    package: adminData.package,
                    package_expiry_date: adminData.package_expiry_date,
                    role: role,
                    joined_date: new Date().toISOString()
                };

                const { error: insertErr } = await client.from('logins').insert([newUser]);
                if (insertErr) throw insertErr;

                // Update Invite Status in tracking table (optional)
                await client.from('team_invites')
                    .update({ status: 'accepted' })
                    .match({ business_id: businessId, invitee_phone: rawPhone });

                // Success
                joinBtn.innerHTML = '<i class="fa-solid fa-check"></i> Success!';
                joinBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                joinBtn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    alert('Account created! You can now log in.');
                    window.location.href = 'index.html';
                }, 1000);

            } catch (err) {
                console.error(err);
                showError(err.message || 'Error joining. Please try again.');
                joinBtn.disabled = false;
                joinBtn.innerHTML = '<span>Accept Invite</span><i class="fa-solid fa-arrow-right"></i>';
            }
        });

        function showError(msg) {
            errEl.textContent = msg;
            errEl.classList.remove('hidden');
        }
    </script>
</body>
</html>