<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Dynamic viewport: keep mobile at 0.8 (user preference) but use 1.0 on desktop to avoid zoomed-in layout -->
    <meta id="dynamic-viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <script>
        (function(){
            try {
                // Preserve the mobile tuning (initial-scale=0.8) while ensuring desktop uses 1.0
                var vp = document.getElementById('dynamic-viewport');
                function updateViewport() {
                    var w = window.innerWidth || document.documentElement.clientWidth || 1024;
                    // Treat < 768 as mobile (matches the app's breakpoints)
                    if (w < 768) {
                        vp.setAttribute('content', 'width=device-width, initial-scale=0.8, minimum-scale=0.8, viewport-fit=cover');
                    } else {
                        // Desktop: use 0.8 as requested
                        vp.setAttribute('content', 'width=device-width, initial-scale=0.8, minimum-scale=0.8, viewport-fit=cover');
                    }
                }
                // Run once early
                updateViewport();
                // Also update if the window is resized (user may toggle dev tools or change device)
                window.addEventListener('resize', function(){ try { updateViewport(); } catch(e){} });
            } catch (e) { console.warn('viewport script error', e); }
        })();
    </script>
    <title>VV Studios Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f1115">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script>
    // If NOT installed → redirect to install screen
    if (
        !window.matchMedia("(display-mode: standalone)").matches &&
        !window.navigator.standalone &&
        !document.referrer.includes("android-app://")
    ) {
        window.location.replace("install.html");
    }
</script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar styling for the dashboard content */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background-color: transparent;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .card-animate {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-animate:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .sidebar-link {
            position: relative;
            transition: all 0.2s ease;
        }
        .sidebar-link:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip {
            position: absolute;
            left: calc(100% + 15px);
            top: 50%;
            transform: translateY(-50%);
            visibility: hidden;
            opacity: 0;
            background-color: #2b2f3a;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap;
            font-size: 0.875rem;
            z-index: 10;
            transition: opacity 0.3s ease;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent #2b2f3a transparent transparent;
        }
        .sidebar-link.active {
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.1);
        }
        .sidebar-link.faint-gold {
            color: #FFD700;
        }
        /* Hide hover tooltips on mobile (no hover) - keep desktop hover behaviour */
        @media (max-width: 1024px) {
            .sidebar-link .tooltip { display: none !important; }
        }

        /* Locked-toast text styles (used by JS-created toasts) */
        .locked-toast { color: #9CA3AF; }
        .locked-toast .pro { color: #FFD700; font-weight: 700; }
        .locked-toast .growth { color: #10B981; font-weight: 700; }
        .progress-bar-container {
            height: 8px;
            background-color: #4b5563;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease, background-color 0.5s ease;
        }
        .progress-green {
            background-color: #10B981;
        }
        .progress-yellow {
            background-color: #FBBF24;
        }
        .progress-red {
            background-color: #EF4444;
        }
        .upgrade-button {
            transition: background-color 0.3s ease;
        }
        .text-green { color: #22c55e; }
        .text-yellow { color: #eab308; }
        .text-red { color: #ef4444; }
        /* Additional styling from index.html */
        .chart-placeholder {
            background: linear-gradient(135deg, #1f2937 0%, #2a3547 100%);
            border: 1px solid #374151;
            padding: 1.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 1.125rem;
            font-style: italic;
            min-height: 250px;
        }

        /* Header controls: place alerts & profile at top-right and reserve space to avoid overlap */
        #top-header { position: relative; }
        #header-controls { position: absolute; right: 1rem; top: 0.75rem; z-index: 50; display: flex; gap: 0.5rem; }

        /* Reserve right padding so the business name doesn't overlap with the controls on small screens */
        @media (max-width: 768px) {
            #top-header { padding-right: 6.5rem; }
            #header-controls { top: 0.5rem; right: 0.75rem; }
            #mobile-menu-button { margin-bottom: 0.25rem; }
        }
        .toggle-switch-container {
            display: flex;
            background-color: #2b2f3a;
            border-radius: 9999px;
            padding: 4px;
        }
        .toggle-button {
            padding: 8px 16px;
            cursor: pointer;
            color: #d1d5db;
            border-radius: 9999px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .toggle-button.active {
            background-color: #1a1d23;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .logout-button {
            background-color: #ef4444;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            transition: background-color 0.3s ease;
        }
        .logout-button:hover {
            background-color: #dc2626;
        }
        
    </style>
    <script>
        // Prevent login flash: if user is already logged in (vvUser in localStorage),
        // hide the login container and show the dashboard container before the DOM paints.
        (function(){
            try {
                var isLogged = false;
                if (typeof localStorage !== 'undefined') {
                    var v = localStorage.getItem('vvUser');
                    if (v && v !== 'null') isLogged = true;
                }
                if (isLogged) {
                    var css = document.createElement('style');
                    css.innerHTML = '#login-container{display:none !important;} #dashboard-container{display:block !important;}';
                    document.head.appendChild(css);
                    document.documentElement.setAttribute('data-logged-in','1');
                }
            } catch (e) {
                // fail silently - this is only an optimization to avoid a brief login flash
            }
        })();
    </script>
</head>
<body class="bg-[#0f1115] text-white" data-page="main">

    <div id="app">

    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="bg-[#1a1d23] p-8 md:p-12 rounded-2xl border border-[#2b2f3a] max-w-lg w-full text-center card-animate">
            <h1 class="text-2xl md:text-3xl font-bold mb-4">VV Studios Login</h1>
            <p class="text-white/60 mb-8">Please enter your credentials to access the dashboard.</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <input type="text" id="firstName" placeholder="First Name" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <input type="tel" id="phone" placeholder="Phone Number" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <div id="errorMessage" class="mt-4 text-red-500 text-center" style="display: none;"></div>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Sign In
                </button>
                <div class="mt-4 text-center">
                    <input type="checkbox" id="rememberMe" name="rememberMe" class="mr-2">
                    <label for="rememberMe" class="text-gray-400">Remember me</label>
                </div>
            </form>
            <p id="error-message" class="text-red-400 text-sm font-medium hidden"></p>
            <div class="mt-6 text-sm text-white/70">
                <p>Don't have an account with us yet? Sign up below.</p>
                <button id="open-signup-btn" class="mt-3 inline-flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold py-2 px-4 rounded-md">
                    Sign Up
                </button>
            </div>

            <!-- Sign Up Modal -->
            <div id="signup-modal" class="fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-60 hidden">
                <div class="bg-[#1a1d23] p-6 md:p-8 rounded-2xl border border-[#2b2f3a] max-w-2xl w-full text-center" style="max-height:90vh; overflow-y:auto;">
                    <img src="assets/logo.png" alt="VV Studios" class="mx-auto w-20 h-20 mb-4">
                    <h2 class="text-2xl font-bold mb-2">Create an Account</h2>
                    <p class="text-white/60 mb-6">Fill in your details to get started.</p>
                    <form id="signup-form" class="space-y-4 text-left">
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="signup-firstname" placeholder="First Name" class="flex-1 min-w-0 bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                            <input type="text" id="signup-lastname" placeholder="Last Name" class="flex-1 min-w-0 bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                        </div>
                        <div>
                            <input type="tel" id="signup-phone" placeholder="Phone Number (e.g. 07xxxxxxxx)" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                        </div>
                        <div>
                            <input type="text" id="signup-business" placeholder="Business Name" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-sm text-white/70 mb-1 block">Industry</label>
                            <select id="signup-industry" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-3 text-white">
                                <option value="retail">Retail</option>
                                <option value="services">Services</option>
                                <option value="food_beverage">Food &amp; Beverage</option>
                                <option value="technology">Technology</option>
                                <option value="education">Education</option>
                                <option value="finance">Finance</option>
                                <option value="health">Health</option>
                                <option value="other">Other</option>
                            </select>
                            <input type="text" id="signup-industry-other" placeholder="Input your industry" class="mt-2 w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none hidden">
                        </div>
                        <div>
                            <label class="text-sm text-white/70 mb-1 block">Role in Business</label>
                            <select id="signup-role" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-3 text-white">
                                <option value="business_owner">Business Owner</option>
                                <option value="employee">Employee</option>
                                <option value="sales_rep">Sales Rep</option>
                                <option value="sales_manager">Sales Manager</option>
                                <option value="marketer">Marketer</option>
                                <option value="social_media_manager">Social Media Manager</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div id="signup-employees-row" class="hidden">
                            <label class="text-sm text-white/70 mb-1 block">Number of Employees</label>
                            <input type="number" id="signup-employees" placeholder="e.g. 10" min="1" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-sm text-white/70 mb-1 block">Package of Interest</label>
                            <select id="signup-package" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-3 text-white">
                                <option value="growth">Growth</option>
                                <option value="pro">Pro</option>
                                <option value="premium">Premium</option>
                                <option value="not_yet">Not yet decided</option>
                            </select>
                        </div>
                        <div id="signup-error" class="text-red-400 text-sm hidden"></div>
                        <p class="text-xs text-white/60 mt-2">By Signing Up you agree to our <a href="terms.html" class="text-blue-400 underline">Terms</a>.</p>
                        <div class="flex items-center justify-between gap-3">
                            <button type="button" id="signup-cancel" class="w-1/2 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg">Cancel</button>
                            <button type="submit" id="signup-submit" class="w-1/2 bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg">Sign Up</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-container" style="display: none;">
        <div class="flex min-h-screen">
            <!-- Mobile Menu Backdrop -->
            <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 lg:hidden hidden"></div>

            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-[#14161a] p-6 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 z-50 lg:relative lg:translate-x-0">
                <div class="flex flex-col items-center space-y-2 mb-8">
                    <img src="assets/logo.png" alt="VV Studios Logo" class="w-16 h-16">
                    <span class="text-xl font-bold">VV Studios</span>
                    <span class="text-sm text-white/60">Client Portal</span>
                </div>
                <nav>
    <ul class="space-y-2">
        <!-- My Business (highlighted) -->
        <li class="mb-4">
            <a href="index.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors active">
                <i class="fa-solid fa-briefcase w-5 h-5"></i>
                <span>My Business</span>
                <span class="tooltip">View your business overview and key insights</span>
            </a>
        </li>

        <!-- Ads -->
        <li class="mb-4">
            <a href="ads_management_dashboard.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-bullhorn w-5 h-5"></i>
                <span>Ads</span>
                <span class="tooltip">Optimize your ad campaigns for maximum ROI!</span>
            </a>
        </li>

        <!-- Sales & Follow-Ups (CRM) -->
        <li class="mb-4">
            <a href="crmlanding.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-handshake w-5 h-5"></i>
                <span>Sales & Follow-Ups</span>
                <span class="tooltip">Track and manage your customers easily</span>
            </a>
        </li>

        <!-- Business Assistant (Copilot) -->
        <li class="mb-4">
            <a href="copilot.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-robot w-5 h-5"></i>
                <span>Business Assistant</span>
                <span class="tooltip">Your AI Copilot that helps you run the business</span>
            </a>
        </li>

        <!-- AI Sales Assistant (locked) -->
        <li class="mb-4">
            <a href="#"
                class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-robot w-5 h-5"></i>
                <span>AI Sales Assistant</span>
                <span class="tooltip">Unlock our smartest AI to blow up your sales!</span>
                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
            </a>
        </li>

        <!-- Automations (locked) -->
        <li class="mb-4">
            <a href="#"
                class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-arrows-spin w-5 h-5"></i>
                <span>Automations</span>
                <span class="tooltip">Automate your business and save 10+ hours a week!</span>
                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
            </a>
        </li>

        <!-- Marketing Systems (locked) -->
        <li class="mb-4">
            <a href="#"
                class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-gear w-5 h-5"></i>
                <span>Marketing Systems</span>
                <span class="tooltip">Sales and marketing on autopilot!</span>
                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
            </a>
        </li>

        <!-- Content Creation (always available) -->
        <li class="mb-4">
            <a href="blog/content-creation.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-pen-nib w-5 h-5"></i>
                <span>Content Creation</span>
            </a>
        </li>

        <!-- Live Chat (locked) -->
        <li class="mb-4">
            <a href="#"
                class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-comments w-5 h-5"></i>
                <span>Live Chat</span>
                <span class="tooltip">Engage with customers in real-time!</span>
                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
            </a>
        </li>
    </ul>
</nav>
            </aside>
            <main class="flex-1 overflow-y-auto p-8 lg:p-12">
                <div id="top-header" class="flex justify-between items-center mb-10 flex-wrap">
                    <div class="flex items-center w-full md:w-auto">
                        <!-- Mobile Menu Button -->
                        <button id="mobile-menu-button" class="lg:hidden mr-4 text-white focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                            </svg>
                        </button>
                        <div class="flex-1 min-w-[200px]">
                            <h1 id="businessName" class="text-3xl lg:text-4xl font-bold mb-1">Business Name</h1>
                            <p class="text-white/60 text-sm">Good to see you <span id="welcomeName" class="font-bold"></span>.</p>
                        </div>
                    </div>
                    <div id="header-controls" class="absolute right-4 top-4 z-50 flex items-center space-x-4 md:relative md:right-0 md:top-0 md:mt-0 mt-4 lg:mt-0">
                        <!-- Search removed: not used on dashboard -->
                        <button class="w-10 h-10 rounded-xl bg-[#1a1d23] flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white/70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 01-3.46 0"></path></svg>
                        </button>
                        
                        <div id="profile-menu-button" class="flex items-center space-x-2 p-2 bg-[#1a1d23] rounded-xl cursor-pointer">
                            <div id="profile-avatar" class="rounded-full w-8 h-8 bg-blue-500 flex items-center justify-center text-white font-bold text-sm">L</div>
                            <p id="profileName" class="font-medium text-sm hidden sm:block"><span id="welcomeName" class="font-bold"></p>
                        </div>
                        
                        <div id="profile-dropdown" class="absolute top-14 right-0 z-50 w-48 bg-[#1a1d23] rounded-xl border border-[#2b2f3a] p-2 shadow-lg hidden transition-opacity duration-200">
                            <a href="#" class="block p-2 text-sm text-white/80 hover:bg-[#2b2f3a] rounded-lg transition-colors">Change Password</a>
                            <a href="#" id="logoutButton" class="block p-2 text-sm text-red-400 hover:bg-[#2b2f3a] rounded-lg transition-colors">Logout</a>
                        </div>
                    </div>
                </div>

                 <!-- Countdown and Upsell Section -->
            <section class="mb-10 p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                <div class="flex items-center justify-between flex-wrap">
                    <div class="w-full md:w-auto flex-1 mb-4 md:mb-0">
                        <h2 id="packageTitle" class="text-white font-semibold text-lg mb-2"><span id="packageName" class="font-semibold text-white">Package</span> Plan Countdown</h2>
                        <div class="progress-bar-container">
                            <div id="countdown-bar" class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%;"></div>
                        </div>
                        <p id="countdown-text" class="text-sm text-white/60 mt-2">⏳ 30 days remaining in your package.</p>
                    </div>
                    <div class="w-full md:w-auto">
                        <!-- NOTE: the original STK/inline payment flow was commented out (moved to dashboard.js replacement).
                             Using the Ads-section till-number style payment flow instead. -->
                        <button id="upgrade-button" class="w-full md:w-auto bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-blue-700 transition-colors">
                            Upgrade Now
                        </button>
                    </div>
                </div>
            </section>
        <script>
        // Metric tooltip click handlers: toggle tooltip visibility and close on outside click
        document.addEventListener('click', function (e) {
            // if clicking a metric-info button
            const infoBtn = e.target.closest && e.target.closest('.metric-info');
            if (infoBtn) {
                const parent = infoBtn.parentElement || infoBtn.closest('.relative');
                if (!parent) return;
                // toggle show class
                parent.classList.toggle('show-tooltip');
                // hide other tooltips
                Array.from(document.querySelectorAll('.relative.show-tooltip')).forEach(el => {
                    if (el !== parent) el.classList.remove('show-tooltip');
                });
                e.stopPropagation();
                return;
            }
            // click outside -> close all
            Array.from(document.querySelectorAll('.relative.show-tooltip')).forEach(el=>el.classList.remove('show-tooltip'));
        });
        // Close on ESC
        document.addEventListener('keydown', function(e){ if (e.key === 'Escape') { Array.from(document.querySelectorAll('.relative.show-tooltip')).forEach(el=>el.classList.remove('show-tooltip')); } });

        // small CSS tweak to show metric tooltip when parent has .show-tooltip
        const style = document.createElement('style');
        style.innerHTML = '.relative .tooltip{ left: auto; right: 0; top: calc(100% + 8px); transform: translateY(0); visibility: hidden; opacity: 0; } .relative.show-tooltip .tooltip{ visibility: visible; opacity:1;} @media (max-width:1024px){ .relative .tooltip{ display:block; position:relative; left:0; right:0; top:8px; transform:none; white-space:normal; } }';
        document.head.appendChild(style);
        </script>

            <!-- Key Performance Indicators -->
<section class="mb-10">
    <div class="mb-6">
        <h2 class="text-xl font-semibold text-white mb-2">Key Performance Indicators</h2>
        <p class="text-white/80 text-sm italic">Monthly Success Indicators - compares with last month</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <!-- Card 1: Sales for Current Month (KES) -->
        <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-2 rounded-lg bg-purple-500/20">
                    <!-- Icon for Currency/Sales (Dollar Sign) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg>
                </div>
                <!-- Title will be updated by JS to include the current month -->
                <h3 id="salesTitle" class="font-medium text-white/80">Sales (Monthly)</h3> 
            </div>
            <p id="salesMonthly" class="text-3xl font-bold mb-1">Ksh 0</p>
<p id="salesMonthlyChange" data-change class="text-sm flex items-center">
    <svg id="salesMonthlyIcon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5l7 7-7 7M12 5l-7 7 7 7"></path>
    </svg>
    +0%
</p>

        </div>

        <!-- Card 2: Conversion Rate (%) -->
        <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-2 rounded-lg bg-orange-500/20">
                    <!-- Icon for Percentage/Conversion Rate -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="18" r="3"></circle></svg>
                </div>
                <div class="relative">
                    <h3 class="font-medium text-white/80 inline">Conversion Rate</h3>
                    <button class="metric-info ml-2 text-white/60" aria-label="Conversion Rate info" type="button">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <span class="tooltip metric-tooltip">Percent of contacts that became customers this month.</span>
                </div>
            </div>
            <p id="conversionRate" class="text-3xl font-bold mb-1">0%</p>
            <p id="conversionRateChange" class="text-sm flex items-center">
                <svg id="conversionRateIcon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5l7 7-7 7M12 5l-7 7 7 7"></path></svg>
                +0%
            </p>
        </div>

        <!-- Card 3: Life Time Value (LTV) (KES) -->
        <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-2 rounded-lg bg-blue-500/20">
                    <!-- Icon for Life Time Value (Target/Star) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 5v.01M12 9v.01M12 13v.01M12 17v.01M5 12h.01M9 12h.01M13 12h.01M17 12h.01"></path></svg>
                </div>
                <div class="relative">
                    <h3 class="font-medium text-white/80 inline">Life Time Value (LTV)</h3>
                    <button class="metric-info ml-2 text-white/60" aria-label="LTV info" type="button">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <span class="tooltip metric-tooltip">Average total money a customer spends for your business over time.</span>
                </div>
            </div>
            <p id="lifeTimeValue" class="text-3xl font-bold mb-1">Ksh 0</p>
            <p id="lifeTimeValueChange" class="text-sm flex items-center">
                <svg id="lifeTimeValueIcon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5l7 7-7 7M12 5l-7 7 7 7"></path></svg>
                +0%
            </p>
        </div>

        <!-- Card 4: Cost of Customer Acquisition (CAC) (KES) -->
        <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-2 rounded-lg bg-green-500/20">
                    <!-- Icon for Cost of Customer Acquisition (Price Tag) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 17H7l-3 4-3-4M21 17l-3 4-3-4H2V7h20v10z"></path></svg>
                </div>
                <div class="relative">
                    <h3 class="font-medium text-white/80 inline">Customer Acquisition Cost (CAC)</h3>
                    <button class="metric-info ml-2 text-white/60" aria-label="CAC info" type="button">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <span class="tooltip metric-tooltip">Average amount you spend on ads to get one new customer. Lower is better.</span>
                </div>
            </div>
            <p id="costOfAcquisition" class="text-3xl font-bold mb-1">Ksh 0</p>
            <p id="costOfAcquisitionChange" class="text-sm flex items-center">
                <svg id="costOfAcquisitionIcon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5l7 7-7 7M12 5l-7 7 7 7"></path></svg>
                +0%
            </p>
        </div>
    </div>
</section>
            <!-- Your Active Services -->
            <section id="active-services-section" class="mb-10">
                <div class="mb-6">
                    <h2 id="active-services-title" class="text-xl font-semibold text-white mb-2">Your Active Services</h2>
                </div>
                <div id="active-services-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-2 rounded-lg bg-blue-500/20">
                                <i class="fa-solid fa-rectangle-ad w-6 h-6 text-blue-400"></i>
                            </div>
                            <h3 class="font-medium text-white/80">Ads Management</h3>
                        </div>
                        <a href="ads_management_dashboard.html" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-green-700 transition-colors inline-block text-center">View Details</a>
                    </div>
                    <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-2 rounded-lg bg-purple-500/20">
                                <i class="fa-solid fa-robot w-6 h-6 text-purple-400"></i>
                            </div>
                            <h3 class="font-medium text-white/80">Sales & Follow Ups</h3>
                        </div>
                        <a href="crmlanding.html" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-green-700 transition-colors inline-block text-center">View Details</a>
                    </div>
                    <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-2 rounded-lg bg-teal-500/20">
                                <i class="fa-solid fa-robot w-6 h-6 text-teal-400"></i>
                            </div>
                            <h3 class="font-medium text-white/80">Business Assistant</h3>
                        </div>
                        <a href="copilot.html" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-green-700 transition-colors inline-block text-center">View Details</a>
                    </div>
                
                    <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-2 rounded-lg bg-orange-500/20">
                                <i class="fa-solid fa-pen-nib w-6 h-6 text-orange-400"></i>
                            </div>
                            <h3 class="font-medium text-white/80">Content Creation</h3>
                        </div>
                        <button class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-green-700 transition-colors">View Details</button>
                    </div>
                </div>
            </section>

            <!-- Learning Resources -->
            <section class="mb-10">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white mb-2">Unlock Your Marketing Potential</h2>
                    <p class="text-white/80 text-sm italic">Dive deep into digital marketing strategies that drive results</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-2 rounded-lg bg-red-500/20">
                                <i class="fa-solid fa-share-nodes w-6 h-6 text-red-400"></i>
                            </div>
                            <h3 class="font-medium text-white/80">Mastering Social Media Marketing</h3>
                        </div>
                        <p class="text-white/60 text-sm mb-4">Learn how to build engaging social media campaigns that convert followers into customers.</p>
                        <button class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-blue-700 transition-colors">Read More</button>
                    </div>
                    <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-2 rounded-lg bg-yellow-500/20">
                                <i class="fa-solid fa-search w-6 h-6 text-yellow-400"></i>
                            </div>
                            <h3 class="font-medium text-white/80">SEO Strategies for Small Businesses</h3>
                        </div>
                        <p class="text-white/60 text-sm mb-4">Optimize your website to rank higher on search engines and attract more organic traffic.</p>
                        <button class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-blue-700 transition-colors">Read More</button>
                    </div>
                    <div class="p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-2 rounded-lg bg-teal-500/20">
                                <i class="fa-solid fa-envelope w-6 h-6 text-teal-400"></i>
                            </div>
                            <h3 class="font-medium text-white/80">Email Marketing Best Practices</h3>
                        </div>
                        <p class="text-white/60 text-sm mb-4">Build effective email campaigns that nurture leads and boost customer loyalty.</p>
                        <button class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-blue-700 transition-colors">Read More</button>
                    </div>
                </div>
            </section>
            </main>
        </div>
    </div>

    </div> <!-- /#app -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
    const menuBtn = document.getElementById("mobile-menu-button");
    const sidebar = document.getElementById("sidebar");
    const backdrop = document.getElementById("mobile-menu-backdrop");

    if (!menuBtn || !sidebar) return;

    menuBtn.addEventListener("click", () => {
        sidebar.classList.toggle("-translate-x-full");     // slide in/out
        backdrop.classList.toggle("hidden");               // background blur
    });

    backdrop.addEventListener("click", () => {
        sidebar.classList.add("-translate-x-full");
        backdrop.classList.add("hidden");
    });
});
</script>
    <!-- Axios (no SRI here to avoid CORS issues when CDN doesn't provide cross-origin headers) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <!-- Supabase (ES module) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
    <script src="router.js"></script>
    <script src="auth.js"></script>
    <script type="module" src="dashboard.js"></script>
    <script>
    // Sign-up modal behavior: open/close, field toggles and submit validation
    (function(){
        const openBtn = document.getElementById('open-signup-btn');
        const modal = document.getElementById('signup-modal');
        const cancelBtn = document.getElementById('signup-cancel');
        const form = document.getElementById('signup-form');
        const industry = document.getElementById('signup-industry');
        const industryOther = document.getElementById('signup-industry-other');
        const role = document.getElementById('signup-role');
        const employeesRow = document.getElementById('signup-employees-row');
        const errorBox = document.getElementById('signup-error');

        function openModal(){
            modal.classList.remove('hidden');
            // prevent body scroll while modal is open
            try { document.body.style.overflow = 'hidden'; } catch (e) {}
            // focus first field
            setTimeout(()=>document.getElementById('signup-firstname')?.focus(),100);
        }
        function closeModal(){
            modal.classList.add('hidden');
            try { document.body.style.overflow = ''; } catch (e) {}
            errorBox.classList.add('hidden');
            form.reset();
            industryOther.classList.add('hidden');
            employeesRow.classList.add('hidden');
        }

        if (openBtn) openBtn.addEventListener('click', openModal);
        if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

        // close when clicking overlay (but not when clicking inner dialog)
        if (modal) modal.addEventListener('click', (ev)=>{
            if (ev.target === modal) closeModal();
        });

        function updateConditionalFields(){
            if (!industry || !role) return;
            if (industry.value === 'other') {
                industryOther.classList.remove('hidden');
            } else {
                industryOther.classList.add('hidden');
            }

            // show number-of-employees only if either industry or role is 'other'
            if (industry.value === 'other' || role.value === 'other') {
                employeesRow.classList.remove('hidden');
            } else {
                employeesRow.classList.add('hidden');
            }
        }

        if (industry) industry.addEventListener('change', updateConditionalFields);
        if (role) role.addEventListener('change', updateConditionalFields);

        function showError(msg){
            errorBox.textContent = msg;
            errorBox.classList.remove('hidden');
        }

        function validatePhone(phone){
            if (!phone) return false;
            const digits = phone.replace(/\D/g,'');
            if (phone.startsWith('07')) {
                return /^07\d{8}$/.test(digits) && digits.length===10;
            }
            // fallback: allow 9-15 digits for other formats
            return /^\d{9,15}$/.test(digits);
        }

        if (form) form.addEventListener('submit', async function(e){
            e.preventDefault();
            errorBox.classList.add('hidden');
            const first = document.getElementById('signup-firstname')?.value?.trim();
            const last = document.getElementById('signup-lastname')?.value?.trim();
            const phoneInput = document.getElementById('signup-phone')?.value?.trim();
            const business = document.getElementById('signup-business')?.value?.trim();
            const pkg = document.getElementById('signup-package')?.value || 'Free';
            const ind = (industry.value === 'other') ? (industryOther.value || 'other') : industry.value;
            const rl = role.value;
            const employees = document.getElementById('signup-employees')?.value || null;

            if (!first) return showError('First name is required');
            if (!phoneInput) return showError('Phone number is required');
            if (!validatePhone(phoneInput)) return showError('Please enter a valid phone number (e.g. 07xxxxxxxx)');
            if (!business) return showError('Business name is required');

            // Local phone normalization to 2547xxxxxxx
            function normalizePhone(p) {
                if (!p) return '';
                let s = String(p).trim();
                s = s.replace(/\s+/g, '');
                if (s.startsWith('+')) s = s.substring(1);
                const digits = s.replace(/\D/g, '');
                if (s.startsWith('0')) {
                    // 07xxxxxxxx -> 2547xxxxxxxx
                    return '254' + digits.substring(1);
                }
                if (digits.length === 9 && digits.startsWith('7')) {
                    return '254' + digits;
                }
                if (digits.startsWith('254')) return digits;
                return digits;
            }

            const normalizedPhone = normalizePhone(phoneInput);

            // Supabase REST endpoint details (same project as dashboard.js)
            const SUPABASE_URL = 'https://xgtnbxdxbbywvzrttixf.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ';

            // Generate a business id: sanitized business name + two random digits; ensure uniqueness
            function sanitizeBusinessName(name) {
                return name.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '') || 'business';
            }

            async function isBusinessIdTaken(bid) {
                const q = encodeURIComponent('business id') + '=eq.' + encodeURIComponent(bid);
                const res = await fetch(`${SUPABASE_URL}/rest/v1/logins?${q}&select=id`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (!res.ok) return false;
                const data = await res.json();
                return Array.isArray(data) && data.length > 0;
            }

            const baseId = sanitizeBusinessName(business);
            let businessId = '';
            for (let i=0;i<6;i++) {
                const rand = Math.floor(Math.random()*90) + 10; // 10-99
                const candidate = `${baseId}${rand}`;
                try {
                    const taken = await isBusinessIdTaken(candidate);
                    if (!taken) { businessId = candidate; break; }
                } catch (err) {
                    // network issue; accept candidate
                    businessId = candidate; break;
                }
            }
            if (!businessId) businessId = baseId + Math.floor(Math.random()*9000+1000);

            // Compute package expiry for Free (use authUtils if available)
            let expiry = null;
            try {
                if (window.authUtils && typeof window.authUtils.computePackageExpiryDate === 'function') {
                    expiry = window.authUtils.computePackageExpiryDate(new Date().toISOString(), 'Free');
                }
            } catch (e) {}
            if (!expiry) {
                const d = new Date(); d.setUTCDate(d.getUTCDate() + 3); expiry = d.toISOString();
            }

            const payload = {
                phone_number: normalizedPhone,
                admin_name: first,
                full_name: `${first} ${last}`.trim(),
                business_name: business,
                'business id': businessId,
                package: 'Free',
                joined_date: new Date().toISOString(),
                package_expiry_date: expiry,
                industry: ind,
                role: rl,
                employees: employees
            };

            try {
                errorBox.classList.remove('hidden');
                errorBox.style.color = '#ffd6a5';
                errorBox.textContent = 'Creating account...';

                const res = await fetch(`${SUPABASE_URL}/rest/v1/logins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(payload)
                });

                const body = await res.json();
                if (!res.ok) {
                    console.error('Supabase insert error', body);
                    return showError((body && body.message) ? body.message : 'Failed to create account');
                }

                const created = Array.isArray(body) ? body[0] : body;
                // Build saved user for localStorage (compat with dashboard.js expectations)
                const savedUser = Object.assign({}, created, {
                    business_id: created['business id'] || businessId,
                    phone_number: created.phone_number || normalizedPhone,
                    phone: phoneInput,
                    admin_first_name: first,
                    firstName: first
                });

                localStorage.setItem('vvUser', JSON.stringify(savedUser));
                // success feedback then reload to trigger auto-login
                errorBox.style.color = '#9ae6b4';
                errorBox.textContent = 'Account created — redirecting...';
                setTimeout(()=>{
                    window.location.reload();
                },900);

            } catch (err) {
                console.error('Sign-up error', err);
                showError('Network error while creating account');
            }
        });

        // Profile dropdown toggle and logout wiring
        const profileBtn = document.getElementById('profile-menu-button');
        const profileDropdown = document.getElementById('profile-dropdown');
        const logoutBtn = document.getElementById('logoutButton');

        if (profileBtn && profileDropdown) {
            profileBtn.addEventListener('click', function(ev){
                profileDropdown.classList.toggle('hidden');
                ev.stopPropagation();
            });

            document.addEventListener('click', function(ev){
                if (!profileBtn.contains(ev.target) && !profileDropdown.contains(ev.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e){
                e.preventDefault();
                try {
                    if (window.authUtils && typeof window.authUtils.logout === 'function') {
                        window.authUtils.logout();
                        return;
                    }
                } catch (err) {
                    console.warn('authUtils.logout not available, falling back');
                }
                localStorage.removeItem('vvUser');
                window.location.href = 'index.html';
            });
        }
    })();
    </script>

        <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('ServiceWorker registered'))
                .catch(err => console.error("SW registration failed:", err));
        }
        // Listen for Service Worker update notifications and show a non-intrusive top tip
        if (navigator.serviceWorker) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                try {
                    const data = event.data;
                    if (!data) return;
                    if (data.type === 'SW_UPDATED') {
                        // Show a transient tip at the very top saying 'new updates applied'
                        const bannerId = 'sw-update-tip';
                        if (!document.getElementById(bannerId)) {
                            const banner = document.createElement('div');
                            banner.id = bannerId;
                            banner.textContent = 'new updates applied';
                            banner.style.position = 'fixed';
                            banner.style.top = '0';
                            banner.style.left = '0';
                            banner.style.right = '0';
                            banner.style.zIndex = '9999';
                            banner.style.background = 'linear-gradient(90deg,#10b981,#06b6d4)';
                            banner.style.color = '#fff';
                            banner.style.padding = '10px 12px';
                            banner.style.textAlign = 'center';
                            banner.style.fontWeight = '600';
                            banner.style.fontFamily = 'Inter, sans-serif';
                            banner.style.boxShadow = '0 2px 8px rgba(0,0,0,0.16)';
                            banner.style.pointerEvents = 'none';
                            document.body.appendChild(banner);
                        }

                        // Tell the SW to skip waiting so the new SW can activate immediately
                        if (navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage('SKIP_WAITING');
                        }

                        // Keep the tip for a few seconds then reload to pick up the new assets
                        setTimeout(() => {
                            const el = document.getElementById('sw-update-tip');
                            if (el) el.remove();
                            window.location.reload();
                        }, 3000);
                    }
                } catch (e) { console.warn('SW message handler error', e); }
            });
        }
        </script>
</body>
</html>
