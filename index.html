<!DOCTYPE html>
<html lang="en">
<head>
    <script src="loading.js"></script>
    <script>
        // Early free-user redirect: run as soon as possible to avoid loading other flows.
        (function(){
            try {
                // Only redirect if we're not already on the free page.
                if (location.pathname && location.pathname.toLowerCase().endsWith('free.html')) return;

                var raw = null;
                try { raw = localStorage.getItem('vvUser'); } catch(e) { raw = null; }
                if (!raw) return;
                var user = null;
                try { user = JSON.parse(raw); } catch(e) { user = null; }
                if (!user) return;

                // Accept package values like 'Free' or 'free' or missing package but package_expiry_date present
                var pkg = (user.package || user.package_name || user.packageType || '') + '';
                pkg = pkg.toLowerCase();

                if (pkg === 'free'){
                    // Perform an immediate replace so history doesn't accumulate and other scripts don't run.
                    window.location.replace('free.html');
                }
            } catch (e) { /* silently ignore */ }
        })();
    </script>
    <meta charset="UTF-8">
    <!-- Dynamic viewport: keep mobile at 0.8 (user preference) but use 1.0 on desktop to avoid zoomed-in layout -->
    <meta id="dynamic-viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <script>
        (function(){
            try {
                // Preserve the mobile tuning (initial-scale=0.8) while ensuring desktop uses 1.0
                var vp = document.getElementById('dynamic-viewport');
                function updateViewport() {
                    var w = window.innerWidth || document.documentElement.clientWidth || 1024;
                    // Treat < 768 as mobile (matches the app's breakpoints)
                        if (w < 768) {
                            // keep the mobile tuning to 0.8 for compact mobile layout
                            vp.setAttribute('content', 'width=device-width, initial-scale=0.8, minimum-scale=0.8, viewport-fit=cover');
                        } else {
                            // Desktop: use 1.0 so desktop doesn't appear zoomed-in
                            vp.setAttribute('content', 'width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover');
                        }
                }
                // Run once early
                updateViewport();
                // Also update if the window is resized (user may toggle dev tools or change device)
                window.addEventListener('resize', function(){ try { updateViewport(); } catch(e){} });
            } catch (e) { console.warn('viewport script error', e); }
        })();
    </script>
    <title>VV Studios Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="theme.css">
    <meta name="theme-color" content="#0f1115">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script>
    // If NOT installed â†’ redirect to install screen
    if (
        !window.matchMedia("(display-mode: standalone)").matches &&
        !window.navigator.standalone &&
        !document.referrer.includes("android-app://")
    ) {
        window.location.replace("install.html");
    }
</script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar styling for the dashboard content */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background-color: transparent;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .card-animate {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-animate:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .sidebar-link {
            position: relative;
            transition: all 0.2s ease;
        }
        .sidebar-link:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip {
            position: absolute;
            left: calc(100% + 15px);
            top: 50%;
            transform: translateY(-50%);
            visibility: hidden;
            opacity: 0;
            background-color: #2b2f3a;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap;
            font-size: 0.875rem;
            z-index: 10;
            transition: opacity 0.3s ease;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent #2b2f3a transparent transparent;
        }
        .sidebar-link.active {
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.1);
        }
        .sidebar-link.faint-gold {
            color: #FFD700;
        }
        /* Hide hover tooltips on mobile (no hover) - keep desktop hover behaviour */
        @media (max-width: 1024px) {
            .sidebar-link .tooltip { display: none !important; }
        }

        /* Locked-toast text styles (used by JS-created toasts) */
        .locked-toast { color: #9CA3AF; }
        .locked-toast .pro { color: #FFD700; font-weight: 700; }
        .locked-toast .growth { color: #10B981; font-weight: 700; }
        .progress-bar-container {
            height: 8px;
            background-color: #4b5563;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease, background-color 0.5s ease;
        }
        .progress-green {
            background-color: #10B981;
        }
        .progress-yellow {
            background-color: #FBBF24;
        }
        .progress-red {
            background-color: #EF4444;
        }
        .upgrade-button {
            transition: background-color 0.3s ease;
        }
        /* Small, non-distracting floating upgrade button (bottom-center) */
        .upgrade-floating {
            position: fixed;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #6b7280; /* gray */
            color: #7c3aed; /* purple text */
            padding: 6px 10px;
            font-size: 0.85rem;
            border-radius: 9999px;
            border: 1px solid rgba(255,255,255,0.03);
            box-shadow: none;
            z-index: 70;
            min-width: 88px;
            text-align: center;
        }
        .upgrade-floating:hover { background-color: #585b62; }
        .text-green { color: #22c55e; }
        .text-yellow { color: #eab308; }
        .text-red { color: #ef4444; }
        /* Additional styling from index.html */
        .chart-placeholder {
            background: linear-gradient(135deg, #1f2937 0%, #2a3547 100%);
            border: 1px solid #374151;
            padding: 1.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 1.125rem;
            font-style: italic;
            min-height: 250px;
        }

        /* Header controls: place alerts & profile at top-right and reserve space to avoid overlap */
        #top-header { position: relative; }
        #header-controls { position: absolute; right: 1rem; top: 0.75rem; z-index: 50; display: flex; gap: 0.5rem; }

        /* Reserve right padding so the business name doesn't overlap with the controls on small screens */
        @media (max-width: 768px) {
            #top-header { padding-right: 6.5rem; }
            #header-controls { top: 0.5rem; right: 0.75rem; }
            #mobile-menu-button { margin-bottom: 0.25rem; }
        }
        .toggle-switch-container {
            display: flex;
            background-color: #2b2f3a;
            border-radius: 9999px;
            padding: 4px;
        }
        .toggle-button {
            padding: 8px 16px;
            cursor: pointer;
            color: #d1d5db;
            border-radius: 9999px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .toggle-button.active {
            background-color: #1a1d23;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .logout-button {
            background-color: #ef4444;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            transition: background-color 0.3s ease;
        }
        .logout-button:hover {
            background-color: #dc2626;
        }
        
    </style>
    <script>
        // Prevent login flash: if user is already logged in (vvUser in localStorage),
        // hide the login container and show the dashboard container before the DOM paints.
        (function(){
            try {
                var isLogged = false;
                if (typeof localStorage !== 'undefined') {
                    var v = localStorage.getItem('vvUser');
                    if (v && v !== 'null') isLogged = true;
                }
                if (isLogged) {
                    var css = document.createElement('style');
                    css.innerHTML = '#login-container{display:none !important;} #dashboard-container{display:block !important;}';
                    document.head.appendChild(css);
                    document.documentElement.setAttribute('data-logged-in','1');
                }
            } catch (e) {
                // fail silently - this is only an optimization to avoid a brief login flash
            }
        })();
    </script>
</head>
<body class="bg-[#0f1115] text-white" data-page="main">

    <div id="app">

    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="bg-[#1a1d23] p-8 md:p-12 rounded-2xl border border-[#2b2f3a] max-w-lg w-full text-center card-animate">
            <h1 class="text-2xl md:text-3xl font-bold mb-4">VV Studios Login</h1>
            <p class="text-white/60 mb-8">Please enter your credentials to access the dashboard.</p>
            <form id="login-form" class="space-y-6" onsubmit="return false;" novalidate>
                <div>
                    <input type="text" id="firstName" placeholder="First Name" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <input type="tel" id="phone" placeholder="Phone Number" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <div id="errorMessage" class="mt-4 text-red-500 text-center" style="display: none;"></div>
                <button type="button" id="login-submit-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Sign In
                </button>
                <div class="mt-4 text-center">
                    <input type="checkbox" id="rememberMe" name="rememberMe" class="mr-2">
                    <label for="rememberMe" class="text-gray-400">Remember me</label>
                </div>
            </form>
            <p id="error-message" class="text-red-400 text-sm font-medium hidden"></p>
            <div class="mt-6 text-sm text-white/70">
                <p>Don't have an account with us yet? Sign up below.</p>
                <button id="open-signup-btn" class="mt-3 inline-flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold py-2 px-4 rounded-md">
                    Sign Up
                </button>
            </div>

            <script>
                // Update card buttons based on onboarding_view flags (audit, offer)
                document.addEventListener('DOMContentLoaded', async function(){
                    try {
                        // Prefer BUSINESS_ID from crm.js if present
                        const businessId = (typeof BUSINESS_ID !== 'undefined' && BUSINESS_ID) ? BUSINESS_ID : (localStorage.getItem('business_id') || (JSON.parse(localStorage.getItem('vvUser')||'{}').business_id));
                        if (!businessId) return;

                        // Ensure we have a Supabase client available; create a short-lived client if needed
                        const SUPABASE_URL = 'https://xgtnbxdxbbywvzrttixf.supabase.co';
                        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ';

                        let svcClient = null;
                        if (window.client) svcClient = window.client;
                        else if (window.supabase && typeof window.supabase.createClient === 'function') {
                            try { svcClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e){ svcClient = null; }
                        }
                        if (!svcClient) { console.warn('No Supabase client available; skipping package card updates.'); return; }

                        const { data, error } = await svcClient.from('onboarding_view').select('*').eq('business_id', businessId).maybeSingle();
                        if (error) { console.warn('Could not load onboarding_view', error); return; }
                        if (!data) return;

                        // Audit button: Show "View" if completed, otherwise "Start"
                        try {
                            const auditBtn = document.getElementById('pkg-audit-btn');
                            if (data.audit_complete) {
                                if (auditBtn) {
                                    auditBtn.innerText = 'View';
                                    auditBtn.classList.remove('bg-orange-600');
                                    auditBtn.classList.add('bg-blue-600','hover:bg-blue-500');
                                }
                            } else {
                                if (auditBtn) {
                                    auditBtn.innerText = 'Start';
                                    auditBtn.classList.remove('bg-blue-600');
                                    auditBtn.classList.add('bg-orange-600','hover:bg-orange-500');
                                }
                            }
                        } catch (e) { console.warn('Failed to update audit button', e); }

                        // Offers subheading
                        try {
                            const offerSub = document.getElementById('pkg-offer-sub');
                            if (data.offer_complete) {
                                if (offerSub) offerSub.innerText = 'Create Your Next Big Offer';
                            } else {
                                if (offerSub) offerSub.innerText = 'Create your first offer';
                            }
                        } catch (e) { console.warn('Failed to update offers subheading', e); }

                        // Profile button remains "Edit" (opens modal through crm.js). No further action required.

                    } catch (err) {
                        console.warn('Error initialising package cards', err);
                    }
                });
            </script>

            <script>
                // Business Profile: open modal, load/save using crm.js helpers if present,
                // otherwise fall back to localStorage. Also include unsaved-changes confirm modal.
                (function(){
                    function getVVUser(){ try { return JSON.parse(localStorage.getItem('vvUser')||'{}'); } catch(e){ return {}; } }
                    function saveVVUser(u){ try { localStorage.setItem('vvUser', JSON.stringify(u)); return true; } catch(e){ console.warn('saveVVUser failed', e); return false; } }

                    // Small snapshot utilities (mirrors crm.js behaviour)
                    let businessProfileSnapshot = null;
                    function captureBusinessProfileSnapshot(){
                        try {
                            return {
                                business_name: document.getElementById('bp-business-name')?.value || '',
                                industry: document.getElementById('bp-industry')?.value || '',
                                location: document.getElementById('bp-location')?.value || '',
                                tagline: document.getElementById('bp-tagline')?.value || '',
                                short_description: document.getElementById('bp-short-desc')?.value || '',
                                long_description: document.getElementById('bp-long-desc')?.value || '',
                                target_audience: document.getElementById('bp-target-audience')?.value || '',
                                unique_value: document.getElementById('bp-unique-value')?.value || '',
                                main_offer: document.getElementById('bp-main-offer')?.value || '',
                                secondary_offers: document.getElementById('bp-secondary-offers')?.value || '',
                                tone_of_voice: document.getElementById('bp-tone-of-voice')?.value || '',
                                website: document.getElementById('bp-website')?.value || '',
                                facebook: document.getElementById('bp-facebook')?.value || '',
                                instagram: document.getElementById('bp-instagram')?.value || '',
                                twitter: document.getElementById('bp-twitter')?.value || ''
                            };
                        } catch(e){ return null; }
                    }
                    function isBusinessProfileDirty(){
                        try {
                            if (!businessProfileSnapshot) return false;
                            const cur = captureBusinessProfileSnapshot();
                            for (const k of Object.keys(businessProfileSnapshot)){
                                const a = businessProfileSnapshot[k]||'';
                                const b = cur[k]||'';
                                if (a !== b) return true;
                            }
                            return false;
                        } catch(e){ return false; }
                    }
                    function resetBusinessProfileToSnapshot(){
                        try {
                            if (!businessProfileSnapshot) return;
                            const s = businessProfileSnapshot;
                            document.getElementById('bp-business-name') && (document.getElementById('bp-business-name').value = s.business_name || '');
                            document.getElementById('bp-industry') && (document.getElementById('bp-industry').value = s.industry || '');
                            document.getElementById('bp-location') && (document.getElementById('bp-location').value = s.location || '');
                            document.getElementById('bp-tagline') && (document.getElementById('bp-tagline').value = s.tagline || '');
                            document.getElementById('bp-short-desc') && (document.getElementById('bp-short-desc').value = s.short_description || '');
                            document.getElementById('bp-long-desc') && (document.getElementById('bp-long-desc').value = s.long_description || '');
                            document.getElementById('bp-target-audience') && (document.getElementById('bp-target-audience').value = s.target_audience || '');
                            document.getElementById('bp-unique-value') && (document.getElementById('bp-unique-value').value = s.unique_value || '');
                            document.getElementById('bp-main-offer') && (document.getElementById('bp-main-offer').value = s.main_offer || '');
                            document.getElementById('bp-secondary-offers') && (document.getElementById('bp-secondary-offers').value = s.secondary_offers || '');
                            document.getElementById('bp-tone-of-voice') && (document.getElementById('bp-tone-of-voice').value = s.tone_of_voice || '');
                            document.getElementById('bp-website') && (document.getElementById('bp-website').value = s.website || '');
                            document.getElementById('bp-facebook') && (document.getElementById('bp-facebook').value = s.facebook || '');
                            document.getElementById('bp-instagram') && (document.getElementById('bp-instagram').value = s.instagram || '');
                            document.getElementById('bp-twitter') && (document.getElementById('bp-twitter').value = s.twitter || '');
                        } catch(e){}
                    }

                    document.addEventListener('DOMContentLoaded', function(){
                        const openBtn = document.getElementById('pkg-bp-edit-btn');
                        // Use the namespaced modal IDs present in this file
                        const modal = document.getElementById('indexbusinessprofile-modal');
                        const form = document.getElementById('indexbusinessprofile-form');
                        const closeBtns = document.querySelectorAll('[data-modal-close]');
                        const confirmModal = document.getElementById('indexbusinessprofile-confirm-modal');
                        const discardBtn = document.getElementById('index-bp-discard-btn');
                        const confirmSaveBtn = document.getElementById('index-bp-confirm-save-btn');

                        // debug helper: confirm handler attachment in console
                        console.log('Business profile: openBtn=', !!openBtn, 'modal=', !!modal, 'form=', !!form);

                        async function populateFromBackend(){
                            // If crm.js provides loadBusinessProfile(), use it (it will populate inputs)
                            if (typeof loadBusinessProfile === 'function'){
                                try { await loadBusinessProfile(); return true; } catch(e){ console.warn('loadBusinessProfile failed', e); }
                            }
                            return false;
                        }

                        function populateFromLocal(){
                            const u = getVVUser();
                            document.getElementById('bp-business-name').value = u.business_name || u.businessName || '';
                            document.getElementById('bp-industry').value = u.industry || '';
                            document.getElementById('bp-location').value = u.location || '';
                            document.getElementById('bp-tagline').value = u.tagline || '';
                            document.getElementById('bp-short-desc').value = u.short_description || '';
                            document.getElementById('bp-long-desc').value = u.long_description || '';
                            document.getElementById('bp-target-audience').value = u.target_audience || '';
                            document.getElementById('bp-unique-value').value = u.unique_value || '';
                            document.getElementById('bp-main-offer').value = u.main_offer || '';
                            document.getElementById('bp-secondary-offers').value = u.secondary_offers || '';
                            document.getElementById('bp-tone-of-voice').value = u.tone_of_voice || '';
                            document.getElementById('bp-website').value = u.website || '';
                            document.getElementById('bp-facebook').value = u.facebook || '';
                            document.getElementById('bp-instagram').value = u.instagram || '';
                            document.getElementById('bp-twitter').value = u.twitter || '';
                        }

                        async function openModal(e){
                            if (e) e.preventDefault();
                            console.log('index: openModal called');
                            // Prefer backend loader (guard and log so it can't block UI)
                            let ok = false;
                            try {
                                console.log('index: attempting populateFromBackend (with timeout)');
                                // Protect against a backend loader that never resolves by racing with a timeout
                                ok = await Promise.race([
                                    populateFromBackend(),
                                    new Promise((_, reject) => setTimeout(() => reject(new Error('populateFromBackend timeout')), 6000))
                                ]);
                                console.log('index: populateFromBackend returned', ok);
                            } catch (err) {
                                console.warn('index: populateFromBackend threw or timed out', err);
                                ok = false;
                            }

                            if (!ok) {
                                try {
                                    console.log('index: falling back to populateFromLocal');
                                } catch (err) {
                                    console.warn('index: populateFromLocal failed', err);
                                }
                            }

                            // snapshot for dirty-check
                            try { businessProfileSnapshot = captureBusinessProfileSnapshot(); } catch(e){ console.warn('index: snapshot failed', e); }
                            if (modal) {
                                try { modal.classList.remove('hidden'); } catch(e){ console.warn('index: showing modal failed', e); }
                            }
                            try { document.body.style.overflow = 'hidden'; } catch(e){}
                        }

                        function closeModal(){
                            modal.classList.add('hidden');
                            try { document.body.style.overflow = ''; } catch(e){}
                        }

                        // wire open button
                        if (openBtn) {
                            openBtn.addEventListener('click', openModal);
                        }
                        // close buttons (they use data-modal-close="indexbusinessprofile-modal")
                        closeBtns.forEach(btn => btn.addEventListener('click', async function(ev){
                            ev.preventDefault();
                            if (isBusinessProfileDirty()) {
                                if (confirmModal) confirmModal.classList.remove('hidden');
                            } else {
                                closeModal();
                            }
                        }));

                        // backdrop click closes if not dirty
                        modal && modal.addEventListener('click', function(ev){ if (ev.target === modal) { if (isBusinessProfileDirty()) confirmModal.classList.remove('hidden'); else closeModal(); } });

                        // Confirm modal handlers
                        discardBtn && discardBtn.addEventListener('click', function(){
                            resetBusinessProfileToSnapshot();
                            businessProfileSnapshot = captureBusinessProfileSnapshot();
                            document.getElementById('indexbusinessprofile-confirm-modal')?.classList.add('hidden');
                            closeModal();
                        });
                        confirmSaveBtn && confirmSaveBtn.addEventListener('click', function(){
                            // trigger save
                            document.getElementById('bp-save-btn')?.click();
                        });

                        // Save handler: prefer backend saveBusinessProfile(), fallback to localStorage
                        form && form.addEventListener('submit', async function(ev){
                            ev.preventDefault();
                            // If crm.js save exists, call it (it reads inputs and upserts)
                            if (typeof saveBusinessProfile === 'function'){
                                try { await saveBusinessProfile(ev); } catch(e){ console.warn('saveBusinessProfile failed', e); }
                            } else {
                                // fallback: save to localStorage.vvUser
                                const u = getVVUser();
                                u.business_name = document.getElementById('bp-business-name')?.value || '';
                                u.industry = document.getElementById('bp-industry')?.value || '';
                                u.location = document.getElementById('bp-location')?.value || '';
                                u.tagline = document.getElementById('bp-tagline')?.value || '';
                                u.short_description = document.getElementById('bp-short-desc')?.value || '';
                                u.long_description = document.getElementById('bp-long-desc')?.value || '';
                                u.target_audience = document.getElementById('bp-target-audience')?.value || '';
                                u.unique_value = document.getElementById('bp-unique-value')?.value || '';
                                u.main_offer = document.getElementById('bp-main-offer')?.value || '';
                                u.secondary_offers = document.getElementById('bp-secondary-offers')?.value || '';
                                u.tone_of_voice = document.getElementById('bp-tone-of-voice')?.value || '';
                                u.website = document.getElementById('bp-website')?.value || '';
                                u.facebook = document.getElementById('bp-facebook')?.value || '';
                                u.instagram = document.getElementById('bp-instagram')?.value || '';
                                u.twitter = document.getElementById('bp-twitter')?.value || '';
                                saveVVUser(u);
                                // update header if present
                                try { document.getElementById('businessName').textContent = u.business_name || document.getElementById('businessName').textContent; } catch(e){}
                            }
                            // refresh snapshot and close
                            businessProfileSnapshot = captureBusinessProfileSnapshot();
                            document.getElementById('indexbusinessprofile-confirm-modal')?.classList.add('hidden');
                            closeModal();
                        });

                        // Cancel button: show confirm if dirty
                        const bpCancel = document.getElementById('bp-cancel-btn');
                        bpCancel && bpCancel.addEventListener('click', function(ev){
                            ev.preventDefault();
                            if (isBusinessProfileDirty()) {
                                document.getElementById('business-profile-confirm-modal')?.classList.remove('hidden');
                            } else {
                                closeModal();
                            }
                        });

                    });
                })();
            </script>

            <script>
                (function(){
                    // Fallback login handler: prevents silent reloads and performs
                    // a REST lookup if the module handler isn't attached.
                    const SUPABASE_URL = 'https://xgtnbxdxbbywvzrttixf.supabase.co';
                    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ';

                    function normalizePhone(p){
                        if (!p) return '';
                        let s = String(p).trim();
                        s = s.replace(/\s+/g,'');
                        if (s.startsWith('+')) s = s.substring(1);
                        const digits = s.replace(/\D/g,'');
                        if (s.startsWith('0')) return '254' + digits.substring(1);
                        if (digits.length === 9 && digits.startsWith('7')) return '254' + digits;
                        if (digits.startsWith('254')) return digits;
                        return digits;
                    }

                    const btn = document.getElementById('login-submit-btn');
                    const errEl = document.getElementById('errorMessage') || document.getElementById('error-message');
                    if (!btn) return;

                    btn.addEventListener('click', async function(e){
                        e.preventDefault();
                        // If module-level handler exists, prefer it
                        try {
                            if (window.authenticateByPhone && typeof window.authenticateByPhone === 'function') {
                                await window.authenticateByPhone(document.getElementById('phone')?.value || '', document.getElementById('firstName')?.value || '');
                                return;
                            }
                        } catch (ex) {
                            console.warn('module authenticateByPhone failed, falling back', ex);
                        }

                        const phoneInput = document.getElementById('phone')?.value?.trim() || '';
                        const firstName = document.getElementById('firstName')?.value?.trim() || '';
                        if (!phoneInput) {
                            if (errEl) { errEl.textContent = 'Phone number is required'; errEl.style.display = 'block'; }
                            return;
                        }

                        const normalized = normalizePhone(phoneInput);
                        if (errEl) { errEl.style.display = 'block'; errEl.style.color = '#ffd6a5'; errEl.textContent = 'Signing in...'; }

                        try {
                            const res = await fetch(`${SUPABASE_URL}/rest/v1/logins?phone_number=eq.${encodeURIComponent(normalized)}&select=*`, {
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`
                                }
                            });
                            if (!res.ok) {
                                if (errEl) { errEl.textContent = 'Login failed (network)'; errEl.style.display = 'block'; }
                                return;
                            }
                            const body = await res.json();
                            const found = Array.isArray(body) ? body[0] : body;
                            if (!found) {
                                if (errEl) { errEl.style.color = '#fca5a5'; errEl.textContent = 'No account found. Sign up below.'; errEl.style.display = 'block'; }
                                return;
                            }

                            const savedUser = Object.assign({}, found, {
                                business_id: found['business id'] || found.business_id || null,
                                phone_number: found.phone_number || normalized,
                                phone: phoneInput,
                                admin_first_name: (found.admin_name || firstName || '').split(' ')[0] || ''
                            });
                            savedUser.firstName = savedUser.admin_first_name || (savedUser.admin_name ? String(savedUser.admin_name).split(' ')[0] : '') || '';

                            localStorage.setItem('vvUser', JSON.stringify(savedUser));
                            // Let the normal module-coded auto-login run on reload
                            window.location.reload();

                        } catch (err) {
                            console.error('Fallback login error', err);
                            if (errEl) { errEl.textContent = 'Network error while signing in'; errEl.style.display = 'block'; }
                        }
                    });
                })();
            </script>

            <!-- Sign Up Modal -->
            <div id="signup-modal" class="fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-60 hidden">
                <div class="bg-[#1a1d23] p-6 md:p-8 rounded-2xl border border-[#2b2f3a] max-w-2xl w-full text-center" style="max-height:90vh; overflow-y:auto;">
                    <img src="assets/logo.png" alt="VV Studios" class="mx-auto w-20 h-20 mb-4">
                    <h2 class="text-2xl font-bold mb-2">Create an Account</h2>
                    <p class="text-white/60 mb-6">Fill in your details to get started.</p>
                    <form id="signup-form" class="space-y-4 text-left">
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="signup-firstname" placeholder="First Name" class="flex-1 min-w-0 bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                            <input type="text" id="signup-lastname" placeholder="Last Name" class="flex-1 min-w-0 bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                        </div>
                        <div>
                            <input type="tel" id="signup-phone" placeholder="Phone Number (e.g. 07xxxxxxxx)" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                        </div>
                        <div>
                            <input type="text" id="signup-business" placeholder="Business Name" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-sm text-white/70 mb-1 block">Industry</label>
                            <select id="signup-industry" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-3 text-white">
                                <option value="retail">Retail</option>
                                <option value="services">Services</option>
                                <option value="food_beverage">Food &amp; Beverage</option>
                                <option value="technology">Technology</option>
                                <option value="education">Education</option>
                                <option value="finance">Finance</option>
                                <option value="health">Health</option>
                                <option value="other">Other</option>
                            </select>
                            <input type="text" id="signup-industry-other" placeholder="Input your industry" class="mt-2 w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none hidden">
                        </div>
                        <div>
                            <label class="text-sm text-white/70 mb-1 block">Role in Business</label>
                            <select id="signup-role" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-3 text-white">
                                <option value="business_owner">Business Owner</option>
                                <option value="employee">Employee</option>
                                <option value="sales_rep">Sales Rep</option>
                                <option value="sales_manager">Sales Manager</option>
                                <option value="marketer">Marketer</option>
                                <option value="social_media_manager">Social Media Manager</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div id="signup-employees-row" class="hidden">
                            <label class="text-sm text-white/70 mb-1 block">Number of Employees</label>
                            <input type="number" id="signup-employees" placeholder="e.g. 10" min="1" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-4 text-white placeholder-white/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-sm text-white/70 mb-1 block">Package of Interest</label>
                            <select id="signup-package" class="w-full bg-[#1a1d23] border border-[#2b2f3a] rounded-xl py-3 px-3 text-white">
                                <option value="growth">Growth</option>
                                <option value="pro">Pro</option>
                                <option value="premium">Premium</option>
                                <option value="not_yet">Not yet decided</option>
                            </select>
                        </div>
                        <div id="signup-error" class="text-red-400 text-sm hidden"></div>
                        <p class="text-xs text-white/60 mt-2">By Signing Up you agree to our <button id="signup-terms-btn" class="text-blue-400 underline">Terms</button>.</p>
                        <div class="flex items-center justify-between gap-3">
                            <button type="button" id="signup-cancel" class="w-1/2 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg">Cancel</button>
                            <button type="submit" id="signup-submit" class="w-1/2 bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg">Sign Up</button>
                        </div>
                    </form>
                </div>

                <!-- Inline Terms Modal (opens only from signup) -->
                <div id="signup-terms-overlay" class="fixed inset-0 z-70 flex items-center justify-center hidden" aria-hidden="true">
                    <div id="signup-terms-backdrop" class="absolute inset-0 bg-black bg-opacity-50"></div>
                    <div id="signup-terms" class="relative bg-[#0f1115] rounded-2xl border border-[#2b2f3a] p-6 w-1/2 max-w-[680px] text-left text-white overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="signup-terms-title" style="max-height:80vh;">
                        <h3 id="signup-terms-title" class="text-lg font-bold mb-3">Terms of Service</h3>
                        <div id="signup-terms-content" class="prose prose-invert text-sm text-white/80">Terms of Service will Appear Here.</div>
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function(){
                        var termsBtn = document.getElementById('signup-terms-btn');
                        var overlay = document.getElementById('signup-terms-overlay');
                        var backdrop = document.getElementById('signup-terms-backdrop');
                        var contentEl = document.getElementById('signup-terms-content');
                        if (!termsBtn || !overlay || !contentEl) return;

                        function loadMarked(){
                            return new Promise(function(resolve){
                                if (window.marked) return resolve(window.marked);
                                var s = document.createElement('script');
                                s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
                                s.async = true;
                                s.onload = function(){ resolve(window.marked); };
                                s.onerror = function(){ resolve(null); };
                                document.head.appendChild(s);
                            });
                        }

                        function openTerms(e){
                            if (e && e.preventDefault) e.preventDefault();
                            overlay.classList.remove('hidden');
                            try { document.body.style.overflow = 'hidden'; } catch(e){}

                            // Fetch and render markdown file (terms.md). If markdown library isn't available, show plain text.
                            Promise.all([loadMarked(), fetch('terms.md')])
                                .then(function(results){
                                    var markedLib = results[0];
                                    var resp = results[1];
                                    if (resp && resp.ok) return resp.text().then(function(txt){ return { txt: txt, marked: markedLib }; });
                                    return { txt: 'Terms of Service will Appear Here.', marked: markedLib };
                                })
                                .then(function(obj){
                                    if (obj.marked) {
                                        try { contentEl.innerHTML = obj.marked.parse(obj.txt || ''); return; } catch(e){}
                                    }
                                    // Fallback: plain text (escape HTML)
                                    contentEl.textContent = obj.txt || 'Terms of Service will Appear Here.';
                                })
                                .catch(function(){
                                    contentEl.textContent = 'Terms of Service will Appear Here.';
                                });
                        }

                        function closeTerms(){
                            overlay.classList.add('hidden');
                            try { document.body.style.overflow = ''; } catch(e){}
                        }

                        termsBtn.addEventListener('click', openTerms);

                        // Close on click-away (clicking the overlay/backdrop)
                        overlay.addEventListener('click', function(ev){
                            if (ev.target === overlay || ev.target === backdrop) {
                                closeTerms();
                            }
                        });

                        // Optional: close on Escape key
                        document.addEventListener('keydown', function(ev){ if (ev.key === 'Escape' && !overlay.classList.contains('hidden')) closeTerms(); });
                    });
                </script>

            </div>
        </div>
    </div>

    <div id="dashboard-container" style="display: none;">
        <div class="flex min-h-screen">
            <!-- Mobile Menu Backdrop -->
            <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 lg:hidden hidden"></div>

            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-[#14161a] p-6 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 z-50 lg:relative lg:translate-x-0">
                <div class="flex flex-col items-center space-y-2 mb-8 relative">
                    <img src="assets/logo.png" alt="VV Studios Logo" class="w-16 h-16">
                    <span class="text-xl font-bold">VV Studios</span>
                    <span class="text-sm text-white/60">Client Portal</span>
                    <button id="sidebar-close-button" class="absolute top-2 right-2 lg:hidden text-white focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <nav>
    <ul class="space-y-2">
        <!-- My Business (highlighted) -->
        <li class="mb-4">
            <a href="index.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors active">
                <i class="fa-solid fa-briefcase w-5 h-5"></i>
                <span>My Business</span>
                <span class="tooltip">View your business overview and key insights</span>
            </a>
        </li>

        <!-- Ads -->
        <li class="mb-4">
            <a href="ads_management_dashboard.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-bullhorn w-5 h-5"></i>
                <span>Ads</span>
                <span class="tooltip">Optimize your ad campaigns for maximum ROI!</span>
            </a>
        </li>

        <!-- Sales & Follow-Ups (CRM) -->
        <li class="mb-4">
            <a href="crmlanding.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-handshake w-5 h-5"></i>
                <span>Sales & Follow-Ups</span>
                <span class="tooltip">Track and manage your customers easily</span>
            </a>
        </li>

        <!-- Ecommerce (Growth+) -->
        <li class="mb-4" id="sidebar-ecommerce-item">
            <a href="ecommerce.html" data-always-allow="true"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-store w-5 h-5"></i>
                <span>Ecommerce</span>
                <span class="tooltip">Sell products, bundles and offers</span>
            </a>
        </li>

        <!-- Business Assistant (Copilot) -->
        <li class="mb-4">
            <a href="copilot.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-robot w-5 h-5"></i>
                <span>Business Assistant</span>
                <span class="tooltip">Your AI Copilot that helps you run the business</span>
            </a>
        </li>

        <!-- AI Sales Assistant (locked) -->
        <li class="mb-4">
            <a href="#"
                class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-robot w-5 h-5"></i>
                <span>AI Sales Assistant</span>
                <span class="tooltip">Unlock our smartest AI to blow up your sales!</span>
                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
            </a>
        </li>

        <!-- Automations (locked) -->
        <li class="mb-4">
            <a href="#"
                class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-arrows-spin w-5 h-5"></i>
                <span>Automations</span>
                <span class="tooltip">Automate your business and save 10+ hours a week!</span>
                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
            </a>
        </li>

        <!-- Marketing Systems (locked) -->
        <li class="mb-4">
            <a href="#"
                class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-gear w-5 h-5"></i>
                <span>Marketing Systems</span>
                <span class="tooltip">Sales and marketing on autopilot!</span>
                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
            </a>
        </li>

        <!-- Content Creation (always available) -->
        <li class="mb-4">
            <a href="contentcreation.html"
                class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-pen-nib w-5 h-5"></i>
                <span>Content Creation</span>
            </a>
        </li>

        <!-- Live Chat (locked) -->
        <li class="mb-4">
            <a href="#"
                class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                <i class="fa-solid fa-comments w-5 h-5"></i>
                <span>Live Chat</span>
                <span class="tooltip">Engage with customers in real-time!</span>
                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
            </a>
        </li>
    </ul>
</nav>
            </aside>
            <script>
            // Ensure Ecommerce sidebar item always navigates to `ecommerce.html` (index page)
            (function(){
                try {
                    const item = document.getElementById('sidebar-ecommerce-item');
                    if (!item) return;
                    const anchor = item.querySelector('a');
                    if (!anchor) return;
                    const existingLock = anchor.querySelector('.fa-lock'); if (existingLock) existingLock.remove();
                    anchor.classList.remove('text-white/30');
                    anchor.classList.add('text-white');
                    anchor.setAttribute('href','ecommerce.html');
                } catch(e) { console.error(e); }
            })();
            </script>
            <main class="flex-1 overflow-y-auto p-8 lg:p-12">
                <div id="top-header" class="flex justify-between items-center mb-10 flex-wrap">
                    <div class="flex items-center w-full md:w-auto">
                        <!-- Mobile Menu Button -->
                        <button id="mobile-menu-button" class="lg:hidden mr-4 text-white focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                            </svg>
                        </button>
                        <div class="flex-1 min-w-[200px]">
                            <h1 id="businessName" class="text-3xl lg:text-4xl font-bold mb-1">Business Name</h1>
                            <p class="text-white/60 text-sm">Good to see you <span id="welcomeName" class="font-bold"></span>.</p>
                        </div>
                    </div>
                    <div id="header-controls" class="absolute right-4 top-4 z-50 flex items-center space-x-4 md:relative md:right-0 md:top-0 md:mt-0 mt-4 lg:mt-0">
                        <!-- Search removed: not used on dashboard -->
                        <button class="w-10 h-10 rounded-xl bg-[#1a1d23] flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white/70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 01-3.46 0"></path></svg>
                        </button>
                        
                        <div id="profile-menu-button" class="flex items-center space-x-2 p-2 bg-[#1a1d23] rounded-xl cursor-pointer">
                            <div id="profile-avatar" class="rounded-full w-8 h-8 bg-blue-500 flex items-center justify-center text-white font-bold text-sm">L</div>
                            <p id="profileName" class="font-medium text-sm hidden sm:block"><span id="welcomeName" class="font-bold"></p>
                        </div>
                        
                        <div id="profile-dropdown" class="absolute top-14 right-0 z-50 w-48 bg-[#1a1d23] rounded-xl border border-[#2b2f3a] p-2 shadow-lg hidden transition-opacity duration-200">
                            <a href="#" class="block p-2 text-sm text-white/80 hover:bg-[#2b2f3a] rounded-lg transition-colors">Change Password</a>
                            <div class="block p-2 rounded-lg">
                                <div class="theme-toggle-wrapper">
                                    <span class="text-sm text-white/80">Theme</span>
                                    <div class="theme-toggle-buttons">
                                        <button type="button" class="theme-toggle-btn px-2 py-1 bg-[#1a1d23] text-white" data-theme="dark">Dark</button>
                                        <button type="button" class="theme-toggle-btn px-2 py-1 bg-white text-[#0f1115]" data-theme="light">Light</button>
                                    </div>
                                </div>
                            </div>
                            <a href="#" id="logoutButton" class="block p-2 text-sm text-red-400 hover:bg-[#2b2f3a] rounded-lg transition-colors">Logout</a>
                        </div>
                    </div>
                </div>

                 <!-- Countdown and Upsell Section -->
            <section class="mb-10 p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate">
                <div class="flex items-center justify-between flex-wrap">
                    <div class="w-full md:w-auto flex-1 mb-4 md:mb-0">
                        <h2 id="packageTitle" class="text-white font-semibold text-lg mb-2"><span id="packageName" class="font-semibold text-white">Package</span> Plan Countdown</h2>
                        <div class="progress-bar-container">
                            <div id="countdown-bar" class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%;"></div>
                        </div>
                        <p id="countdown-text" class="text-sm text-white/60 mt-2">â³ 30 days remaining in your package.</p>
                    </div>
                    <div class="w-full md:w-auto">
                        <!-- NOTE: the original STK/inline payment flow was commented out (moved to dashboard.js replacement).
                             Using the Ads-section till-number style payment flow instead. -->
                        <button id="upgrade-button" class="upgrade-button upgrade-floating">
                            Upgrade
                        </button>
                    </div>
                </div>
            </section>
            <style>
                /* Minor compacting tweaks for KPI cards to improve mobile density */
                .kpi-card h3 { line-height: 1; }
                .kpi-card p { margin: 0; }
                @media (max-width: 640px) {
                    .kpi-card { padding-top: .6rem; padding-bottom: .6rem; }
                    .kpi-card .text-2xl { font-size: 1.25rem; }
                }
            </style>
        <script>
        // Metric tooltip click handlers: toggle tooltip visibility and close on outside click
        document.addEventListener('click', function (e) {
            // if clicking a metric-info button
            const infoBtn = e.target.closest && e.target.closest('.metric-info');
            if (infoBtn) {
                const parent = infoBtn.parentElement || infoBtn.closest('.relative');
                if (!parent) return;
                // toggle show class
                parent.classList.toggle('show-tooltip');
                // hide other tooltips
                Array.from(document.querySelectorAll('.relative.show-tooltip')).forEach(el => {
                    if (el !== parent) el.classList.remove('show-tooltip');
                });
                e.stopPropagation();
                return;
            }
            // click outside -> close all
            Array.from(document.querySelectorAll('.relative.show-tooltip')).forEach(el=>el.classList.remove('show-tooltip'));
        });
        // Close on ESC
        document.addEventListener('keydown', function(e){ if (e.key === 'Escape') { Array.from(document.querySelectorAll('.relative.show-tooltip')).forEach(el=>el.classList.remove('show-tooltip')); } });

        // small CSS tweak to show metric tooltip when parent has .show-tooltip
        const style = document.createElement('style');
        style.innerHTML = '.relative .tooltip{ left: auto; right: 0; top: calc(100% + 8px); transform: translateY(0); visibility: hidden; opacity: 0; } .relative.show-tooltip .tooltip{ visibility: visible; opacity:1;} @media (max-width:1024px){ .relative .tooltip{ display:block; position:relative; left:0; right:0; top:8px; transform:none; white-space:normal; } }';
        document.head.appendChild(style);
        </script>

            <!-- Key Performance Indicators -->
<section class="mb-10">
    <div class="mb-6">
        <h2 class="text-xl font-semibold text-white mb-2">Key Performance Indicators</h2>
        <p class="text-white/80 text-sm italic">Monthly Success Indicators - compares with last month</p>
    </div>
    <!-- Mobile-specific compact KPI grid (shows only on xs screens) -->
    <div class="grid grid-cols-2 gap-3 sm:hidden mb-2" id="kpi-mobile-grid">
        <div class="bg-[#1a1d23] rounded-xl border border-[#2b2f3a] p-4 kpi-mobile-card">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-purple-500/20">
                    <svg class="w-5 h-5 text-purple-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-white/60 font-medium">Sales</div>
                        <div class="relative">
                            <button class="metric-info text-white/60 p-1" aria-label="Sales info" type="button"><i class="fa-solid fa-circle-info"></i></button>
                            <span class="tooltip metric-tooltip">Total sales for the current month.</span>
                        </div>
                    </div>
                    <div class="text-3xl font-bold kpi-mobile-value" data-src="#salesMonthly">Ksh 0</div>
                </div>
            </div>
        </div>

        <div class="bg-[#1a1d23] rounded-xl border border-[#2b2f3a] p-4 kpi-mobile-card">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-orange-500/20">
                    <svg class="w-5 h-5 text-orange-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="18" r="3"></circle></svg>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-white/60 font-medium">Conversion Rate</div>
                        <div class="relative">
                            <button class="metric-info text-white/60 p-1" aria-label="Conversion Rate info" type="button"><i class="fa-solid fa-circle-info"></i></button>
                            <span class="tooltip metric-tooltip">Percent of contacts that became customers this month.</span>
                        </div>
                    </div>
                    <div class="text-3xl font-bold kpi-mobile-value" data-src="#conversionRate">0%</div>
                </div>
            </div>
        </div>

        <div class="bg-[#1a1d23] rounded-xl border border-[#2b2f3a] p-4 kpi-mobile-card">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-blue-500/20">
                    <svg class="w-5 h-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 5v.01M12 9v.01M12 13v.01M12 17v.01M5 12h.01M9 12h.01M13 12h.01M17 12h.01"></path></svg>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-white/60 font-medium">Life Time Value</div>
                        <div class="relative">
                            <button class="metric-info text-white/60 p-1" aria-label="Life Time Value info" type="button"><i class="fa-solid fa-circle-info"></i></button>
                            <span class="tooltip metric-tooltip">Average total money a customer spends for your business over time.</span>
                        </div>
                    </div>
                    <div class="text-3xl font-bold kpi-mobile-value" data-src="#lifeTimeValue">Ksh 0</div>
                </div>
            </div>
        </div>

        <div class="bg-[#1a1d23] rounded-xl border border-[#2b2f3a] p-4 kpi-mobile-card">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-green-500/20">
                    <svg class="w-5 h-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 17H7l-3 4-3-4M21 17l-3 4-3-4H2V7h20v10z"></path></svg>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-white/60 font-medium">Cost/Customer</div>
                        <div class="relative">
                            <button class="metric-info text-white/60 p-1" aria-label="Cost per customer info" type="button"><i class="fa-solid fa-circle-info"></i></button>
                            <span class="tooltip metric-tooltip">Average amount you spend on ads to get one new customer.</span>
                        </div>
                    </div>
                    <div class="text-3xl font-bold kpi-mobile-value" data-src="#costOfAcquisition">Ksh 0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop KPI grid (hidden on xs screens) -->
    <div class="hidden sm:grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <!-- Card 1: Sales for Current Month (KES) -->
        <div class="p-4 sm:p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate kpi-card">
            <div class="flex items-center space-x-3 mb-2">
                <div class="p-1 sm:p-2 rounded-lg bg-purple-500/20 flex items-center justify-center">
                    <!-- Icon for Currency/Sales (Dollar Sign) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg>
                </div>
                <!-- Title will be updated by JS to include the current month -->
                <h3 id="salesTitle" class="font-medium text-white/80 text-sm">Sales (Monthly)</h3>
            </div>
            <p id="salesMonthly" class="text-2xl sm:text-3xl font-bold mb-1">Ksh 0</p>
            <p id="salesMonthlyChange" data-change class="text-xs flex items-center">
                <svg id="salesMonthlyIcon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5l7 7-7 7M12 5l-7 7 7 7"></path></svg>
                +0%
            </p>
        </div>

        <!-- Card 2: Conversion Rate (%) -->
        <div class="p-4 sm:p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate kpi-card">
            <div class="flex items-center space-x-3 mb-2">
                <div class="p-1 sm:p-2 rounded-lg bg-orange-500/20 flex items-center justify-center">
                    <!-- Icon for Percentage/Conversion Rate -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="18" r="3"></circle></svg>
                </div>
                <div class="relative">
                    <h3 class="font-medium text-white/80 text-sm inline">Conversion Rate</h3>
                    <button class="metric-info ml-2 text-white/60" aria-label="Conversion Rate info" type="button">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <span class="tooltip metric-tooltip">Percent of contacts that became customers this month.</span>
                </div>
            </div>
            <p id="conversionRate" class="text-2xl sm:text-3xl font-bold mb-1">0%</p>
            <p id="conversionRateChange" class="text-xs flex items-center">
                <svg id="conversionRateIcon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5l7 7-7 7M12 5l-7 7 7 7"></path></svg>
                +0%
            </p>
        </div>

        <!-- Card 3: Life Time Value (LTV) (KES) -->
        <div class="p-4 sm:p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate kpi-card">
            <div class="flex items-center space-x-3 mb-2">
                <div class="p-1 sm:p-2 rounded-lg bg-blue-500/20 flex items-center justify-center">
                    <!-- Icon for Life Time Value (Target/Star) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 5v.01M12 9v.01M12 13v.01M12 17v.01M5 12h.01M9 12h.01M13 12h.01M17 12h.01"></path></svg>
                </div>
                <div class="relative">
                    <h3 class="font-medium text-white/80 text-sm inline">Life Time Value (LTV)</h3>
                    <button class="metric-info ml-2 text-white/60" aria-label="LTV info" type="button">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <span class="tooltip metric-tooltip">Average total money a customer spends for your business over time.</span>
                </div>
            </div>
            <p id="lifeTimeValue" class="text-2xl sm:text-3xl font-bold mb-1">Ksh 0</p>
            <p id="lifeTimeValueChange" class="text-xs flex items-center">
                <svg id="lifeTimeValueIcon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5l7 7-7 7M12 5l-7 7 7 7"></path></svg>
                +0%
            </p>
        </div>

        <!-- Card 4: Cost of Customer Acquisition (CAC) (KES) -->
        <div class="p-4 sm:p-6 bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] card-animate kpi-card">
            <div class="flex items-center space-x-3 mb-2">
                <div class="p-1 sm:p-2 rounded-lg bg-green-500/20 flex items-center justify-center">
                    <!-- Icon for Cost of Customer Acquisition (Price Tag) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 17H7l-3 4-3-4M21 17l-3 4-3-4H2V7h20v10z"></path></svg>
                </div>
                <div class="relative">
                    <h3 class="font-medium text-white/80 text-sm inline">Customer Acquisition Cost (CAC)</h3>
                    <button class="metric-info ml-2 text-white/60" aria-label="CAC info" type="button">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <span class="tooltip metric-tooltip">Average amount you spend on ads to get one new customer. Lower is better.</span>
                </div>
            </div>
            <p id="costOfAcquisition" class="text-2xl sm:text-3xl font-bold mb-1">Ksh 0</p>
            <p id="costOfAcquisitionChange" class="text-xs flex items-center">
                <svg id="costOfAcquisitionIcon" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5l7 7-7 7M12 5l-7 7 7 7"></path></svg>
                +0%
            </p>
        </div>
    </div>

    <style>
        /* Mobile KPI card tweaks */
        .kpi-mobile-card { box-sizing: border-box; }
        .kpi-mobile-card .kpi-mobile-value { color: #fff; }
        /* Make mobile cards closer to ads performance card sizing */
        .kpi-mobile-card { padding: .85rem; }
        .kpi-mobile-card .kpi-mobile-value { font-size: 1.75rem; line-height: 1; }
        @media (max-width:640px){
            .kpi-mobile-card { padding: .9rem; }
            .kpi-mobile-card .kpi-mobile-value { font-size: 1.75rem; }
        }
    </style>

    <script>
        // Sync canonical KPI values into mobile-only cards.
        (function(){
            function syncOnce(){
                document.querySelectorAll('.kpi-mobile-value').forEach(function(target){
                    var src = target.getAttribute('data-src');
                    if(!src) return;
                    try{ var s = document.querySelector(src); if(s) target.textContent = s.textContent; }
                    catch(e){}
                });
            }
            // Sync immediately and for a short period (in case other scripts populate later)
            document.addEventListener('DOMContentLoaded', function(){
                syncOnce();
                var runs = 0;
                var id = setInterval(function(){ syncOnce(); runs++; if(runs>10) clearInterval(id); }, 250);
            });
        })();
    </script>
</section>
            <!-- Package-specific Vision Board + About & Learning (copied from free.html, namespaced) -->
            <section id="pkg-vision-section" class="mb-10">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-white">Your Vision Board</h2>
                    <p class="text-sm text-white/60">Your roadmap to success.</p>
                </div>

                <!-- Empty State (namespaced) -->
                <div id="pkgVision-board-empty" class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-8 text-center">
                    <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-chart-line text-blue-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">No Estimates Yet</h3>
                    <p class="text-white/50 text-sm max-w-md mx-auto mb-6">
                        Create a vision board to picture your business goals. See how many leads you need, your possible total sales, and your path to growing.
                    </p>
                    <a href="simulator.html" class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-xl transition-colors shadow-lg shadow-blue-900/30">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        Get Vision Board
                    </a>
                </div>

                <!-- Populated State (Hidden) -->
                <div id="pkgVision-board-data" class="hidden bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 card-animate">
                    <div class="mb-4 text-center">
                        <div class="text-xs text-white/60 uppercase tracking-widest mb-2">Possible Monthly Sales</div>
                        <div class="text-2xl font-bold text-green-400 mb-2" id="pkgVisionResSales">KES 0</div>
                        <div class="flex flex-wrap justify-center gap-4 text-sm mt-2">
                            <span class="px-3 py-1 bg-white/5 rounded-full text-white/80 border border-white/10">Net Profit: <strong id="pkgVisionResProfit" class="text-white">KES 0</strong></span>
                            <span class="px-3 py-1 bg-white/5 rounded-full text-white/80 border border-white/10">Avg Cost of Getting One Customer: <strong id="pkgVisionResCac" class="text-green-400">KES 0</strong></span>
                            <span class="px-3 py-1 bg-white/5 rounded-full text-white/80 border border-white/10">Ad Spend: <strong id="pkgVisionResSpend">KES 0</strong></span>
                        </div>
                    </div>

                    <!-- KPI Cards (minimal, no chart) -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-[#0f1115] p-4 rounded-xl border border-[#2b2f3a] text-center">
                            <div class="text-white/40 text-xs uppercase mb-1">Leads</div>
                            <div class="text-2xl font-bold text-white" id="pkgVisionLeads">0</div>
                            <div class="text-[10px] text-white/30">Potential Inquiries</div>
                        </div>
                        <div class="bg-[#0f1115] p-4 rounded-xl border border-[#2b2f3a] text-center">
                            <div class="text-white/40 text-xs uppercase mb-1">Conv. Rate</div>
                            <div class="text-2xl font-bold text-blue-400" id="pkgVisionConv">0%</div>
                            <div class="text-[10px] text-white/30">Based on Plan</div>
                        </div>
                        <div class="bg-[#0f1115] p-4 rounded-xl border border-[#2b2f3a] text-center">
                            <div class="text-white/40 text-xs uppercase mb-1">Customers</div>
                            <div class="text-2xl font-bold text-green-400" id="pkgVisionCustomers">0</div>
                            <div class="text-[10px] text-white/30">New Sales/Mo</div>
                        </div>
                        <div class="bg-[#0f1115] p-4 rounded-xl border border-[#2b2f3a] text-center">
                            <div class="text-white/40 text-xs uppercase mb-1">Spend</div>
                            <div class="text-2xl font-bold text-white" id="pkgVisionSpend">0</div>
                            <div class="text-[10px] text-white/30">Ad Budget + Fees</div>
                        </div>
                    </div>

                    <!-- Assumptions & Key Variables (minimal) -->
                    <div class="text-center border-t border-white/10 pt-6 mt-6">
                        <h4 class="text-white font-semibold mb-3">Assumptions & Key Variables</h4>
                        <div class="flex flex-wrap justify-center gap-4 text-sm">
                            <div class="px-4 py-2 bg-[#1a1d23] rounded-lg border border-[#2b2f3a] text-white/70">
                                <div class="text-[11px] text-white/50">Conversion Rate</div>
                                <div id="pkgVisionAssConv" class="font-bold text-white">0%</div>
                            </div>
                            <div class="px-4 py-2 bg-[#1a1d23] rounded-lg border border-[#2b2f3a] text-white/70">
                                <div class="text-[11px] text-white/50">Avg Cost/Customer</div>
                                <div id="pkgVisionAssCac" class="font-bold text-green-400">KES 0</div>
                            </div>
                            <div class="px-4 py-2 bg-[#1a1d23] rounded-lg border border-[#2b2f3a] text-white/70">
                                <div class="text-[11px] text-white/50">Ad Spend (mo.)</div>
                                <div id="pkgVisionAssSpend" class="font-bold text-white">KES 0</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <a href="simulator.html" class="text-sm text-white/50 hover:text-white flex items-center gap-2 transition-colors">
                            <i class="fa-solid fa-sliders"></i> Adjust numbers
                        </a>
                    </div>
                </div>
            </section>

            <!-- Business Profile / Audit / Offer Creator cards (package pages) -->
            <div id="pkg-business-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 card-animate flex flex-col h-full justify-between">
                    <div>
                        <div class="w-12 h-12 bg-[#10B981]/10 rounded-lg flex items-center justify-center mb-4">
                            <i class="fa-solid fa-id-card text-green-400 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-1">Business Profile</h3>
                        <p class="text-white/60 text-sm leading-relaxed">Keep your business details up to date so tools like offers and audits can use them.</p>
                    </div>
                    <button id="pkg-bp-edit-btn" class="w-full py-3 mt-4 bg-[#2b2f3a] border border-white/10 hover:bg-white/5 text-white font-bold rounded-xl transition-colors">
                        Edit
                    </button>
                </div>

                <div class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 card-animate flex flex-col h-full justify-between">
                    <div>
                        <div class="w-12 h-12 bg-[#F59E0B]/10 rounded-lg flex items-center justify-center mb-4">
                            <i class="fa-solid fa-list-check text-yellow-400 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-1">Business Audit</h3>
                        <p id="pkg-audit-sub" class="text-white/60 text-sm leading-relaxed">Run a quick health-check to see where your business can improve.</p>
                    </div>
                    <button id="pkg-audit-btn" class="w-full py-3 mt-4 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded-xl transition-colors" onclick="window.location.href='audit.html'">
                        Start
                    </button>
                </div>

                <div class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 card-animate flex flex-col h-full justify-between">
                    <div>
                        <div class="w-12 h-12 bg-[#7c3aed]/10 rounded-lg flex items-center justify-center mb-4">
                            <i class="fa-solid fa-tag text-purple-400 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-1">Offer Creator</h3>
                        <p id="pkg-offer-sub" class="text-white/60 text-sm leading-relaxed">Create your first offer</p>
                    </div>
                    <button id="pkg-create-offer-btn" class="w-full py-3 mt-4 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl transition-colors" onclick="window.location.href='crmlanding.html'">
                        Create
                    </button>
                </div>
            </div>

            <!-- About Services + Learning cards (copied from free.html, namespaced) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">
                <div class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 md:p-8 card-animate flex flex-col h-full justify-between">
                    <div>
                        <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center mb-4">
                            <i class="fa-solid fa-layer-group text-purple-400 text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-3">Learn More about our services</h3>
                        <p class="text-white/60 text-sm leading-relaxed mb-6">
                            Discover how our tools and strategies work together to help you build a scalable business ecosystem.
                        </p>
                    </div>
                    <button onclick="window.location.href='blog.html?category=Services'" class="w-full py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl transition-colors shadow-lg shadow-purple-900/30">
                        About Services
                    </button>
                </div>

                <div class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 md:p-8 card-animate flex flex-col h-full justify-between">
                    <div>
                        <div class="w-12 h-12 bg-orange-500/20 rounded-lg flex items-center justify-center mb-4">
                            <i class="fa-solid fa-graduation-cap text-orange-400 text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-3">Learn Digital Marketing with VVStudios</h3>
                        <p class="text-white/60 text-sm leading-relaxed mb-6">
                            For Free. Master the fundamentals of digital growth and customer acquisition.
                        </p>
                    </div>
                    <button onclick="window.location.href='blog.html?category=Learning'" class="w-full py-3 bg-[#1a1d23] border border-white/20 hover:bg-white/5 text-white font-bold rounded-xl transition-colors">
                        Start Learning
                    </button>
                </div>
            </div>

            <!-- Contact Customer Success Agent button (centered, below Learning materials) -->
            <div class="mb-6 flex justify-center">
                <button id="contact-account-manager-btn" class="py-2 px-3 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded-full shadow-sm">Contact Customer Success Agent</button>
            </div>

            <script>
                // Namespaced Vision Board population (package dependent)
                (function(){
                    function slugify(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
                    function fmtKES(n){ return 'KES ' + Number(n||0).toLocaleString(); }
                    function setText(id,val){ var el=document.getElementById(id); if(el) el.innerText=val; }

                    document.addEventListener('DOMContentLoaded', function(){
                        var pkgNameEl = document.getElementById('packageName');
                        var pkg = pkgNameEl ? slugify(pkgNameEl.textContent) : 'package';
                        var key1 = 'vision_board_saved_' + pkg;
                        var key2 = 'sim_projections';
                        var simData = null;
                        try { simData = localStorage.getItem(key1) || localStorage.getItem(key2) || null; }
                        catch(e){ simData = null; }

                        if(!simData) return; // keep empty state
                        try{
                            var data = JSON.parse(simData);
                            document.getElementById('pkgVision-board-empty').classList.add('hidden');
                            document.getElementById('pkgVision-board-data').classList.remove('hidden');

                            setText('pkgVisionResSales', fmtKES(data.revenue));
                            setText('pkgVisionResProfit', fmtKES(Math.round(data.netProfit||0)));
                            setText('pkgVisionResCac', fmtKES(data.cac||0));
                            setText('pkgVisionResSpend', fmtKES(data.totalCost || (data.budget||0)));

                            setText('pkgVisionLeads', (data.leads||0).toLocaleString());
                            setText('pkgVisionConv', ((data.rate||0)*100).toFixed(0) + '%');
                            setText('pkgVisionCustomers', (data.customers||0));
                            setText('pkgVisionSpend', fmtKES(data.totalCost || (data.budget||0)));

                            setText('pkgVisionAssConv', ((data.rate||0)*100).toFixed(0) + '%');
                            setText('pkgVisionAssCac', fmtKES(data.cac||0));
                            setText('pkgVisionAssSpend', fmtKES(data.budget||0));
                        } catch(e){ console.warn('Could not populate pkg vision board', e); }
                    });
                })();
            </script>
            </main>
        </div>
    </div>

    </div> <!-- /#app -->
    
    <!-- Contact Account Manager Modal -->
    <div id="contact-account-manager-modal" class="modal-backdrop hidden modal-bottom fixed inset-0 z-50 bg-black/60 p-4">
        <div class="modal-bottom-content bg-[#14161a] rounded-2xl border border-[#2b2f3a] max-w-md w-full p-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-white">Tell us your issue</h3>
                <button class="text-white/50 hover:text-white" data-modal-close="contact-account-manager-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <textarea id="contact-account-manager-text" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" rows="4" placeholder="Describe your issue..."></textarea>
            <div class="mt-3">
                <button id="contact-account-manager-submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-xl font-bold">Submit</button>
            </div>
        </div>
    </div>

    <script>
        // Contact Account Manager modal handlers (index)
        (function(){
            const openBtn = document.getElementById('contact-account-manager-btn');
            const modal = document.getElementById('contact-account-manager-modal');
            const submitBtn = document.getElementById('contact-account-manager-submit');

            function openModal(){
                if (!modal) return;
                const content = modal.querySelector('.modal-bottom-content');
                // Make modal visible so we can measure, but keep it hidden from pointer/flicker
                modal.classList.remove('hidden');
                modal.style.pointerEvents = 'none';
                modal.style.visibility = 'hidden';

                if (window.innerWidth >= 640 && openBtn) {
                    // Desktop: position popover above the button
                    // Temporarily reveal to measure
                    modal.style.visibility = 'hidden';
                    modal.style.pointerEvents = 'none';
                    // ensure content has no transform for measurement
                    content.style.transform = 'none';
                    // Allow layout to settle then measure
                    requestAnimationFrame(() => {
                        // Position popover centered above the button
                        const rect = openBtn.getBoundingClientRect();
                        // measure content; fallback to reasonable defaults
                        const cw = Math.min((content.offsetWidth || 360), window.innerWidth - 24);
                        const ch = content.offsetHeight || content.scrollHeight || 180;
                        let left = rect.left + (rect.width / 2) - (cw / 2);
                        left = Math.max(12, Math.min(left, window.innerWidth - cw - 12));
                        // prefer above the button; if not enough space place below
                        let top = rect.top - ch - 10;
                        if (top < 12) top = rect.bottom + 12;

                        content.style.position = 'absolute';
                        content.style.left = left + 'px';
                        content.style.top = top + 'px';
                        content.style.right = 'auto';
                        content.style.maxWidth = cw + 'px';
                        content.style.transform = 'none';

                        modal.style.visibility = '';
                        modal.style.pointerEvents = '';
                    });
                } else {
                    // Mobile: show bottom sheet with slide-in
                    modal.style.visibility = '';
                    modal.style.pointerEvents = '';
                    setTimeout(()=> modal.classList.add('open'), 20);
                }

                try{ document.body.style.overflow = 'hidden'; } catch(e){}
            }
            function closeModal(){
                if (!modal) return;
                const content = modal.querySelector('.modal-bottom-content');
                // always clear inline positioning styles
                try {
                    content.style.position = '';
                    content.style.left = '';
                    content.style.top = '';
                    content.style.maxWidth = '';
                    content.style.transform = '';
                } catch(e){}
                modal.classList.remove('open');
                setTimeout(()=> modal.classList.add('hidden'), 260);
                try{ document.body.style.overflow = ''; } catch(e){}
            }

            openBtn && openBtn.addEventListener('click', function(e){ e.preventDefault(); openModal(); });

            // close when clicking close buttons (data-modal-close)
            document.addEventListener('click', function(evt){
                const t = evt.target;
                if (t && t.getAttribute && t.getAttribute('data-modal-close') === 'contact-account-manager-modal') closeModal();
            });

            // Explicitly attach close handler to the modal's X button to ensure it closes reliably
            try {
                const modalX = modal && modal.querySelector('[data-modal-close="contact-account-manager-modal"]');
                if (modalX) modalX.addEventListener('click', function(e){ e.preventDefault(); closeModal(); });
            } catch(e){}

            // backdrop click closes
            modal && modal.addEventListener('click', function(ev){ if (ev.target === modal) closeModal(); });

            submitBtn && submitBtn.addEventListener('click', function(){
                const text = (document.getElementById('contact-account-manager-text')||{}).value || '';
                if (!text.trim()) { alert('Please enter your issue'); return; }
                // Placeholder: implement real submit (API/whatsapp/email) as needed
                console.log('Contact CSA submit:', text);
                alert('Thanks â€” your message has been submitted to your Customer Success Agent.');
                closeModal();
                try{ document.getElementById('contact-account-manager-text').value = ''; } catch(e){}
            });
        })();
    </script>

    <!-- Index Business Profile Modal (duplicate of CRM modal but namespaced for index) -->
    <div id="indexbusinessprofile-modal" class="modal-backdrop hidden">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-bg-card rounded-2xl border border-border-dark max-w-4xl w-full p-6 card-animate max-h-[calc(100vh-4rem)] overflow-hidden flex flex-col" style="box-sizing: border-box;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold">Business Profile</h2>
                    <button class="text-white/50 hover:text-white" data-modal-close="indexbusinessprofile-modal"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <style>
                    #indexbusinessprofile-modal .overflow-y-auto{ scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.14) transparent; }
                    #indexbusinessprofile-modal .overflow-y-auto::-webkit-scrollbar{ width:8px; }
                    #indexbusinessprofile-modal .overflow-y-auto::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.12); border-radius:8px; }
                    #indexbusinessprofile-modal .overflow-y-auto::-webkit-scrollbar-track{ background: transparent; }
                </style>

                <div class="flex-1 overflow-y-auto py-1 pr-4" style="max-height: calc(100vh - 8rem); box-sizing: border-box;">
                    <form id="indexbusinessprofile-form" class="space-y-4 text-lg">
                        <div>
                            <label class="block text-base font-medium text-white">Business name</label>
                            <p class="text-sm text-white/60 mb-2">Whatâ€™s the name of your business?</p>
                            <input id="bp-business-name" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-base font-medium text-white">Industry</label>
                                <p class="text-sm text-white/60 mb-2">What type of business do you run? (e.g., salon, electronics, real estate)</p>
                                <input id="bp-industry" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                            </div>
                            <div>
                                <label class="block text-base font-medium text-white">Location</label>
                                <p class="text-sm text-white/60 mb-2">Where are you based?</p>
                                <input id="bp-location" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                            </div>
                        </div>

                        <div>
                            <label class="block text-base font-medium text-white">Tagline</label>
                            <p class="text-sm text-white/60 mb-2">Whatâ€™s your slogan or short tagline?</p>
                            <input id="bp-tagline" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                        </div>

                        <div>
                            <label class="block text-base font-medium text-white">Short description</label>
                            <p class="text-sm text-white/60 mb-2">Describe your business in one short sentence.</p>
                            <input id="bp-short-desc" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                        </div>

                        <div>
                            <label class="block text-base font-medium text-white">Long description</label>
                            <p class="text-sm text-white/60 mb-2">Describe the problem you're solving and how your product or service is positioned as the solution.</p>
                            <textarea id="bp-long-desc" rows="5" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg"></textarea>
                        </div>

                        <div>
                            <label class="block text-base font-medium text-white">Target audience</label>
                            <p class="text-sm text-white/60 mb-2">Who are your typical customers?</p>
                            <input id="bp-target-audience" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                        </div>

                        <div>
                            <label class="block text-base font-medium text-white">Unique value</label>
                            <p class="text-sm text-white/60 mb-2">What makes your business different or special?</p>
                            <input id="bp-unique-value" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-base font-medium text-white">Main offer</label>
                                <p class="text-sm text-white/60 mb-2">Whatâ€™s your main product or service?</p>
                                <input id="bp-main-offer" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                            </div>
                            <div>
                                <label class="block text-base font-medium text-white">Secondary offers</label>
                                <p class="text-sm text-white/60 mb-2">What other related products or services do you offer?</p>
                                <input id="bp-secondary-offers" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-base font-medium text-white">Tone of voice</label>
                                <p class="text-sm text-white/60 mb-2">How should your messages sound? (e.g., friendly, expert)</p>
                                <select id="bp-tone-of-voice" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg">
                                    <option value="friendly">Friendly</option>
                                    <option value="expert">Expert</option>
                                    <option value="casual">Casual</option>
                                    <option value="playful">Playful</option>
                                    <option value="formal">Formal</option>
                                    <option value="energetic">Energetic</option>
                                    <option value="conversational">Conversational</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-base font-medium text-white">Website & socials</label>
                            <p class="text-sm text-white/60 mb-2">Share your website or social media links.</p>
                            <input id="bp-website" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg mb-3" />

                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm text-white/70">Facebook</label>
                                    <input id="bp-facebook" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                                </div>
                                <div>
                                    <label class="block text-sm text-white/70">Instagram</label>
                                    <input id="bp-instagram" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                                </div>
                                <div>
                                    <label class="block text-sm text-white/70">X (formerly Twitter)</label>
                                    <input id="bp-twitter" class="w-full bg-bg-dark border border-border-dark rounded-xl p-3 text-white text-lg" />
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" id="bp-save-btn" class="w-full bg-main-purple hover:bg-purple-700 text-white font-semibold py-3 rounded-xl mb-3">Save Business Profile</button>
                            <button type="button" id="bp-cancel-btn" class="w-full text-white/60 hover:text-white py-3">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Index Unsaved changes confirm modal for Business Profile -->
    <div id="indexbusinessprofile-confirm-modal" class="modal-backdrop hidden">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-bg-card rounded-2xl border border-border-dark max-w-md w-full p-6 card-animate">
                <h3 class="text-xl font-bold mb-3">You Have Made Some Changes</h3>
                <p class="text-white/60 mb-4">Discard your changes or save them?</p>
                <div class="flex gap-3">
                    <button id="index-bp-discard-btn" class="flex-1 bg-bg-dark text-white/80 py-3 rounded-lg">Discard</button>
                    <button id="index-bp-confirm-save-btn" class="flex-1 bg-main-purple text-white py-3 rounded-lg">Save</button>
                </div>
            </div>
        </div>
    </div>
    <script>
document.addEventListener("DOMContentLoaded", () => {
    const menuBtn = document.getElementById("mobile-menu-button");
    const sidebar = document.getElementById("sidebar");
    const backdrop = document.getElementById("mobile-menu-backdrop");
    const closeBtn = document.getElementById("sidebar-close-button");

    if (!menuBtn || !sidebar) return;

    menuBtn.addEventListener("click", () => {
        if (window.vv_toggleSidebarGuarded) window.vv_toggleSidebarGuarded();
    });

    if (closeBtn) {
        closeBtn.addEventListener("click", () => {
            if (window.vv_closeSidebarImmediate) {
                window.vv_closeSidebarImmediate();
            } else {
                sidebar.classList.add("-translate-x-full");
                sidebar.classList.remove("open");
                backdrop.classList.add("hidden");
                const sbBackdrop = document.getElementById('sidebar-backdrop');
                if (sbBackdrop) sbBackdrop.classList.remove('show');
            }
        });
    }

    backdrop.addEventListener("click", () => {
        // Close immediately (use close helper if available)
        if (window.vv_closeSidebarImmediate) {
            window.vv_closeSidebarImmediate();
            return;
        }
        sidebar.classList.add("-translate-x-full");
        sidebar.classList.remove("open");
        backdrop.classList.add("hidden");
        const sbBackdrop = document.getElementById('sidebar-backdrop');
        if (sbBackdrop) sbBackdrop.classList.remove('show');
    });

    // Guarded toggle (prevent double-toggle from multiple scripts)
    window.vv_toggleSidebarGuarded = function(){
        if (window.__vv_sidebar_busy) return;
        window.__vv_sidebar_busy = true;
        try {
            sidebar.classList.toggle("-translate-x-full");
            sidebar.classList.toggle("open");
            backdrop.classList.toggle("hidden");
            const sbBackdrop = document.getElementById('sidebar-backdrop');
            if (sbBackdrop) sbBackdrop.classList.toggle('show');
        } finally {
            setTimeout(()=>{ window.__vv_sidebar_busy = false; }, 350);
        }
    };

    window.vv_closeSidebarImmediate = function(){
        sidebar.classList.add("-translate-x-full");
        sidebar.classList.remove("open");
        backdrop.classList.add("hidden");
        const sbBackdrop = document.getElementById('sidebar-backdrop');
        if (sbBackdrop) sbBackdrop.classList.remove('show');
    };
});
</script>
    <!-- Axios (no SRI here to avoid CORS issues when CDN doesn't provide cross-origin headers) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <!-- Supabase (UMD build for better mobile compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="theme-toggle.js" defer></script>
    <script src="router.js"></script>
    <script src="auth.js"></script>
    <script type="module" src="dashboard.js"></script>
    <script>
    // Sign-up modal behavior: open/close, field toggles and submit validation
    (function(){
        const openBtn = document.getElementById('open-signup-btn');
        const modal = document.getElementById('signup-modal');
        const cancelBtn = document.getElementById('signup-cancel');
        const form = document.getElementById('signup-form');
        const industry = document.getElementById('signup-industry');
        const industryOther = document.getElementById('signup-industry-other');
        const role = document.getElementById('signup-role');
        const employeesRow = document.getElementById('signup-employees-row');
        const errorBox = document.getElementById('signup-error');

        function openModal(){
            modal.classList.remove('hidden');
            // prevent body scroll while modal is open
            try { document.body.style.overflow = 'hidden'; } catch (e) {}
            // focus first field
            setTimeout(()=>document.getElementById('signup-firstname')?.focus(),100);
        }
        function closeModal(){
            modal.classList.add('hidden');
            try { document.body.style.overflow = ''; } catch (e) {}
            errorBox.classList.add('hidden');
            form.reset();
            industryOther.classList.add('hidden');
            employeesRow.classList.add('hidden');
        }

        if (openBtn) openBtn.addEventListener('click', openModal);
        if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

        // close when clicking overlay (but not when clicking inner dialog)
        if (modal) modal.addEventListener('click', (ev)=>{
            if (ev.target === modal) closeModal();
        });

        function updateConditionalFields(){
            if (!industry || !role) return;
            if (industry.value === 'other') {
                industryOther.classList.remove('hidden');
            } else {
                industryOther.classList.add('hidden');
            }

            // show number-of-employees only if either industry or role is 'other'
            if (industry.value === 'other' || role.value === 'other') {
                employeesRow.classList.remove('hidden');
            } else {
                employeesRow.classList.add('hidden');
            }
        }

        if (industry) industry.addEventListener('change', updateConditionalFields);
        if (role) role.addEventListener('change', updateConditionalFields);

        function showError(msg){
            errorBox.textContent = msg;
            errorBox.classList.remove('hidden');
        }

        function validatePhone(phone){
            if (!phone) return false;
            const digits = phone.replace(/\D/g,'');
            if (phone.startsWith('07')) {
                return /^07\d{8}$/.test(digits) && digits.length===10;
            }
            // fallback: allow 9-15 digits for other formats
            return /^\d{9,15}$/.test(digits);
        }

        if (form) form.addEventListener('submit', async function(e){
            e.preventDefault();
            errorBox.classList.add('hidden');
            const first = document.getElementById('signup-firstname')?.value?.trim();
            const last = document.getElementById('signup-lastname')?.value?.trim();
            const phoneInput = document.getElementById('signup-phone')?.value?.trim();
            const business = document.getElementById('signup-business')?.value?.trim();
            const pkg = document.getElementById('signup-package')?.value || 'Free';
            const ind = (industry.value === 'other') ? (industryOther.value || 'other') : industry.value;
            const rl = role.value;
            const employees = document.getElementById('signup-employees')?.value || null;

            if (!first) return showError('First name is required');
            if (!phoneInput) return showError('Phone number is required');
            if (!validatePhone(phoneInput)) return showError('Please enter a valid phone number (e.g. 07xxxxxxxx)');
            if (!business) return showError('Business name is required');

            // Local phone normalization to 2547xxxxxxx
            function normalizePhone(p) {
                if (!p) return '';
                let s = String(p).trim();
                s = s.replace(/\s+/g, '');
                if (s.startsWith('+')) s = s.substring(1);
                const digits = s.replace(/\D/g, '');
                if (s.startsWith('0')) {
                    // 07xxxxxxxx -> 2547xxxxxxxx
                    return '254' + digits.substring(1);
                }
                if (digits.length === 9 && digits.startsWith('7')) {
                    return '254' + digits;
                }
                if (digits.startsWith('254')) return digits;
                return digits;
            }

            const normalizedPhone = normalizePhone(phoneInput);

            // Supabase REST endpoint details (same project as dashboard.js)
            const SUPABASE_URL = 'https://xgtnbxdxbbywvzrttixf.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ';

            // Generate a business id: sanitized business name + two random digits; ensure uniqueness
            function sanitizeBusinessName(name) {
                return name.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '') || 'business';
            }

            async function isBusinessIdTaken(bid) {
                const q = encodeURIComponent('business id') + '=eq.' + encodeURIComponent(bid);
                const res = await fetch(`${SUPABASE_URL}/rest/v1/logins?${q}&select=id`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (!res.ok) return false;
                const data = await res.json();
                return Array.isArray(data) && data.length > 0;
            }

            const baseId = sanitizeBusinessName(business);
            let businessId = '';
            for (let i=0;i<6;i++) {
                const rand = Math.floor(Math.random()*90) + 10; // 10-99
                const candidate = `${baseId}${rand}`;
                try {
                    const taken = await isBusinessIdTaken(candidate);
                    if (!taken) { businessId = candidate; break; }
                } catch (err) {
                    // network issue; accept candidate
                    businessId = candidate; break;
                }
            }
            if (!businessId) businessId = baseId + Math.floor(Math.random()*9000+1000);

            // Compute package expiry for Free (use authUtils if available)
            let expiry = null;
            try {
                if (window.authUtils && typeof window.authUtils.computePackageExpiryDate === 'function') {
                    expiry = window.authUtils.computePackageExpiryDate(new Date().toISOString(), 'Free');
                }
            } catch (e) {}
            if (!expiry) {
                const d = new Date(); d.setUTCDate(d.getUTCDate() + 3); expiry = d.toISOString();
            }

            const payload = {
                phone_number: normalizedPhone,
                admin_name: first,
                full_name: `${first} ${last}`.trim(),
                business_name: business,
                'business id': businessId,
                package: 'Free',
                joined_date: new Date().toISOString(),
                package_expiry_date: expiry,
                industry: ind,
                role: rl,
                employees: employees
            };

            try {
                errorBox.classList.remove('hidden');
                errorBox.style.color = '#ffd6a5';
                errorBox.textContent = 'Creating account...';

                const res = await fetch(`${SUPABASE_URL}/rest/v1/logins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(payload)
                });

                const body = await res.json();
                if (!res.ok) {
                    console.error('Supabase insert error', body);
                    return showError((body && body.message) ? body.message : 'Failed to create account');
                }

                const created = Array.isArray(body) ? body[0] : body;
                // Build saved user for localStorage (compat with dashboard.js expectations)
                const savedUser = Object.assign({}, created, {
                    business_id: created['business id'] || businessId,
                    phone_number: created.phone_number || normalizedPhone,
                    phone: phoneInput,
                    admin_first_name: first,
                    firstName: first
                });

                localStorage.setItem('vvUser', JSON.stringify(savedUser));
                // success feedback then reload to trigger auto-login
                errorBox.style.color = '#9ae6b4';
                errorBox.textContent = 'Account created â€” redirecting...';
                setTimeout(()=>{
                    window.location.reload();
                },900);

            } catch (err) {
                console.error('Sign-up error', err);
                showError('Network error while creating account');
            }
        });

        // Profile dropdown toggle and logout wiring
        const profileBtn = document.getElementById('profile-menu-button');
        const profileDropdown = document.getElementById('profile-dropdown');
        const logoutBtn = document.getElementById('logoutButton');

        if (profileBtn && profileDropdown) {
            profileBtn.addEventListener('click', function(ev){
                profileDropdown.classList.toggle('hidden');
                ev.stopPropagation();
            });

            document.addEventListener('click', function(ev){
                if (!profileBtn.contains(ev.target) && !profileDropdown.contains(ev.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e){
                e.preventDefault();
                try {
                    if (window.authUtils && typeof window.authUtils.logout === 'function') {
                        window.authUtils.logout();
                        return;
                    }
                } catch (err) {
                    console.warn('authUtils.logout not available, falling back');
                }
                localStorage.removeItem('vvUser');
                window.location.href = 'index.html';
            });
        }
    })();
    </script>

        <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('ServiceWorker registered'))
                .catch(err => console.error("SW registration failed:", err));
        }
        // Listen for Service Worker update notifications and show a non-intrusive top tip
        if (navigator.serviceWorker) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                try {
                    const data = event.data;
                    if (!data) return;
                    if (data.type === 'SW_UPDATED') {
                        // Show a transient tip at the very top saying 'new updates applied'
                        const bannerId = 'sw-update-tip';
                        if (!document.getElementById(bannerId)) {
                            const banner = document.createElement('div');
                            banner.id = bannerId;
                            banner.textContent = 'new updates applied';
                            banner.style.position = 'fixed';
                            banner.style.top = '0';
                            banner.style.left = '0';
                            banner.style.right = '0';
                            banner.style.zIndex = '9999';
                            banner.style.background = 'linear-gradient(90deg,#10b981,#06b6d4)';
                            banner.style.color = '#fff';
                            banner.style.padding = '10px 12px';
                            banner.style.textAlign = 'center';
                            banner.style.fontWeight = '600';
                            banner.style.fontFamily = 'Inter, sans-serif';
                            banner.style.boxShadow = '0 2px 8px rgba(0,0,0,0.16)';
                            banner.style.pointerEvents = 'none';
                            document.body.appendChild(banner);
                        }

                        // Tell the SW to skip waiting so the new SW can activate immediately
                        if (navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage('SKIP_WAITING');
                        }

                        // Keep the tip for a few seconds then reload to pick up the new assets
                        setTimeout(() => {
                            const el = document.getElementById('sw-update-tip');
                            if (el) el.remove();
                            window.location.reload();
                        }, 3000);
                    }
                } catch (e) { console.warn('SW message handler error', e); }
            });
        }
        </script>
</body>
</html>
