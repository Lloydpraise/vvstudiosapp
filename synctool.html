<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVStudios Command Center</title>
    <style>
        :root { --bg: #09090b; --card: #18181b; --text: #e4e4e7; --accent: #22c55e; --border: #27272a; }
        body { font-family: 'Courier New', monospace; max-width: 800px; margin: 40px auto; padding: 20px; background: var(--bg); color: var(--text); }
        .card { background: var(--card); padding: 2rem; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        h1 { margin-top: 0; color: #fff; font-size: 1.5rem; letter-spacing: -0.05em; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        
        .status-box { margin: 20px 0; padding: 15px; background: #000; border-radius: 6px; font-size: 13px; height: 350px; overflow-y: auto; border: 1px solid var(--border); color: #a1a1aa; }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #1f1f22; padding-bottom: 4px; }
        .success { color: var(--accent); }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .cursor { color: #a855f7; font-size: 11px; }

        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        button { padding: 12px 24px; background: var(--text); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; transition: all 0.2s; }
        button:hover { background: var(--accent); }
        button:disabled { background: #52525b; cursor: not-allowed; opacity: 0.5; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #27272a; padding: 10px; border-radius: 6px; text-align: center; }
        .stat-label { font-size: 11px; text-transform: uppercase; color: #71717a; }
        .stat-val { font-size: 18px; font-weight: bold; color: white; }

        .progress-bar { width: 100%; height: 6px; background: #27272a; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; box-shadow: 0 0 10px var(--accent); }
    </style>
</head>
<body>

<div class="card">
    <h1>VVStudios Sync Manager</h1>
    
    <div class="stat-grid">
        <div class="stat-box">
            <div class="stat-label">Total Synced</div>
            <div class="stat-val" id="totalCount">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Target</div>
            <div class="stat-val">~930</div>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn" onclick="startSync()">INITIATE SYNC SEQUENCE</button>
    </div>

    <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>

    <div class="status-box" id="console">
        <div class="log-entry">> System Ready. Waiting for command...</div>
    </div>
</div>

<script>
    // HARDCODED CONFIG
    const FUNCTION_URL = "https://xgtnbxdxbbywvzrttixf.supabase.co/functions/v1/shopify-sync";
    const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ";
    const BUSINESS_ID = "kisasacraft66";
    const DELAY_MS = 1500; 

    // STATE
    let cursor = null;
    let totalSynced = 0;
    let isRunning = false;

    async function startSync() {
        isRunning = true;
        document.getElementById("startBtn").disabled = true;
        document.getElementById("startBtn").innerText = "SYNC IN PROGRESS...";
        log("ðŸš€ Initializing connection to Supabase...", "info");

        try {
            while (isRunning) {
                const payload = { business_id: BUSINESS_ID, cursor: cursor };
                
                log(`Requesting batch... ${cursor ? '(Cursor Active)' : '(Starting Fresh)'}`, "info");
                if(cursor) log(`Cursor: ${cursor}`, "cursor");

                const response = await fetch(FUNCTION_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${ANON_KEY}` },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Server Error (${response.status}): ${errText}`);
                }

                const data = await response.json();
                const batchCount = data.synced || 0;
                totalSynced += batchCount;
                
                updateUI(totalSynced);
                log(`âœ… Successfully synced ${batchCount} products.`, "success");

                if (data.hasNextPage && data.nextCursor) {
                    cursor = data.nextCursor;
                    await new Promise(r => setTimeout(r, DELAY_MS));
                } else {
                    log("ðŸ MISSION COMPLETE. All pages synced.", "success");
                    document.getElementById("startBtn").innerText = "SYNC COMPLETE";
                    isRunning = false;
                    break;
                }
            }
        } catch (err) {
            log(`âŒ CRITICAL FAILURE: ${err.message}`, "error");
            document.getElementById("startBtn").innerText = "RETRY SYNC";
            document.getElementById("startBtn").disabled = false;
            isRunning = false;
        }
    }

    function log(msg, type) {
        const box = document.getElementById("console");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.innerText = `> ${msg}`;
        box.appendChild(entry);
        box.scrollTop = box.scrollHeight;
    }

    function updateUI(count) {
        document.getElementById("totalCount").innerText = count;
        const percentage = Math.min((count / 930) * 100, 100);
        document.getElementById("progressFill").style.width = `${percentage}%`;
    }
</script>

</body>
</html>