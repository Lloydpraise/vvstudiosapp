<!DOCTYPE html>
<html lang="en">
<head>
    <script src="loading.js"></script>
    <meta charset="UTF-8">
    <meta id="dynamic-viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Welcome | VV Studios</title>
    
    <!-- Supabase Library -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
    <script>
        // Viewport handling
        (function(){
            try {
                var vp = document.getElementById('dynamic-viewport');
                function updateViewport() {
                    var w = window.innerWidth || document.documentElement.clientWidth || 1024;
                    if (w < 768) {
                        vp.setAttribute('content', 'width=device-width, initial-scale=0.8, minimum-scale=0.8, viewport-fit=cover');
                    } else {
                        vp.setAttribute('content', 'width=device-width, initial-scale=0.8, minimum-scale=0.8, viewport-fit=cover');
                    }
                }
                updateViewport();
                window.addEventListener('resize', function(){ try { updateViewport(); } catch(e){} });
            } catch (e) { }
        })();
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f1115; color: white; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.2); }

        /* Animations */
        .card-animate { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-animate:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Sidebar & Navigation */
        .sidebar-link { position: relative; transition: all 0.2s ease; }
        .sidebar-link:hover .tooltip { visibility: visible; opacity: 1; }
        .tooltip {
            position: absolute; left: calc(100% + 15px); top: 50%; transform: translateY(-50%);
            visibility: hidden; opacity: 0; background-color: #2b2f3a; color: white;
            padding: 8px 12px; border-radius: 8px; white-space: nowrap; font-size: 0.875rem;
            z-index: 10; transition: opacity 0.3s ease;
        }
        .tooltip::after {
            content: ''; position: absolute; right: 100%; top: 50%; transform: translateY(-50%);
            border-width: 5px; border-style: solid; border-color: transparent #2b2f3a transparent transparent;
        }
        .sidebar-link.active { color: #FFD700; background-color: rgba(255, 215, 0, 0.1); }
        @media (max-width: 1024px) { .sidebar-link .tooltip { display: none !important; } }

        /* Task List Styles */
        .task-card { background: linear-gradient(145deg, #1a1d23 0%, #15171c 100%); border: 1px solid #2b2f3a; }
        .task-number {
            background: rgba(255, 255, 255, 0.05); width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-size: 0.8rem; color: rgba(255,255,255,0.5); font-weight: 600;
        }

        /* Upgrade Button Pulse */
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
        .btn-upgrade { animation: pulse-blue 2s infinite; }

        /* Text Gradients */
        .text-gradient-welcome {
            background: linear-gradient(to right, #60a5fa, #4ade80);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            color: transparent; background-clip: text;
        }
        
        #top-header { position: relative; }
        #header-controls { position: absolute; right: 1rem; top: 0.75rem; z-index: 50; display: flex; gap: 0.5rem; }
        @media (max-width: 768px) {
            #top-header { padding-right: 6.5rem; }
            #header-controls { top: 0.5rem; right: 0.75rem; }
            #mobile-menu-button { margin-bottom: 0.25rem; }
        }
    </style>
    <!-- Dark theme for the driver.js tour popovers -->
    <style>
        .vv-tour-theme .driver-popover {
            background: #0f1115 !important;
            color: #ffffff !important;
            border: 1px solid #2b2f3a !important;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6) !important;
        }
        .vv-tour-theme .driver-popover .driver-title {
            color: #ffffff !important;
        }
        .vv-tour-theme .driver-popover .driver-description {
            color: #d1d5db !important;
        }
        .vv-tour-theme .driver-footer .driver-button {
            background: #1a1d23 !important; color: #fff !important; border: 1px solid #2b2f3a !important;
        }
        .vv-tour-theme .driver-close {
            color: #fff !important;
        }
    </style>

    <style>
        /* Onboarding completed state */
        .task-completed { border-color: rgba(34,197,94,0.3) !important; box-shadow: 0 6px 18px -8px rgba(16,185,129,0.35); }
        .task-completed .task-number { background: rgba(34,197,94,0.15); color: #22c55e; }
        .badge-completed { background: rgba(34,197,94,0.12); color: #bbf7d0; padding: 6px 10px; border-radius: 999px; font-weight:700; font-size:0.75rem; display:inline-flex; gap:8px; align-items:center; }
    </style>
    <script>(function(){try{var t=null;try{t=localStorage.getItem('vvTheme')}catch(e){} if(!t) t='light'; if(t==='light') document.documentElement.setAttribute('data-theme','light'); else document.documentElement.removeAttribute('data-theme');}catch(e){} })();</script>
    <link rel="stylesheet" href="theme.css">
    <style>
        /* Light-theme modal & onboarding overrides for free.html */
        [data-theme="light"] .modal-backdrop { background-color: rgba(15,23,32,0.04) !important; color: #0f1720 !important; }
        [data-theme="light"] .modal-bottom-content, [data-theme="light"] .modal-card { background: #ffffff !important; background-image: none !important; color: #0f1720 !important; border: 1px solid #e6e9ee !important; box-shadow: 0 10px 30px rgba(15,23,32,0.06) !important; }
        /* Ensure onboarding "Get Started" cards are light (remove dark gradient) */
        [data-theme="light"] .task-card { background: #ffffff !important; background-image: none !important; color: #0f1720 !important; border: 1px solid #e6e9ee !important; box-shadow: none !important; }
        [data-theme="light"] .task-card .task-number { background: rgba(15,23,32,0.04) !important; color: #0f1720 !important; }
        [data-theme="light"] .w-32.h-2.bg-\[\#2b2f3a\] { background-color: #e6e9ee !important; }
        /* Make action buttons and dark utility backgrounds inside task cards light */
        [data-theme="light"] .task-card .bg-\[\#2b2f3a\],
        [data-theme="light"] .task-card .bg-\[\#0f1115\],
        [data-theme="light"] .task-card button,
        [data-theme="light"] .task-card a {
            background-color: #f3f4f6 !important;
            color: #0f1720 !important;
            border-color: #e6e9ee !important;
        }
        [data-theme="light"] .task-card .badge-completed { background-color: rgba(34,197,94,0.12) !important; color: #065f46 !important; }
    </style>
    <script src="theme-toggle.js" defer></script>
</head>
<body class="bg-[#0f1115] text-white">

    <div id="dashboard-container">
        <div class="flex min-h-screen">
            <!-- Mobile Menu Backdrop -->
            <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 lg:hidden hidden"></div>

            <!-- Sidebar (Replicated from index.html with Free State adjustments) -->
            <aside id="sidebar" class="w-64 bg-[#14161a] p-6 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 z-50 lg:relative lg:translate-x-0 border-r border-[#2b2f3a]/30 h-screen overflow-y-auto">
                <div class="flex flex-col items-center space-y-2 mb-8">
                    <img src="assets/logo.png" onerror="this.src='https://via.placeholder.com/64'" alt="VV Studios Logo" class="w-16 h-16">
                    <span class="text-xl font-bold">VV Studios</span>
                    <span class="text-sm text-white/60">Client Portal</span>
                </div>
                <nav>
                    <ul class="space-y-2">
                        <!-- My Business (Active) -->
                        <li class="mb-4">
                            <a href="index.html" class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors active">
                                <i class="fa-solid fa-briefcase w-5 h-5"></i>
                                <span>My Business</span>
                                <span class="tooltip">View your business overview and key insights</span>
                            </a>
                        </li>

                        <!-- Ads (Locked) -->
                        <li class="mb-4">
                            <a href="#" class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors cursor-not-allowed">
                                <i class="fa-solid fa-bullhorn w-5 h-5"></i>
                                <span>Ads</span>
                                <span class="tooltip">Optimize your ad campaigns for maximum ROI!</span>
                                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
                            </a>
                        </li>

                        <!-- Sales & Follow-Ups (Locked) -->
                        <li class="mb-4">
                            <a href="#" class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors cursor-not-allowed">
                                <i class="fa-solid fa-handshake w-5 h-5"></i>
                                <span>Sales & Follow-Ups</span>
                                <span class="tooltip">Track and manage your customers easily</span>
                                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
                            </a>
                        </li>

                        <!-- Ecommerce -->
                        <li class="mb-4">
                            <a href="ecommerce.html" data-always-allow="true" class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                                <i class="fa-solid fa-store w-5 h-5"></i>
                                <span>Ecommerce</span>
                                <span class="tooltip">Sell products, bundles and offers</span>
                            </a>
                        </li>

                        <!-- Business Assistant (Locked) -->
                        <li class="mb-4">
                            <a href="#" class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors cursor-not-allowed">
                                <i class="fa-solid fa-robot w-5 h-5"></i>
                                <span>Business Assistant</span>
                                <span class="tooltip">Your AI Copilot that helps you run the business</span>
                                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
                            </a>
                        </li>

                        <!-- AI Sales Assistant (Locked) -->
                        <li class="mb-4">
                            <a href="#" class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                                <i class="fa-solid fa-robot w-5 h-5"></i>
                                <span>AI Sales Assistant</span>
                                <span class="tooltip">Unlock our smartest AI to blow up your sales!</span>
                                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
                            </a>
                        </li>

                        <!-- Automations (Locked) -->
                        <li class="mb-4">
                            <a href="#" class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                                <i class="fa-solid fa-arrows-spin w-5 h-5"></i>
                                <span>Automations</span>
                                <span class="tooltip">Automate your business and save 10+ hours a week!</span>
                                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
                            </a>
                        </li>

                        <!-- Marketing Systems (Locked) -->
                        <li class="mb-4">
                            <a href="#" class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                                <i class="fa-solid fa-gear w-5 h-5"></i>
                                <span>Marketing Systems</span>
                                <span class="tooltip">Sales and marketing on autopilot!</span>
                                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
                            </a>
                        </li>

                        <!-- Content Creation (Unlocked) -->
                        <li class="mb-4">
                            <a href="contentcreation.html" class="flex items-center space-x-3 text-white hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                                <i class="fa-solid fa-pen-nib w-5 h-5"></i>
                                <span>Content Creation</span>
                            </a>
                        </li>

                        <!-- Live Chat (Locked) -->
                        <li class="mb-4">
                            <a href="#" class="flex items-center space-x-3 text-white/30 hover:text-white sidebar-link p-3 rounded-xl transition-colors">
                                <i class="fa-solid fa-comments w-5 h-5"></i>
                                <span>Live Chat</span>
                                <span class="tooltip">Engage with customers in real-time!</span>
                                <i class="fa-solid fa-lock w-3 h-3 text-white/30 ml-auto"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-8 lg:p-12 relative" id="main-scroll">
                
                <!-- Header -->
                <div id="top-header" class="flex justify-between items-center mb-10 flex-wrap">
                    <div class="flex items-center w-full md:w-auto">
                        <button id="mobile-menu-button" class="lg:hidden mr-4 text-white focus:outline-none">
                            <i class="fa-solid fa-bars text-xl"></i>
                        </button>
                        <div class="flex-1 min-w-[200px]">
                            <h1 id="businessName" class="text-3xl lg:text-4xl font-bold mb-1">My Business</h1>
                            <p class="text-white/60 text-sm">Good to see you <span id="welcomeName" class="font-bold">Admin</span>.</p>
                        </div>
                    </div>
                    
                    <!-- Right Side Controls -->
                    <div id="header-controls" class="absolute right-4 top-4 z-50 flex items-center space-x-4 md:relative md:right-0 md:top-0 md:mt-0 mt-4 lg:mt-0">
                        <button class="w-10 h-10 rounded-xl bg-[#1a1d23] flex items-center justify-center">
                            <i class="fa-regular fa-bell text-white/70"></i>
                        </button>
                        
                        <div id="profile-menu-button" class="flex items-center space-x-2 p-2 bg-[#1a1d23] rounded-xl cursor-pointer">
                            <div id="profile-avatar" class="rounded-full w-8 h-8 bg-blue-500 flex items-center justify-center text-white font-bold text-sm">A</div>
                            <p id="profileName" class="font-medium text-sm hidden sm:block">Admin</p>
                        </div>
                        
                        <div id="profile-dropdown" class="absolute top-14 right-0 z-50 w-56 bg-[#1a1d23] rounded-xl border border-[#2b2f3a] p-2 shadow-lg hidden transition-opacity duration-200">
                            <button id="startTourButton" onclick="(function(){ if(window.startTour){ window.startTour(true); } else { var s=document.createElement('script'); s.src='tour.js'; s.onload=function(){ if(window.startTour) window.startTour(true); }; document.body.appendChild(s); } })()" class="block w-full text-left p-2 text-sm text-white hover:bg-[#2b2f3a] rounded-lg transition-colors">Start Tour</button>
                            <div class="block p-2 rounded-lg">
                                <div class="theme-toggle-wrapper">
                                    <span class="text-sm text-white/80">Theme</span>
                                    <div class="theme-toggle-buttons">
                                        <button type="button" class="theme-toggle-btn px-2 py-1 bg-[#1a1d23] text-white" data-theme="dark">Dark</button>
                                        <button type="button" class="theme-toggle-btn px-2 py-1 bg-white text-[#0f1115]" data-theme="light">Light</button>
                                    </div>
                                </div>
                            </div>
                            <a href="#" id="logoutButton" class="block p-2 text-sm text-red-400 hover:bg-[#2b2f3a] rounded-lg transition-colors">Logout</a>
                        </div>
                    </div>
                </div>

                <div class="fade-in">
                    
                    <!-- Welcome Headline -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-4">
                        <div>
                            <h2 class="text-3xl md:text-5xl font-bold mb-2 text-gradient-welcome">Welcome to VV Studios!</h2>
                            <p class="text-white/60 text-lg">This new year Get Ready to show more, sell more and scale faster!</p>
                        </div>
                        
                        <a href="plans.html" class="hidden md:flex bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl items-center gap-2 transition-all transform hover:scale-105 shadow-lg shadow-blue-900/40 btn-upgrade">
                            <span>Upgrade Now</span> <i class="fa-solid fa-arrow-right"></i>
                        </a>
                    </div>

                    <!-- Get Started Section -->
                    <section class="mb-12">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-white flex items-center gap-2"><i class="fa-solid fa-list-check text-orange-400"></i> Get Started</h2>
                            <div class="w-32 h-2 bg-[#2b2f3a] rounded-full overflow-hidden"><div id="onboarding-progress-bar" class="h-full bg-green-500" style="width:0%"></div></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <!-- Tasks -->
                            <div id="task-vision" class="task-card p-4 rounded-xl flex flex-col justify-between h-full group hover:border-white/20 transition-colors">
                                <div class="flex items-start justify-between mb-3">
                                    <span class="task-number">1</span>
                                    <a id="vision-action" href="simulator.html" class="text-xs bg-orange-600 hover:bg-orange-500 text-white py-1 px-3 rounded-md transition-colors shadow-lg shadow-orange-900/20">Start</a>
                                </div>
                                <div><h3 class="font-medium text-white mb-1 text-sm">Get Vision Board</h3><p class="text-xs text-white/40">See your sales projections.</p></div>
                            </div>

                            <div id="task-profile" class="task-card p-4 rounded-xl flex flex-col justify-between h-full group hover:border-white/20 transition-colors">
                                <div class="flex items-start justify-between mb-3">
                                    <span class="task-number">2</span>
                                    <button id="setup-business-profile-btn" class="text-xs bg-[#2b2f3a] hover:bg-[#374151] border border-white/10 text-white py-1 px-3 rounded-md transition-colors">Set Up</button>
                                </div>
                                <div><h3 class="font-medium text-white mb-1 text-sm">Set Up Profile</h3><p class="text-xs text-white/40">Complete your details.</p></div>
                            </div>
                            
                            <!-- Static Tasks -->
                            <div id="task-offer" class="task-card p-4 rounded-xl flex flex-col justify-between h-full hover:border-white/20 transition-colors">
                                <div class="flex items-start justify-between mb-3"><span class="task-number">3</span><button id="create-offer-btn" onclick="window.location.href='ecommerce.html#offers'" class="text-xs bg-[#2b2f3a] border border-white/10 text-white py-1 px-3 rounded-md">Create</button></div>
                                <div><h3 class="font-medium text-white mb-1 text-sm">Create One Offer</h3><p class="text-xs text-white/40">Define what you're selling.</p></div>
                            </div>
                            <div id="task-addproduct" class="task-card p-4 rounded-xl flex flex-col justify-between h-full hover:border-white/20 transition-colors">
                                <div class="flex items-start justify-between mb-3"><span class="task-number">4</span><a id="add-first-product-btn" href="ecommerce.html#products" class="text-xs bg-[#2b2f3a] border border-white/10 text-white py-1 px-3 rounded-md">Add</a></div>
                                <div><h3 class="font-medium text-white mb-1 text-sm">Add Your First Product</h3><p class="text-xs text-white/40">Create a product so customers can start buying from you.</p></div>
                            </div>
                            <!-- Book a Call (step 5) - locked until all onboarding steps complete -->
                            <div id="task-bookcall" class="md:col-span-2 lg:col-span-4 task-card p-3 rounded-xl flex items-center justify-between group hover:border-white/20 transition-colors">
                                <div class="flex items-center gap-3">
                                    <span class="task-number">5</span>
                                    <div>
                                        <h3 class="font-medium text-white mb-0.5 text-sm">Book A Call</h3>
                                        <p class="text-xs text-white/40">Finish Above tasks to schedule an indepth stratefy call.</p>
                                    </div>
                                </div>
                                <div>
                                    <button id="book-call-btn" class="text-xs bg-[#374151] border border-white/10 text-white py-1 px-3 rounded-md opacity-50 cursor-not-allowed" disabled>Book Call</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Vision Board Section (SUPABASE CONNECTED) -->
                    <section class="mb-12">
                        <div class="mb-4 flex justify-between items-end">
                            <div>
                                <h2 class="text-xl font-bold text-white">Your Vision Board</h2>
                                <p class="text-sm text-white/60">Your roadmap to success.</p>
                            </div>
                            <!-- Refresh button removed: vision board loads on page load -->
                        </div>

                        <!-- State: Loading -->
                        <div id="vision-loading" class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-8 text-center hidden">
                            <p class="text-white/50">Loading projections...</p>
                        </div>

                        <!-- State: Empty -->
                        <div id="vision-board-empty" class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-8 text-center hidden">
                            <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-chart-line text-blue-400 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">No Estimates Yet</h3>
                            <p class="text-white/50 text-sm max-w-md mx-auto mb-6">
                                Create a vision board to picture your business goals. See how many leads you need and your path to growing.
                            </p>
                            <a href="simulator.html" class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-xl transition-colors shadow-lg shadow-blue-900/30">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Get Vision Board
                            </a>
                        </div>

                        <!-- State: Data Loaded -->
                        <div id="vision-board-data" class="hidden bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 card-animate">
                            <div class="mb-4 text-center">
                                <div class="text-xs text-white/60 uppercase tracking-widest mb-2">Possible Monthly Sales</div>
                                <div class="text-2xl font-bold text-green-400 mb-2" id="visionResSales">KES 0</div>
                                <div class="flex flex-wrap justify-center gap-4 text-sm mt-2">
                                    <span class="px-3 py-1 bg-white/5 rounded-full text-white/80 border border-white/10">Net Profit: <strong id="visionResProfit" class="text-white">KES 0</strong></span>
                                    <span class="px-3 py-1 bg-white/5 rounded-full text-white/80 border border-white/10">Avg CAC: <strong id="visionResCac" class="text-green-400">KES 0</strong></span>
                                    <span class="px-3 py-1 bg-white/5 rounded-full text-white/80 border border-white/10">Ad Spend: <strong id="visionResSpend">KES 0</strong></span>
                                </div>
                            </div>

                            <!-- KPI Cards -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-[#0f1115] p-4 rounded-xl border border-[#2b2f3a] text-center">
                                    <div class="text-white/40 text-xs uppercase mb-1">Leads</div>
                                    <div class="text-2xl font-bold text-white" id="visionLeads">0</div>
                                </div>
                                <div class="bg-[#0f1115] p-4 rounded-xl border border-[#2b2f3a] text-center">
                                    <div class="text-white/40 text-xs uppercase mb-1">Conv. Rate</div>
                                    <div class="text-2xl font-bold text-blue-400" id="visionConv">0%</div>
                                </div>
                                <div class="bg-[#0f1115] p-4 rounded-xl border border-[#2b2f3a] text-center">
                                    <div class="text-white/40 text-xs uppercase mb-1">Customers</div>
                                    <div class="text-2xl font-bold text-green-400" id="visionCustomers">0</div>
                                </div>
                                <div class="bg-[#0f1115] p-4 rounded-xl border border-[#2b2f3a] text-center">
                                    <div class="text-white/40 text-xs uppercase mb-1">Spend</div>
                                    <div class="text-2xl font-bold text-white" id="visionSpend">0</div>
                                </div>
                            </div>

                            <!-- Assumptions -->
                            <div class="text-center border-t border-white/10 pt-6 mt-6">
                                <h4 class="text-white font-semibold mb-3">Assumptions & Key Variables</h4>
                                <div class="flex flex-wrap justify-center gap-4 text-sm">
                                    <div class="px-4 py-2 bg-[#1a1d23] rounded-lg border border-[#2b2f3a] text-white/70">
                                        <div class="text-[11px] text-white/50">Conversion Rate</div>
                                        <div id="visionAssConv" class="font-bold text-white">0%</div>
                                    </div>
                                    <div class="px-4 py-2 bg-[#1a1d23] rounded-lg border border-[#2b2f3a] text-white/70">
                                        <div class="text-[11px] text-white/50">Avg Cost/Customer</div>
                                        <div id="visionAssCac" class="font-bold text-green-400">KES 0</div>
                                    </div>
                                    <div class="px-4 py-2 bg-[#1a1d23] rounded-lg border border-[#2b2f3a] text-white/70">
                                        <div class="text-[11px] text-white/50">Ad Spend (mo.)</div>
                                        <div id="visionAssSpend" class="font-bold text-white">KES 0</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 flex justify-end">
                                <a href="simulator.html" class="text-sm text-white/50 hover:text-white flex items-center gap-2 transition-colors"><i class="fa-solid fa-sliders"></i> Adjust numbers</a>
                            </div>
                        </div>
                    </section>

                    <!-- Info Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">

                        <!-- New Tools: Qualifier & Copywriter (moved above Learning) -->
                        <div class="md:col-span-2">
                            <div id="qualifier-copywriter-cards" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-2">
                                <div id="qualifier-card" class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 md:p-8 card-animate flex flex-col h-full justify-between">
                                    <div>
                                        <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center mb-4"><i class="fa-solid fa-filter text-green-400 text-xl"></i></div>
                                        <h3 class="text-xl font-bold text-white mb-3">Lead Qualifier</h3>
                                        <p class="text-white/60 text-sm leading-relaxed mb-6">Quickly identify high-intent leads so you can focus on buyers who convert.</p>
                                    </div>
                                    <button onclick="window.location.href='qualifier.html'" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl transition-colors">Open Qualifier</button>
                                </div>

                                <div id="copywriter-card" class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 md:p-8 card-animate flex flex-col h-full justify-between">
                                    <div>
                                        <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mb-4"><i class="fa-solid fa-pen-nib text-blue-400 text-xl"></i></div>
                                        <h3 class="text-xl font-bold text-white mb-3">AI Copywriter</h3>
                                        <p class="text-white/60 text-sm leading-relaxed mb-6">Generate compelling ad and product copy in seconds to help you sell more.</p>
                                    </div>
                                    <button onclick="window.location.href='copywritter.html'" class="w-full py-3 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded-xl transition-colors">Open Copywriter</button>
                                </div>
                            </div>
                        </div>

                        <div id="learn-services-card" class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 md:p-8 card-animate flex flex-col h-full justify-between">
                            <div>
                                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center mb-4"><i class="fa-solid fa-layer-group text-purple-400 text-xl"></i></div>
                                <h3 class="text-xl font-bold text-white mb-3">Learn More about our services</h3>
                                <p class="text-white/60 text-sm leading-relaxed mb-6">Discover how our tools help you scale.</p>
                            </div>
                            <button onclick="window.location.href='blog.html?category=Services'" class="w-full py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl transition-colors shadow-lg shadow-purple-900/30">About Services</button>
                        </div>
                        <div id="learn-digital-card" class="bg-[#1a1d23] rounded-2xl border border-[#2b2f3a] p-6 md:p-8 card-animate flex flex-col h-full justify-between">
                            <div>
                                <div class="w-12 h-12 bg-orange-500/20 rounded-lg flex items-center justify-center mb-4"><i class="fa-solid fa-graduation-cap text-orange-400 text-xl"></i></div>
                                <h3 class="text-xl font-bold text-white mb-3">Learn Digital Marketing</h3>
                                <p class="text-white/60 text-sm leading-relaxed mb-6">Master the fundamentals of digital growth.</p>
                            </div>
                            <button onclick="window.location.href='blog.html?category=Learning'" class="w-full py-3 bg-[#1a1d23] border border-white/20 hover:bg-white/5 text-white font-bold rounded-xl transition-colors">Start Learning</button>
                        </div>

                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Contact Customer Success Agent button (centered, below Learning materials) -->
    <div class="p-4 flex justify-center">
        <button id="contact-account-manager-btn" class="py-2 px-3 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded-full shadow-sm">Contact Customer Success Agent</button>
    </div>

    <!-- Free Business Profile Modal -->
    <div id="free-business-profile-modal" class="modal-backdrop hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
        <div class="bg-[#14161a] rounded-2xl border border-[#2b2f3a] max-w-4xl w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Business Profile</h2>
                <button class="text-white/50 hover:text-white" data-modal-close="free-business-profile-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="free-business-profile-form" class="space-y-4">
                <div class="flex flex-col md:flex-row items-center md:space-x-4 space-y-4 md:space-y-0">
                    <div class="w-20 h-20 rounded-full bg-white/10 flex items-center justify-center overflow-hidden border border-white/20 shrink-0 relative">
                         <span class="text-2xl" id="logo-placeholder">ðŸ“·</span>
                         <img id="logo-preview" class="w-full h-full object-cover hidden">
                         <div id="logo-loading" class="absolute inset-0 bg-black/50 hidden flex items-center justify-center">
                            <div class="loader"></div>
                         </div>
                    </div>
                    <div class="w-full">
                        <label class="block text-sm font-medium text-white/70 mb-1">Business Logo</label>
                        <input type="file" id="setting-logo-upload" accept="image/*" class="w-full text-sm text-white/70">
                    </div>
                </div>

                <div>
                    <label for="setting-business-name" class="block text-sm font-medium text-white/70 mb-1">Business Name</label>
                    <input type="text" id="setting-business-name" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" placeholder="Your Business">
                </div>
                <div>
                    <label for="setting-whatsapp-number" class="block text-sm font-medium text-white/70 mb-1">WhatsApp Number (e.g., 2547XXXXXXXX)</label>
                    <input type="text" id="setting-whatsapp-number" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" placeholder="2547...">
                </div>

                <h3 class="text-lg font-semibold pt-2">Brand Colors</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="setting-primary-color" class="block text-sm font-medium text-white/70 mb-1">Primary Color (Accent)</label>
                        <div class="flex space-x-2">
                            <input type="color" id="setting-primary-color" class="w-12 h-10 p-0.5 rounded-lg border-none shrink-0" value="#7c3aed">
                            <input type="text" id="setting-primary-color-hex" class="flex-1 w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" value="#7c3aed">
                        </div>
                    </div>
                    <div>
                        <label for="setting-secondary-color" class="block text-sm font-medium text-white/70 mb-1">Secondary Color (Details)</label>
                        <div class="flex space-x-2">
                            <input type="color" id="setting-secondary-color" class="w-12 h-10 p-0.5 rounded-lg border-none shrink-0" value="#ea580c">
                            <input type="text" id="setting-secondary-color-hex" class="flex-1 w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" value="#ea580c">
                        </div>
                    </div>
                    <div>
                        <label for="setting-bg-color" class="block text-sm font-medium text-white/70 mb-1">Background Color</label>
                        <div class="flex space-x-2">
                            <input type="color" id="setting-bg-color" class="w-12 h-10 p-0.5 rounded-lg border-none shrink-0" value="#0f1115">
                            <input type="text" id="setting-bg-color-hex" class="flex-1 w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" value="#0f1115">
                        </div>
                    </div>
                </div>

                <div class="pt-4"><button type="submit" id="save-free-business-profile" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold">Save Profile</button></div>
            </form>
        </div>
    </div>

    <!-- Contact Account Manager Modal -->
    <div id="contact-account-manager-modal" class="modal-backdrop hidden modal-bottom fixed inset-0 z-50 bg-black/60 p-4">
        <div class="modal-bottom-content bg-[#14161a] rounded-2xl border border-[#2b2f3a] max-w-md w-full p-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-white">Tell us your issue</h3>
                <button class="text-white/50 hover:text-white" data-modal-close="contact-account-manager-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <textarea id="contact-account-manager-text" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" rows="4" placeholder="Describe your issue..."></textarea>
            <div class="mt-3">
                <button id="contact-account-manager-submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-xl font-bold">Submit</button>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script>
        // --- 1. SUPABASE CONFIG ---
        // Read shared config when available (other pages use __APP_CONFIG)
        const APP_CONFIG = (window && window.__APP_CONFIG) ? window.__APP_CONFIG : {};
        const SUPABASE_URL = APP_CONFIG.SUPABASE_URL || "https://xgtnbxdxbbywvzrttixf.supabase.co";
        const SUPABASE_KEY = APP_CONFIG.SUPABASE_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ";

        // Initialize a single global Supabase client instance used across pages.
        if (!window.supabaseClient) {
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                try {
                    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } catch (e) {
                    console.warn('Failed to create window.supabaseClient in free.html', e);
                    window.supabaseClient = null;
                }
            } else {
                console.warn('Supabase library not available to initialize window.supabaseClient');
                window.supabaseClient = null;
            }
        }

        // Ensure we have a usable Supabase client variable in this page context.
        // Use a page-local name to avoid clashing with other scripts that may
        // declare `supabase` in the global scope.
        const supabaseClientLocal = (function(){
            if (window.supabaseClient) return window.supabaseClient;
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                try { return window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e){ console.warn('Failed to create local supabase client', e); }
            }
            return null;
        })();

        // --- 2. GET USER / BUSINESS ID ---
        function getBusinessId() {
            try {
                // Try to get from local storage first
                const userStr = localStorage.getItem('vvUser');
                if (userStr) {
                    const user = JSON.parse(userStr);
                    // Return business_id or fallback to a default if you are testing
                    return user.business_id || user.id || 'fortunebooks12'; 
                }
            } catch(e) { console.error(e); }
            return 'fortunebooks12'; // Default fallback for testing
        }

        // --- 3. FETCH VISION BOARD DATA ---
        async function loadVisionBoard() {
            const emptyState = document.getElementById('vision-board-empty');
            const dataState = document.getElementById('vision-board-data');
            const loadingState = document.getElementById('vision-loading');

            // Reset UI
            emptyState.classList.add('hidden');
            dataState.classList.add('hidden');
            loadingState.classList.remove('hidden');

            const businessId = getBusinessId();

            try {
                if (!supabaseClientLocal) {
                    console.warn('Supabase client not available in loadVisionBoard');
                    loadingState.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }
                const { data, error } = await supabaseClientLocal
                    .from('vision_boards')
                    .select('*')
                    .eq('business_id', businessId)
                    .single(); // We expect only one row per business

                loadingState.classList.add('hidden');

                if (error || !data) {
                    // No data found -> Show Empty State
                    console.log("No vision board found or error:", error);
                    emptyState.classList.remove('hidden');
                } else {
                    // Data found -> Show Data State & Populate
                    dataState.classList.remove('hidden');
                    populateVisionBoard(data);
                }

            } catch (err) {
                console.error("Unexpected error:", err);
                loadingState.classList.add('hidden');
                emptyState.classList.remove('hidden'); // Fallback
            }
        }

        // --- 4. POPULATE UI ---
        function populateVisionBoard(data) {
            const fmtKES = (n) => 'KES ' + Number(n || 0).toLocaleString();
            const fmtPct = (n) => (Number(n || 0) * 100).toFixed(1) + '%';
            const setText = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };

            // Top Section
            setText('visionResSales', fmtKES(data.monthly_revenue));
            setText('visionResProfit', fmtKES(data.net_profit));
            setText('visionResCac', fmtKES(data.cac));
            setText('visionResSpend', fmtKES(data.ad_spend));

            // KPI Cards
            setText('visionLeads', Number(data.leads || 0).toLocaleString());
            setText('visionConv', fmtPct(data.conversion_rate));
            setText('visionCustomers', Number(data.customers || 0).toLocaleString());
            setText('visionSpend', fmtKES(data.ad_spend));

            // Assumptions Section
            setText('visionAssConv', fmtPct(data.conversion_rate));
            setText('visionAssCac', fmtKES(data.cac));
            setText('visionAssSpend', fmtKES(data.ad_spend));
        }

        // --- 4b. LOAD ONBOARDING STATUS ---
        async function loadOnboardingStatus() {
            const businessId = getBusinessId();
            try {
                if (!supabaseClientLocal) {
                    console.warn('Supabase client not available in loadOnboardingStatus');
                    return;
                }
                const { data, error } = await supabaseClientLocal
                    .from('onboarding_view')
                    .select('*')
                    .eq('business_id', businessId)
                    .single();

                if (error || !data) {
                    console.warn('No onboarding_view row or error:', error);
                    return;
                }

                // Map the flags
                const flags = {
                    vision: Boolean(data.vision_board_complete),
                    profile: Boolean(data.profile_50_percent_complete),
                    offer: Boolean(data.offer_complete),
                    audit: Boolean(data.audit_complete)
                };

                // Helper to mark completed
                const markCompleted = (taskSelector, actionSelector) => {
                    const taskEl = document.getElementById(taskSelector);
                    const actionEl = document.getElementById(actionSelector);
                    if (taskEl) taskEl.classList.add('task-completed');
                    if (actionEl) {
                        actionEl.classList.remove('bg-orange-600');
                        actionEl.classList.remove('hover:bg-orange-500');
                        actionEl.classList.remove('bg-[#2b2f3a]');
                        actionEl.classList.add('badge-completed');
                        actionEl.innerHTML = '<i class="fa-solid fa-check"></i> Completed';
                        if (actionEl.tagName === 'A') actionEl.removeAttribute('href');
                        actionEl.disabled = true;
                    }
                };

                if (flags.vision) markCompleted('task-vision', 'vision-action');
                if (flags.profile) markCompleted('task-profile', 'setup-business-profile-btn');
                if (flags.offer) markCompleted('task-offer', 'create-offer-btn');
                if (flags.audit) markCompleted('task-audit', 'run-audit-btn');

                // Book call unlocking: enable Book Call only when onboarding steps (the four) are complete
                const bookBtn = document.getElementById('book-call-btn');
                const localBookKey = `vv_book_call_done_${businessId}`;
                let bookDoneLocal = false;
                try { bookDoneLocal = !!JSON.parse(localStorage.getItem(localBookKey)); } catch(e) { bookDoneLocal = false; }

                if (data.all_onboarding_steps_complete) {
                    // Unlock the book call button (click handler attached later in DOMContentLoaded scope)
                    if (bookBtn) {
                        bookBtn.disabled = false;
                        bookBtn.classList.remove('opacity-50','cursor-not-allowed');
                        bookBtn.classList.remove('bg-[#374151]');
                        bookBtn.classList.add('bg-blue-600','hover:bg-blue-500');
                    }
                }

                // If locally completed, mark completed
                if (bookDoneLocal) {
                    markCompleted('task-bookcall', 'book-call-btn');
                }

                // Update progress bar (now out of 5 steps)
                const completedCount = Object.values(flags).filter(Boolean).length + (bookDoneLocal ? 1 : 0);
                const pct = Math.round((completedCount / 5) * 100);
                const bar = document.getElementById('onboarding-progress-bar');
                if (bar) bar.style.width = pct + '%';

            } catch (err) {
                console.error('Failed to load onboarding status', err);
            }
        }

        // --- 5. INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
            // Load User Info into Header
            const userStr = localStorage.getItem('vvUser');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    document.getElementById('businessName').textContent = user.business_name || "My Business";
                    document.getElementById('welcomeName').textContent = user.firstName || "Admin";
                    document.getElementById('profileName').textContent = user.firstName || "Admin";
                    document.getElementById('profile-avatar').textContent = (user.firstName || "A").charAt(0).toUpperCase();
                } catch(e) {}
            }

            // Load Vision Board Data
            loadVisionBoard();
            // Load onboarding status and update UI
            loadOnboardingStatus();

            // Mobile Menu
            const menuBtn = document.getElementById("mobile-menu-button");
            const sidebar = document.getElementById("sidebar");
            const backdrop = document.getElementById("mobile-menu-backdrop");
            if (menuBtn && sidebar) {
                menuBtn.addEventListener("click", () => {
                    sidebar.classList.toggle("-translate-x-full");
                    if (backdrop) backdrop.classList.toggle("hidden");
                });
            }
            if (backdrop) {
                backdrop.addEventListener("click", () => {
                    sidebar.classList.add("-translate-x-full");
                    backdrop.classList.add("hidden");
                });
            }

            // Profile Dropdown
            const profileBtn = document.getElementById('profile-menu-button');
            const profileDropdown = document.getElementById('profile-dropdown');
            if (profileBtn) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!profileBtn.contains(e.target)) profileDropdown.classList.add('hidden');
                });
            }

            // Attach upgrade prompt to locked sidebar items (consistent with other pages)
            try {
                const lockedLinks = document.querySelectorAll('#sidebar a.cursor-not-allowed');
                lockedLinks.forEach(link => {
                    // Remove default navigation and show upgrade flow
                    link.addEventListener('click', (ev) => {
                        ev.preventDefault();
                        try {
                            if (window.openUpgradeFlow) return window.openUpgradeFlow();
                        } catch (e) { /* fallthrough */ }
                        // Fallback to plans page
                        window.location.href = 'plans.html';
                    });
                });
            } catch (e) { console.warn('Failed to attach upgrade handlers to sidebar', e); }

            // Logout
            document.getElementById('logoutButton')?.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('vvUser');
                window.location.href = 'index.html';
            });

            // Modal Logic
            const modal = document.getElementById('free-business-profile-modal');
            const openBtn = document.getElementById('setup-business-profile-btn');
            const closeBtns = document.querySelectorAll('[data-modal-close]');
            
            if(openBtn && modal) {
                openBtn.addEventListener('click', async (e) => { e.preventDefault(); await loadBusinessProfile(); modal.classList.remove('hidden'); });
                closeBtns.forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));
            }

            // Contact Account Manager modal handlers (free)
            (function(){
                const openBtnCam = document.getElementById('contact-account-manager-btn');
                const camModal = document.getElementById('contact-account-manager-modal');
                const camSubmit = document.getElementById('contact-account-manager-submit');


                function camOpen(){
                    if (!camModal) return;
                    const content = camModal.querySelector('.modal-bottom-content');
                    camModal.classList.remove('hidden');
                    camModal.style.pointerEvents = 'none';
                    camModal.style.visibility = 'hidden';

                    if (window.innerWidth >= 640 && openBtnCam) {
                        // desktop: position popover centered above the button
                        requestAnimationFrame(() => {
                            const rect = openBtnCam.getBoundingClientRect();
                            const cw = Math.min(content.offsetWidth || 360, window.innerWidth - 24);
                            const ch = content.offsetHeight || content.scrollHeight || 180;
                            let left = rect.left + (rect.width / 2) - (cw / 2);
                            left = Math.max(12, Math.min(left, window.innerWidth - cw - 12));
                            let top = rect.top - ch - 10;
                            if (top < 12) top = rect.bottom + 12;

                            content.style.position = 'absolute';
                            content.style.left = left + 'px';
                            content.style.top = top + 'px';
                            content.style.maxWidth = cw + 'px';
                            content.style.transform = 'none';

                            camModal.style.visibility = '';
                            camModal.style.pointerEvents = '';
                        });
                    } else {
                        camModal.style.visibility = '';
                        camModal.style.pointerEvents = '';
                        setTimeout(()=> camModal.classList.add('open'), 20);
                    }
                    try{ document.body.style.overflow='hidden'; }catch(e){}
                }

                function camClose(){
                    if (!camModal) return;
                    const content = camModal.querySelector('.modal-bottom-content');
                    // always clear inline positioning styles
                    try {
                        content.style.position = '';
                        content.style.left = '';
                        content.style.top = '';
                        content.style.maxWidth = '';
                        content.style.transform = '';
                    } catch(e){}
                    camModal.classList.remove('open');
                    setTimeout(()=> camModal.classList.add('hidden'), 260);
                    try{ document.body.style.overflow=''; }catch(e){}
                }

                openBtnCam && openBtnCam.addEventListener('click', function(e){ e.preventDefault(); camOpen(); });

                // close when clicking close buttons for this modal
                document.addEventListener('click', function(evt){ const t = evt.target; if (t && t.getAttribute && t.getAttribute('data-modal-close') === 'contact-account-manager-modal') camClose(); });

                camModal && camModal.addEventListener('click', function(ev){ if (ev.target === camModal) camClose(); });

                // Explicitly attach close handler to the modal's X button so it calls camClose() directly
                try {
                    const camX = camModal && camModal.querySelector('[data-modal-close="contact-account-manager-modal"]');
                    if (camX) camX.addEventListener('click', function(e){ e.preventDefault(); camClose(); });
                } catch(e){}

                camSubmit && camSubmit.addEventListener('click', function(){
                    const text = (document.getElementById('contact-account-manager-text')||{}).value || '';
                    if (!text.trim()) { alert('Please enter your issue'); return; }
                    // TODO: wire to backend/API
                    console.log('Contact CSA submit:', text);
                    alert('Thanks â€” your message has been submitted to your Customer Success Agent.');
                    camClose();
                    try{ document.getElementById('contact-account-manager-text').value = ''; } catch(e){}
                });
            })();
            
            document.getElementById('run-audit-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = 'audit.html';
            });

            // Book Call modal and flow
            const bookModalHtml = `
            <div id="book-call-modal" class="modal-backdrop hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
                <div class="bg-[#14161a] rounded-2xl border border-[#2b2f3a] max-w-2xl w-full p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">Book Onboarding Call</h2>
                        <button class="text-white/50 hover:text-white" data-modal-close="book-call-modal"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <p class="text-white/60 mb-4">Choose a time and leave any notes for our onboarding team. (This demo marks the step complete locally.)</p>
                    <form id="book-call-form" class="space-y-4">
                        <div><label class="block text-white mb-1">Preferred Date & Time</label><input type="datetime-local" id="book-call-datetime" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" required></div>
                        <div><label class="block text-white mb-1">Notes (optional)</label><textarea id="book-call-notes" class="w-full bg-[#0f1115] border border-[#2b2f3a] rounded-xl p-3 text-white" rows="3"></textarea></div>
                        <div class="pt-2"><button type="submit" id="submit-book-call" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold">Request Call</button></div>
                    </form>
                </div>
            </div>`;

            // Inject modal into body
            try { document.body.insertAdjacentHTML('beforeend', bookModalHtml); } catch(e) { console.error(e); }

            function openBookCallModal(e){
                if (e) e.preventDefault();
                const m = document.getElementById('book-call-modal');
                if (m) m.classList.remove('hidden');
            }

            // Attach click handler to book button after openBookCallModal is available
            const bookBtnAfter = document.getElementById('book-call-btn');
            if (bookBtnAfter) {
                bookBtnAfter.removeEventListener('click', bookBtnAfter._listener || (()=>{}));
                const cb = (ev) => { if (!bookBtnAfter.disabled) openBookCallModal(ev); };
                bookBtnAfter.addEventListener('click', cb);
                bookBtnAfter._listener = cb;
            }

            // Close buttons for dynamically-inserted modal
            document.addEventListener('click', (evt) => {
                const target = evt.target;
                if (target && target.getAttribute && target.getAttribute('data-modal-close') === 'book-call-modal') {
                    document.getElementById('book-call-modal')?.classList.add('hidden');
                }
            });

            // --- Business Profile Load/Save + Logo Upload Helpers ---
            async function updateBrandColor(cssVar, hexValue) {
                try { document.documentElement.style.setProperty(cssVar, hexValue); } catch(e){}
                // Sync text inputs if present
                const idBase = cssVar.replace('--', 'setting-');
                const hexInput = document.getElementById(idBase + '-hex');
                const colorInput = document.getElementById(idBase);
                if (hexInput && hexInput.value !== hexValue) hexInput.value = hexValue;
                if (colorInput && colorInput.value !== hexValue) colorInput.value = hexValue;
            }

            async function loadBusinessProfile() {
                const businessId = getBusinessId();
                // Reset any loading state
                try {
                    const { data, error } = await supabase.from('business_settings').select('*').eq('business_id', businessId).single();
                    if (!error && data) {
                        document.getElementById('setting-business-name').value = data.business_name || '';
                        document.getElementById('setting-whatsapp-number').value = data.whatsapp_number || '';
                        const colors = data.brand_colors || {};
                        const primary = colors.primary || '#7c3aed';
                        const secondary = colors.secondary || '#ea580c';
                        const bg = colors.background || '#0f1115';
                        document.getElementById('setting-primary-color').value = primary;
                        document.getElementById('setting-primary-color-hex').value = primary;
                        document.getElementById('setting-secondary-color').value = secondary;
                        document.getElementById('setting-secondary-color-hex').value = secondary;
                        document.getElementById('setting-bg-color').value = bg;
                        document.getElementById('setting-bg-color-hex').value = bg;
                        // Logo
                        if (data.logo_url) {
                            const img = document.getElementById('logo-preview');
                            img.src = data.logo_url;
                            img.classList.remove('hidden');
                            document.getElementById('logo-placeholder').classList.add('hidden');
                        } else {
                            document.getElementById('logo-preview').classList.add('hidden');
                            document.getElementById('logo-placeholder').classList.remove('hidden');
                        }
                        // Apply colors to page preview
                        updateBrandColor('--primary-color', primary);
                        updateBrandColor('--secondary-color', secondary);
                        updateBrandColor('--bg-dark', bg);
                    } else {
                        // No data: ensure defaults
                    }
                } catch (err) {
                    console.error('loadBusinessProfile error', err);
                }
            }

            // Logo upload handler
            document.getElementById('setting-logo-upload')?.addEventListener('change', async (ev) => {
                const file = ev.target.files && ev.target.files[0];
                if (!file) return;
                const businessId = getBusinessId();
                const preview = document.getElementById('logo-preview');
                const placeholder = document.getElementById('logo-placeholder');
                const loader = document.getElementById('logo-loading');
                try {
                    loader.classList.remove('hidden');
                    const fileName = `logos/${businessId}-${Date.now()}-${file.name}`;
                    const { error } = await supabase.storage.from('ecommerce-assets').upload(fileName, file);
                    if (!error) {
                        const { data } = supabase.storage.from('ecommerce-assets').getPublicUrl(fileName);
                        const publicUrl = data?.publicUrl || '';
                        preview.src = publicUrl;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        // Persist immediately to settings so user sees it (non-blocking)
                        await supabase.from('business_settings').upsert({ business_id: businessId, logo_url: publicUrl });
                    } else {
                        console.warn('logo upload failed', error);
                    }
                } catch (e) { console.error(e); }
                try { loader.classList.add('hidden'); } catch(e){}
            });

            // Sync color inputs
            ['setting-primary-color','setting-secondary-color','setting-bg-color'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', (e) => updateBrandColor('--' + id.replace('setting-','').replace('-color',''), e.target.value));
            });

            // Save form handler
            const profileForm = document.getElementById('free-business-profile-form');
            profileForm?.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const businessId = getBusinessId();
                const payload = {
                    business_id: businessId,
                    business_name: document.getElementById('setting-business-name').value,
                    whatsapp_number: document.getElementById('setting-whatsapp-number').value,
                    brand_colors: {
                        primary: document.getElementById('setting-primary-color').value,
                        secondary: document.getElementById('setting-secondary-color').value,
                        background: document.getElementById('setting-bg-color').value
                    }
                };
                try {
                    await supabase.from('business_settings').upsert(payload);
                    // Close modal
                    modal.classList.add('hidden');
                    // Refresh onboarding status
                    try { loadOnboardingStatus(); } catch(e){}
                    alert('Profile saved');
                } catch (err) {
                    console.error('save profile failed', err);
                    alert('Failed to save profile');
                }
            });

            // Handle book call submit -> mark locally completed and update UI/progress
            document.addEventListener('submit', async (ev) => {
                if (ev.target && ev.target.id === 'book-call-form') {
                    ev.preventDefault();
                    const businessId = getBusinessId();
                    const localBookKey = `vv_book_call_done_${businessId}`;
                    // In a real app we'd POST this to the backend. For now mark locally.
                    localStorage.setItem(localBookKey, JSON.stringify(true));
                    // Update UI to completed
                    const markBtn = document.getElementById('book-call-btn');
                    if (markBtn) {
                        markBtn.classList.remove('bg-blue-600','hover:bg-blue-500');
                        markBtn.classList.add('badge-completed');
                        markBtn.innerHTML = '<i class="fa-solid fa-check"></i> Completed';
                        markBtn.disabled = true;
                    }
                    const taskEl = document.getElementById('task-bookcall');
                    if (taskEl) taskEl.classList.add('task-completed');
                    // Recompute progress (include book call)
                    try { loadOnboardingStatus(); } catch(e) { }
                    // Close modal
                    document.getElementById('book-call-modal')?.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>